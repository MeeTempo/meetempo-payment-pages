<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion MeeTempo</title>
    <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               img-src https: data:; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               font-src https://fonts.gstatic.com; 
               connect-src https://api.meetempo.com;">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --mt-dark: #030E4F;
            --mt-accent: #F49F1C;
            --mt-bg: #0a133f;
            --mt-card: #0e184f;
            --mt-text: #ffffff;
            --mt-muted: #c9d1ff;
            --ok: #23c55e;
            --err: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(160deg, var(--mt-dark) 0%, var(--mt-bg) 60%, #11183f 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--mt-text);
        }
        .container {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(6px);
            border-radius: 16px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .logo-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, var(--mt-accent), #ffca63, var(--mt-accent));
            color: #111;
            font-weight: 800;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }
        h1 { font-size: 26px; font-weight: 700; text-align: center; margin-bottom: 12px; }
        .subtitle { text-align: center; color: var(--mt-muted); font-size: 14px; margin-bottom: 32px; }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 4px;
        }
        .tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--mt-muted);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
        }
        .tab:hover { background: rgba(255,255,255,0.08); }
        .tab.active { background: var(--mt-accent); color: #111; }
        .form-container { display: none; }
        .form-container.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--mt-text); }
        input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.16);
            border-radius: 10px;
            color: var(--mt-text);
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s;
        }
        input:focus { outline: none; border-color: var(--mt-accent); background: rgba(255,255,255,0.12); }
        input::placeholder { color: rgba(255,255,255,0.4); }
        .btn {
            width: 100%;
            padding: 16px;
            background: var(--mt-accent);
            color: #111;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
            font-family: 'Montserrat', sans-serif;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(244,159,28,0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .message { padding: 14px; border-radius: 10px; margin-top: 20px; font-size: 14px; text-align: center; display: none; }
        .message.error { background: rgba(239,68,68,0.15); border: 1px solid var(--err); color: var(--err); display: block; }
        .message.success { background: rgba(35,197,94,0.15); border: 1px solid var(--ok); color: var(--ok); display: block; }
        .loading { display: none; text-align: center; margin-top: 20px; color: var(--mt-accent); }
        .loading.show { display: block; }
        .info-box {
            background: rgba(244,159,28,0.1);
            border: 1px solid rgba(244,159,28,0.3);
            border-radius: 10px;
            padding: 16px;
            margin-top: 24px;
            font-size: 13px;
            color: var(--mt-muted);
            line-height: 1.5;
        }
        .info-box strong { color: var(--mt-accent); }
        .helper-text { font-size: 12px; color: var(--mt-muted); margin-top: 8px; text-align: center; }
        
        /* NOUVEAU: Style pour afficher le token */
        .token-display {
            background: rgba(35,197,94,0.15);
            border: 1px solid var(--ok);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .token-display strong {
            font-size: 16px;
            color: var(--ok);
            display: block;
            margin-bottom: 10px;
        }
        .token-display code {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            word-break: break-all;
            display: block;
            color: var(--mt-text);
            cursor: pointer;
        }
        .token-display small {
            font-size: 12px;
            color: var(--mt-muted);
            display: block;
            margin-top: 15px;
        }
        /* --- Fin NOUVEAU --- */

        @media (max-width: 640px) {
            .container { padding: 32px 24px; }
            h1 { font-size: 22px; }
        }

                /* ===========================
           HELPER TEXT (pour avertissements)
           =========================== */
        .helper-text {
            font-size: 12px;
            color: var(--mt-muted);
            margin-top: 5px;
        }

        /* ===========================
           SELECT STYLING
           =========================== */
        select {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 8px;
            color: var(--mt-text);
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:focus {
            outline: none;
            border-color: var(--mt-accent);
            background: rgba(255,255,255,0.08);
        }

        select option {
            background: var(--mt-card);
            color: var(--mt-text);
        }

        /* ===========================
           INFO BOX STYLING
           =========================== */
        .info-box {
            background: rgba(244, 159, 28, 0.1);
            border: 1px solid rgba(244, 159, 28, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 13px;
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--mt-accent);
            display: block;
            margin-bottom: 8px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="logo-badge">MT</div>
        <h1>Bienvenue sur MeeTempo</h1>
        <p class="subtitle">Connectez-vous ou cr√©ez votre compte</p>
        
        <div class="tabs">
            <button class="tab active" data-tab="login">Se connecter</button>
            <button class="tab" data-tab="signup">Cr√©er un compte</button>
            <button class="tab" data-tab="company">Compte Entreprise</button>
        </div>
                
        <!-- Login Form -->
        <div id="loginForm" class="form-container active">
            
            <!-- Conteneur pour le token apr√®s connexion -->
            <div id="tokenSuccessDisplay" style="display: none;">
                <div class="token-display">
                    <strong>‚úÖ Connexion r√©ussie !</strong>
                    
                    <p style="font-size: 13px; color: var(--mt-muted); margin: 15px 0 10px;">
                        Votre token de session (valide 24h) :
                    </p>
                    
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 15px;">
                        <code id="sessionTokenCode" style="flex: 1; font-size: 11px; padding: 10px; cursor: pointer;" title="Cliquez pour copier">...</code>
                        <button id="copyTokenBtn" onclick="copyTokenToClipboard()" style="background: var(--mt-accent); color: #111; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            üìã Copier
                        </button>
                    </div>
                    
                    <div style="background: rgba(244,159,28,0.15); border: 1px solid rgba(244,159,28,0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <p style="font-size: 13px; color: var(--mt-accent); margin: 0; text-align: center;">
                            ‚è±Ô∏è Redirection vers Hub dans <strong id="countdown">10</strong> secondes...
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="goToHubNow()" style="flex: 1; background: var(--ok); color: #111; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            üöÄ Aller au Hub maintenant
                        </button>
                        <button onclick="cancelRedirect()" style="flex: 1; background: rgba(255,255,255,0.1); color: var(--mt-text); border: 1px solid rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            ‚ùå Annuler
                        </button>
                    </div>
                    
                    <p style="font-size: 11px; color: var(--mt-muted); margin-top: 15px; text-align: center; line-height: 1.5;">
                        üí° <strong>Astuce :</strong> Copiez le token puis fermez cette fen√™tre pour revenir √† GPT.<br>
                        ‚ö†Ô∏è MeeTempo GPT n'a pas de m√©moire des conversations.
                    </p>
                </div>
            </div>
            
            <form id="loginSubmit">
                <div class="form-group">
                    <label for="loginCode">Code MeeTempo (6 chiffres)</label>
                    <input type="text" id="loginCode" placeholder="123456 ou AB3X9K" pattern="[A-Z0-9]{6}" maxlength="6" required autocomplete="off" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="votre@email.com" required autocomplete="email">
                </div>
                <button type="submit" class="btn" id="loginBtn">Se connecter</button>
            </form>
            <div class="loading" id="loginLoading">Connexion en cours...</div>
            <div class="message" id="loginMessage"></div>
            <div class="info-box" id="loginInfoBox">
                <strong>‚ú® Session 24h</strong><br>
                Votre session reste active pendant 24 heures.
            </div>
        </div>
        
        <!-- Signup Form (inchang√©) -->
        <div id="signupForm" class="form-container">
            <form id="signupSubmit">
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="votre@email.com" required autocomplete="email">
                     <div class="helper-text">
                         Vous recevrez un email pour confirmer votre compte.
                     </div>
                </div>
                <button type="submit" class="btn" id="signupBtn">Cr√©er mon compte</button>
            </form>
            <div class="loading" id="signupLoading">Cr√©ation du compte...</div>
            <div class="message" id="signupMessage"></div>
            <div class="info-box" id="signupInfo">
            <div id="referralBanner" style="display: none; background: rgba(35,197,94,0.15); border: 1px solid var(--ok); border-radius: 8px; padding: 12px; margin-bottom: 12px; text-align: center;">
                <span style="color: var(--ok); font-weight: 600;">üéÅ Vous avez √©t√© invit√© !</span>
            </div>
            <strong>üÜì Compte gratuit & S√©curis√©</strong><br>
                Cr√©ez votre compte gratuitement. Vous devrez confirmer votre email avant de pouvoir vous connecter.
            </div>
        </div>
                <!-- Company Form (NOUVEAU) -->
        <div id="companyForm" class="form-container">
            <form id="companySubmit">
                <div class="form-group">
                <label for="companyAdminFirstName">Pr√©nom *</label>
                <input type="text" id="companyAdminFirstName" placeholder="Jean" required>
            </div>

            <div class="form-group">
                <label for="companyAdminLastName">Nom *</label>
                <input type="text" id="companyAdminLastName" placeholder="Dupont" required>
            </div>
                
                <div class="form-group">
                    <label for="companyEmail">Email professionnel *</label>
                    <input type="email" id="companyEmail" placeholder="vous@entreprise.com" required>
                    <div class="helper-text">
                        ‚ö†Ô∏è Utilisez votre email professionnel (pas gmail.com, outlook.com, etc.)
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="companyName">Nom de l'entreprise *</label>
                    <input type="text" id="companyName" placeholder="Votre Entreprise-Company" required>
                </div>
                
                <div class="form-group">
                    <label for="jobLevel">Votre fonction *</label>
                    <select id="jobLevel" required>
                        <option value="">-- S√©lectionnez --</option>
                        <option value="dirigeant">Dirigeant / CEO</option>
                        <option value="cadre">Cadre sup√©rieur</option>
                        <option value="manager">Manager / Chef d'√©quipe</option>
                        <option value="rh">RH / DRH</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="teamSize">Taille de l'√©quipe *</label>
                    <select id="teamSize" required>
                        <option value="">-- S√©lectionnez --</option>
                        <option value="1-10">1 √† 10 salari√©s</option>
                        <option value="11-30">11 √† 30 salari√©s</option>
                        <option value="31-100">31 √† 100 salari√©s</option>
                        <option value="100+">Plus de 100 salari√©s</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="companyPhone">T√©l√©phone (optionnel)</label>
                    <input type="tel" id="companyPhone" placeholder="+33 6 12 34 56 78">
                </div>
                
                <button type="submit" class="btn" id="companyBtn">Cr√©er mon entreprise</button>
            </form>
            
            <div class="loading" id="companyLoading">Cr√©ation de l'entreprise...</div>
            <div class="message" id="companyMessage"></div>
            
            <div class="info-box">
                <strong>üíº Tarifs B2B</strong><br>
                ‚Ä¢ 1-10 salari√©s : 15‚Ç¨ HT/salari√©/mois<br>
                ‚Ä¢ 11-30 : 13,99‚Ç¨ HT/salari√©/mois<br>
                ‚Ä¢ 30+ : 12,90‚Ç¨ HT/salari√©/mois<br><br>
                <strong>‚úÖ Inclus :</strong> Gestion √©quipe, facturation centralis√©e, dashboard admin
            </div>
        </div>
    </div>

    <!-- SCRIPT MIS √Ä JOUR -->
    <script>
        const API_BASE = 'https://api.meetempo.com';
        // const GPT_URL = '...'; // Plus besoin de rediriger

        // üî• NOUVEAU : Capturer code parrainage + email depuis URL
        const urlParams = new URLSearchParams(window.location.search);
        const referralCode = urlParams.get('ref') || null;
        const referralEmail = urlParams.get('email') || null;
        const eventCode = urlParams.get('event_code') || localStorage.getItem('pending_event_code') || null;
        const prefillEmail = urlParams.get('email') || null;
        const tabParam = urlParams.get('tab') || null;

        // Afficher badge si parrainage
        // Afficher badge si parrainage
        if (referralCode) {
            console.log('üéÅ Code parrainage d√©tect√©:', referralCode);
            
            // Afficher le banner
            const banner = document.getElementById('referralBanner');
            if (banner) banner.style.display = 'block';
            
            // Pr√©-remplir l'email si pr√©sent
            if (referralEmail) {
                const signupEmailField = document.getElementById('signupEmail');
                if (signupEmailField) {
                    signupEmailField.value = referralEmail;
                    signupEmailField.readOnly = true; // Emp√™cher modification
                    signupEmailField.style.opacity = '0.7';
                }
            }
            
            // Basculer automatiquement sur l'onglet "Cr√©er un compte"
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="signup"]').classList.add('active');
            document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
            document.getElementById('signupForm').classList.add('active');
        }

        // Pr√©-remplir email si fourni (depuis event-join)
        if (prefillEmail) {
            document.getElementById('loginEmail').value = prefillEmail;
            document.getElementById('signupEmail').value = prefillEmail;
        }

        // Basculer sur onglet signup si demand√©
        if (tabParam === 'signup') {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="signup"]').classList.add('active');
            document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
            document.getElementById('signupForm').classList.add('active');
        }
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
                document.getElementById(targetTab + 'Form').classList.add('active');
                document.querySelectorAll('.message').forEach(m => m.className = 'message');
                // Cacher le display de token si on change d'onglet
                document.getElementById('tokenSuccessDisplay').style.display = 'none';
                document.getElementById('loginSubmit').style.display = 'block';
                document.getElementById('loginInfoBox').style.display = 'block';
            });
        });
        
        function showMessage(elementId, text, type = 'error') {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message ${type}`;
        }
        
        // NOUVEAU: Fonction pour copier le token
        document.getElementById('sessionTokenCode').addEventListener('click', function() {
            navigator.clipboard.writeText(this.textContent).then(() => {
                const tokenMsg = document.getElementById('tokenMessage');
                tokenMsg.textContent = 'Token copi√© ! Collez-le dans le GPT.';
                setTimeout(() => { 
                    tokenMsg.textContent = 'Copiez ce token de session (valide 24h) et collez-le dans le chat GPT :'; 
                }, 2000);
            }).catch(err => {
                console.warn('Erreur de copie auto, copie manuelle requise.');
            });
        });

        // LOGIN HANDLER (Modifi√© pour afficher le token)
        document.getElementById('loginSubmit').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('loginCode').value.trim();
            const email = document.getElementById('loginEmail').value.trim();
            const btn = document.getElementById('loginBtn');
            const loading = document.getElementById('loginLoading');
            
            // üî• NOUVEAU : Accepter codes alphanum√©riques (B2B)
            if (code.length !== 6) {
                showMessage('loginMessage', 'Le code doit contenir exactement 6 caract√®res', 'error');
                return;
            }

            const codePattern6Digits = /^\d{6}$/;
            const codePattern6AlphaNum = /^[A-Z0-9]{6}$/i;

            if (!codePattern6Digits.test(code) && !codePattern6AlphaNum.test(code.toUpperCase())) {
                showMessage('loginMessage', 'Format de code invalide (6 chiffres ou 6 caract√®res alphanum√©riques)', 'error');
                return;
            }
            if (!email || !email.includes('@')) {
                showMessage('loginMessage', 'Email invalide', 'error');
                return;
            }
            
            btn.disabled = true;
            loading.classList.add('show');
            document.getElementById('loginMessage').className = 'message';
            
            try {
                const response = await fetch(`${API_BASE}/auth/create-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, email })
                });
                const data = await response.json();
                                
                if (!response.ok) {
                    if (data.code === "ACCOUNT_NOT_ACTIVE") {
                         showMessage('loginMessage', data.error || 'Compte non activ√©. V√©rifiez vos emails.', 'error');
                    } else if (response.status === 404) {
                        showMessage('loginMessage', 'Code invalide', 'error');
                    } else if (response.status === 401) {
                        showMessage('loginMessage', 'Email incorrect', 'error');
                    } else if (response.status === 429) {
                        showMessage('loginMessage', 'Trop de tentatives. R√©essayez dans 1 minute', 'error');
                    } else {
                        showMessage('loginMessage', data.error || 'Erreur de connexion', 'error');
                    }
                    btn.disabled = false;
                    loading.classList.remove('show');
                    return;
                }
                
                // !! MODIFICATION ICI : CHECK CHARTE PUIS AFFICHER TOKEN !!
                loading.classList.remove('show');
                
                // üî• NOUVEAU : V√©rifier si charte accept√©e
                try {
                    const charterRes = await fetch(`${API_BASE}/consent/status?session_token=${data.session_token}`);
                    
                    if (charterRes.ok) {
                        const charterData = await charterRes.json();
                        
                        if (!charterData.accepted) {
                    // Charte non accept√©e ‚Üí rediriger vers charter.html
                    console.log('üìã Charte non accept√©e ‚Üí redirection');
                    localStorage.setItem('session_token', data.session_token);
                    // Stocker event_code pour apr√®s la charte
                    if (eventCode) {
                        localStorage.setItem('pending_event_code', eventCode);
                    }
                    window.location.href = `charter.html?session_token=${data.session_token}&return=hub.html`;
                    return;
                }
                    }
                } catch (charterErr) {
                    console.warn('‚ö†Ô∏è Erreur check charte:', charterErr);
                    // Continuer quand m√™me (fail-open pour ne pas bloquer)
                }
                
                console.log('‚úÖ Charte accept√©e ‚Üí affichage token');
                
                document.getElementById('loginSubmit').style.display = 'none'; // Cacher le formulaire
                document.getElementById('loginInfoBox').style.display = 'none'; // Cacher l'info box
                
                // Afficher le bloc de succ√®s
                document.getElementById('sessionTokenCode').textContent = data.session_token;
                document.getElementById('tokenSuccessDisplay').style.display = 'block';
                // Lancer le countdown de redirection
                startRedirectCountdown(data.session_token);

            } catch (err) {
                console.error('Login error:', err);
                showMessage('loginMessage', 'Erreur r√©seau. V√©rifiez votre connexion', 'error');
                btn.disabled = false;
                loading.classList.remove('show');
            }
        });
        
        // SIGNUP HANDLER (inchang√©, il est d√©j√† correct)
        document.getElementById('signupSubmit').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value.trim();
            const btn = document.getElementById('signupBtn');
            const loading = document.getElementById('signupLoading');
            
            if (!email || !email.includes('@')) {
                showMessage('signupMessage', 'Email invalide', 'error');
                return;
            }
            
            btn.disabled = true;
            loading.classList.add('show');
            document.getElementById('signupMessage').className = 'message';
            
            try {
                const body = { email };

            // üî• NOUVEAU : Ajouter referral_code si pr√©sent
            if (referralCode) {
                body.referral_code = referralCode;
                console.log('üéÅ Inscription avec parrainage:', referralCode);
            }

            const response = await fetch(`${API_BASE}/user/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                
                if (!response.ok) {
                     if (response.status === 409) {
                         showMessage('signupMessage', data.error || 'Cet email est d√©j√† utilis√©.', 'error');
                     } else if (response.status === 429) {
                         showMessage('signupMessage', data.error || 'Limite de cr√©ation atteinte.', 'error');
                     } else {
                        showMessage('signupMessage', data.error || 'Erreur lors de la cr√©ation du compte', 'error');
                     }
                    btn.disabled = false;
                    loading.classList.remove('show');
                    return;
                }
                
                showMessage('signupMessage', `‚úÖ Code envoy√© √† ${email}. V√©rifiez votre bo√Æte email (et spam).`, 'success');
                // Stocker event_code pour le r√©cup√©rer au login
                if (eventCode) {
                    localStorage.setItem('pending_event_code', eventCode);
                    console.log('üì¶ Event code stock√© pour apr√®s login:', eventCode);
                }

                // Changer bouton en "Renvoyer le code"
                btn.textContent = 'Renvoyer le code';
                btn.disabled = false;

                loading.classList.remove('show');
                
            } catch (err) {
                console.error('Signup error:', err);
                showMessage('signupMessage', 'Erreur r√©seau. V√©rifiez votre connexion', 'error');
                btn.disabled = false;
                loading.classList.remove('show');
            }
        });

        // COMPANY FORM HANDLER (NOUVEAU)
        document.getElementById('companySubmit').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const firstName = document.getElementById('companyAdminFirstName').value.trim();
            const lastName = document.getElementById('companyAdminLastName').value.trim();
            const adminName = `${firstName} ${lastName}`;
            const email = document.getElementById('companyEmail').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const jobLevel = document.getElementById('jobLevel').value;
            const teamSize = document.getElementById('teamSize').value;
            const phone = document.getElementById('companyPhone').value.trim();
            
            const btn = document.getElementById('companyBtn');
            const loading = document.getElementById('companyLoading');
            
            // Validation domaine email
            const domain = email.split('@')[1];
            const publicDomains = ['gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com', 'protonmail.com'];
            
            if (publicDomains.includes(domain)) {
                showMessage('companyMessage', 'Email professionnel requis (pas gmail, outlook, etc.)', 'error');
                return;
            }
            
            btn.disabled = true;
            loading.classList.add('show');
            document.getElementById('companyMessage').className = 'message';
            
            try {
                const response = await fetch(`${API_BASE}/company/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_name: adminName,
                        email: email,
                        company_name: companyName,
                        job_level: jobLevel,
                        team_size: teamSize,
                        phone: phone,
                        account_type: 'b2b'
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 409) {
                        showMessage('companyMessage', data.error || 'Une entreprise existe d√©j√† pour ce domaine.', 'error');
                    } else if (response.status === 400) {
                        showMessage('companyMessage', data.error || 'Donn√©es invalides.', 'error');
                    } else {
                        showMessage('companyMessage', data.error || 'Erreur lors de la cr√©ation.', 'error');
                    }
                    btn.disabled = false;
                    loading.classList.remove('show');
                    return;
                }
                
                // Succ√®s
            if (data.requires_activation) {
                showMessage('companyMessage', 
                    `‚úÖ Code envoy√© √† ${email}. V√©rifiez votre bo√Æte email (et spam).`, 
                    'success'
                );
                
                // Changer bouton en "Renvoyer le code"
                btn.textContent = 'Renvoyer le code';
                btn.disabled = false;
            } else {
                // Conversion VIP ‚Üí B2B directe
                showMessage('companyMessage', 
                    'Entreprise cr√©√©e ! Redirection...', 
                    'success'
                );
                setTimeout(() => {
                    window.location.href = 'b2b-dashboard.html';
                }, 2000);
            }
                
                loading.classList.remove('show');
                
            } catch (err) {
                console.error('Company creation error:', err);
                showMessage('companyMessage', 'Erreur r√©seau. V√©rifiez votre connexion.', 'error');
                btn.disabled = false;
                loading.classList.remove('show');
            }
        });

        // ==========================================
        // TOKEN DISPLAY & REDIRECT FUNCTIONS
        // ==========================================

        let redirectTimer = null;
        let countdownInterval = null;
        let currentToken = null;

        function copyTokenToClipboard() {
            const token = document.getElementById('sessionTokenCode').textContent;
            navigator.clipboard.writeText(token).then(() => {
                const btn = document.getElementById('copyTokenBtn');
                btn.textContent = '‚úÖ Copi√© !';
                btn.style.background = 'var(--ok)';
                
                setTimeout(() => {
                    btn.textContent = 'üìã Copier';
                    btn.style.background = 'var(--mt-accent)';
                }, 2000);
            }).catch(err => {
                console.warn('Erreur copie:', err);
                alert('Erreur de copie. S√©lectionnez et copiez manuellement.');
            });
        }

        function startRedirectCountdown(token) {
            currentToken = token;
            let seconds = 10;
            
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = seconds;
            
            countdownInterval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    goToHubNow();
                }
            }, 1000);
        }

        function goToHubNow() {
            if (countdownInterval) clearInterval(countdownInterval);
            if (!currentToken) return;
            
            localStorage.setItem('session_token', currentToken);
            
            // Construire URL hub avec event_code si pr√©sent
            let hubUrl = `hub.html?session_token=${currentToken}`;
            if (eventCode) {
                hubUrl += `&event_code=${eventCode}`;
            }
            
            window.location.href = hubUrl;
        }

        function cancelRedirect() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            const countdownContainer = document.getElementById('countdown').parentElement.parentElement;
            countdownContainer.innerHTML = `
                <p style="font-size: 13px; color: var(--mt-muted); margin: 0; text-align: center;">
                    ‚úÖ Redirection annul√©e. Fermez cette fen√™tre pour revenir √† GPT.
                </p>
            `;
        }
    </script>
</body>
</html>
