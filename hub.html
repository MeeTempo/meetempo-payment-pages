<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QJYYFST76K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-QJYYFST76K');
</script>
<!-- Fin Google Analytics -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MeeTempo Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f172a;
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 20px;
      padding-top: 80px;
      color: white;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* ============================================
       BARRE TOKEN (FIXE EN HAUT)
    ============================================ */
    .token-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .token-display {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    .token-label {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .token-value {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #F49F1C;
      background: rgba(244, 159, 28, 0.1);
      padding: 6px 12px;
      border-radius: 6px;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .copy-btn {
      background: rgba(244, 159, 28, 0.2);
      border: 1px solid rgba(244, 159, 28, 0.3);
      color: #F49F1C;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .copy-btn:hover {
      background: rgba(244, 159, 28, 0.3);
    }
    
    .copy-btn.copied {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .token-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .action-btn {
      background: rgba(244, 159, 28, 0.9);
      color: #111;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .action-btn:hover {
      background: rgba(244, 159, 28, 1);
      transform: translateY(-1px);
    }
    
    .action-btn.secondary {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .action-btn.secondary:hover {
      background: rgba(255,255,255,0.2);
    }
    
    /* ============================================
       HEADER
    ============================================ */
    .header {
      text-align: center;
      margin-bottom: 20px;
      animation: fadeInDown 0.6s ease;
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }
    
    .header p {
      font-size: 15px;
      opacity: 0.8;
      font-weight: 400;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }
    
    .plan-badge.free { background: rgba(107,114,128,0.3); color: #9ca3af; }
    .plan-badge.meeting { background: rgba(59,130,246,0.3); color: #60a5fa; }
    .plan-badge.premium { background: rgba(139,92,246,0.3); color: #a78bfa; }
    .plan-badge.vip { background: rgba(245,158,11,0.3); color: #fbbf24; }
    .plan-badge.b2b { background: rgba(16,185,129,0.3); color: #34d399; }
    
    /* ============================================
       BANDEAU PROCHAINE INTERACTION
    ============================================ */
    .next-meeting-banner {
      background: linear-gradient(135deg, rgba(16,185,129,0.2) 0%, rgba(5,150,105,0.2) 100%);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      animation: fadeInDown 0.6s ease;
    }
    
    .next-meeting-banner.hidden {
      display: none;
    }
    
    .next-meeting-icon {
      font-size: 32px;
    }
    
    .next-meeting-info {
      flex: 1;
    }
    
    .next-meeting-label {
      font-size: 11px;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .next-meeting-title {
      font-size: 16px;
      font-weight: 600;
      color: #10b981;
    }
    
    .next-meeting-details {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-top: 2px;
    }
    
    .next-meeting-countdown {
      text-align: right;
    }
    
    .countdown-value {
      font-size: 24px;
      font-weight: 700;
      color: #10b981;
    }
    
    .countdown-label {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
    }
    
    /* ============================================
       BANDEAU COMPL√âTION PROFIL
    ============================================ */
    .profile-completion-banner {
      background: linear-gradient(135deg, rgba(249,115,22,0.2) 0%, rgba(234,88,12,0.2) 100%);
      border: 1px solid rgba(249,115,22,0.4);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      animation: fadeInDown 0.6s ease;
    }
    
    .profile-completion-banner.hidden {
      display: none;
    }
    
    .profile-completion-icon {
      font-size: 32px;
    }
    
    .profile-completion-info {
      flex: 1;
    }
    
    .profile-completion-title {
      font-size: 15px;
      font-weight: 600;
      color: #f97316;
      margin-bottom: 4px;
    }
    
    .profile-completion-text {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
    }
    
    .profile-completion-bar {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .profile-completion-fill {
      height: 100%;
      background: linear-gradient(90deg, #f97316, #fb923c);
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    
    .profile-completion-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .profile-completion-btn {
      background: rgba(249,115,22,0.9);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .profile-completion-btn:hover {
      background: #f97316;
      transform: translateY(-1px);
    }
    
    .profile-completion-dismiss {
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
    }
    
    .profile-completion-dismiss:hover {
      color: rgba(255,255,255,0.8);
    }
    
    /* ============================================
       GRID CARDS
    ============================================ */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .card {
      position: relative;
      height: 200px;
      border-radius: 24px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      animation: fadeInUp 0.6s ease;
      animation-fill-mode: both;
      
      /* EFFET GLASSMORPHISM */
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }
    
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.15s; }
    .card:nth-child(3) { animation-delay: 0.2s; }
    .card:nth-child(4) { animation-delay: 0.25s; }
    .card:nth-child(5) { animation-delay: 0.3s; }
    .card:nth-child(6) { animation-delay: 0.35s; }
    .card:nth-child(7) { animation-delay: 0.4s; }
    
    .card:hover:not(.disabled) {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    
    /* Card d√©sactiv√©e */
    .card.disabled {
      cursor: not-allowed;
      opacity: 0.4;
      filter: grayscale(80%);
    }
    
    .card.disabled:hover {
      transform: none;
      box-shadow: none;
    }
    
    .card.disabled .card-overlay {
      background: linear-gradient(135deg, rgba(75,85,99,0.9) 0%, rgba(55,65,81,0.9) 100%) !important;
    }
    
    .card-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(10px);
      transform: scale(1.1);
      opacity: 0.3;
    }
    
    .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* Gradients subtils pour effet verre */
    .card-create .card-overlay { background: linear-gradient(135deg, rgba(244,159,28,0.25), rgba(255,140,0,0.1)); }
    .card-map .card-overlay { background: linear-gradient(135deg, rgba(74,144,226,0.25), rgba(48,91,184,0.1)); }
    .card-requests .card-overlay { background: linear-gradient(135deg, rgba(16,185,129,0.25), rgba(5,150,105,0.1)); }
    .card-suggestions .card-overlay { background: linear-gradient(135deg, rgba(139,92,246,0.25), rgba(109,40,217,0.1)); }
    .card-messages .card-overlay { background: linear-gradient(135deg, rgba(245,158,11,0.25), rgba(217,119,6,0.1)); }
    .card-profile .card-overlay { background: linear-gradient(135deg, rgba(107,114,128,0.25), rgba(75,85,99,0.1)); }
    .card-vip .card-overlay { background: linear-gradient(135deg, rgba(251,191,36,0.25), rgba(245,158,11,0.1)); }
    .card-pricing .card-overlay { background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(244,159,28,0.15)); }
    .card-dashboard .card-overlay { background: linear-gradient(135deg, rgba(244,159,28,0.15), rgba(139,92,246,0.15)); }
    
    /* Effet de survol lumineux */
    .card:hover .card-overlay {
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    }
    
    .card-content {
      position: relative;
      height: 100%;
      padding: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      z-index: 2;
    }
    
    .card-icon {
      font-size: 40px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .card-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .card-subtitle {
      font-size: 12px;
      opacity: 0.9;
      font-weight: 400;
    }
    
    /* Lock icon pour cards d√©sactiv√©es */
    .card-lock {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      opacity: 0.8;
      z-index: 10;
      display: none;
    }
    
    .card.disabled .card-lock {
      display: block;
    }
    
    .card.disabled .card-icon {
      opacity: 0.3;
    }
    
    /* Badge */
    .badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.95);
      color: #111;
      min-width: 28px;
      height: 28px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      padding: 0 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 3;
    }
    
    .badge.hidden {
      display: none;
    }
    
    /* Plan required tag */
    .plan-required {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 4px;
      z-index: 3;
      display: none;
    }
    
    .card.disabled .plan-required {
      display: block;
    }
    
    /* ============================================
       ANIMATIONS
    ============================================ */
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ============================================
       RESPONSIVE
    ============================================ */
    @media (max-width: 768px) {
      body {
        padding: 16px;
        padding-top: 120px;
      }
      
      .token-bar {
        flex-direction: column;
        gap: 10px;
        padding: 10px 16px;
      }
      
      .token-display {
        width: 100%;
        justify-content: center;
      }
      
      .token-actions {
        width: 100%;
        justify-content: center;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        height: 160px;
      }
      
      .card-icon {
        font-size: 32px;
      }
      
      .card-title {
        font-size: 16px;
      }
      
      .header h1 {
        font-size: 26px;
      }
      
      .next-meeting-banner {
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
      
      .next-meeting-countdown {
        text-align: center;
      }
    }
    
    /* Loading state */
    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 16px;
      opacity: 0.8;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(16, 185, 129, 0.95);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  </style>
</head>
<body>
  
  <!-- ============================================
       BARRE TOKEN FIXE
  ============================================ -->
  <div class="token-bar">
    <div class="token-display">
      <span class="token-label">Token :</span>
      <span class="token-value" id="tokenDisplay">Chargement...</span>
      <button class="copy-btn" id="copyBtn" onclick="copyToken()">üìã Copier</button>
    </div>
    <div class="token-actions">
      <button class="action-btn secondary" id="backBtn" onclick="handleBackAction()">
        <span id="backBtnIcon">ü§ñ</span>
        <span id="backBtnText">Revenir √† GPT</span>
      </button>
      <button class="action-btn" onclick="logout()">
        üö™ D√©connexion
      </button>
    </div>
  </div>
  
  <div class="container">
    
    <!-- ============================================
         HEADER
    ============================================ -->
    <div class="header">
      <h1>MeeTempo Hub</h1>
      <p>Bienvenue, <span id="userName">Chargement...</span></p>
      <span class="plan-badge" id="planBadge">...</span>
    </div>
    
    <!-- ============================================
         BANDEAU PROCHAINE INTERACTION
    ============================================ -->
    <div class="next-meeting-banner hidden" id="nextMeetingBanner">
      <div class="next-meeting-icon">üìÖ</div>
      <div class="next-meeting-info">
        <div class="next-meeting-label">Votre prochaine rencontre</div>
        <div class="next-meeting-title" id="nextMeetingTitle">-</div>
        <div class="next-meeting-details" id="nextMeetingDetails">-</div>
      </div>
      <div class="next-meeting-countdown">
        <div class="countdown-value" id="countdownValue">-</div>
        <div class="countdown-label" id="countdownLabel">jours</div>
      </div>
    </div>
    
    <!-- ============================================
         BANDEAU COMPL√âTION PROFIL
    ============================================ -->
    <div class="profile-completion-banner hidden" id="profileCompletionBanner">
      <div class="profile-completion-icon">‚ö†Ô∏è</div>
      <div class="profile-completion-info">
        <div class="profile-completion-title">Ton profil est incomplet (<span id="completionPercent">0</span>%)</div>
        <div class="profile-completion-text">Compl√®te-le pour am√©liorer tes matchs et rencontrer les bonnes personnes !</div>
        <div class="profile-completion-bar">
          <div class="profile-completion-fill" id="completionBar" style="width: 0%"></div>
        </div>
      </div>
      <div class="profile-completion-actions">
        <button class="profile-completion-btn" onclick="navigate('profile')">‚úèÔ∏è Compl√©ter</button>
        <button class="profile-completion-dismiss" onclick="dismissCompletionBanner()" title="Masquer">‚úï</button>
      </div>
    </div>
    
    <!-- ============================================
         GRID CARDS
    ============================================ -->
    <div class="grid" id="cardsGrid">
      <div class="loading" style="grid-column: 1 / -1;">
        Chargement de vos donn√©es
      </div>
    </div>
    
  </div>

 <script>
    // === BLOC UNIVERSEL MEETEMPO - STANDARD (45 min) ===
    (function() {
      const TIMEOUT_MINUTES = 45;
      
      const params = new URLSearchParams(location.search);
      window.MT_TOKEN = params.get('session_token') || params.get('token') || params.get('t')
                     || localStorage.getItem('session_token') 
                     || sessionStorage.getItem('meetempo_token');
      
      if (window.MT_TOKEN) {
        localStorage.setItem('session_token', window.MT_TOKEN);
        sessionStorage.setItem('meetempo_token', window.MT_TOKEN);
      }
      
      if (!window.MT_TOKEN) {
        alert('‚ùå Session expir√©e. Retour √† MeeTempo GPT.');
        window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
        return;
      }
      
      const TIMEOUT_MS = TIMEOUT_MINUTES * 60 * 1000;
      setTimeout(() => {
        alert('‚è∞ Session expir√©e (45 min). Cette page va se fermer.');
        window.close();
        setTimeout(() => {
          window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
        }, 1000);
      }, TIMEOUT_MS);
      
      console.log(`üîê MeeTempo | Token: ${window.MT_TOKEN.substring(0,12)}... | Timeout: ${TIMEOUT_MINUTES}min`);
    })();
    // === FIN BLOC UNIVERSEL ===

    // R√©cup√©rer event_code depuis URL ou localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const pendingEventCode = urlParams.get('event_code') || localStorage.getItem('pending_event_code') || null;
    if (pendingEventCode) {
      console.log('üé™ Event code d√©tect√©:', pendingEventCode);
    }

    const API_BASE = 'https://api.meetempo.com';
    let session_token = window.MT_TOKEN;
    let userData = null;
    let userPlan = 'free';
    let isB2BAdmin = false;
    let hasActiveInteraction = false;
    let eventCode = null;
    let eventData = null;
    let eventAccess = null;
    let userEventPasses = [];

    
    // Afficher token dans la barre (apr√®s chargement DOM)
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('tokenDisplay').textContent = session_token;
    });
    
    // ==========================================
    // üìã COPIER TOKEN
    // ==========================================
    
    function copyToken() {
      navigator.clipboard.writeText(session_token).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = '‚úÖ Copi√© !';
        btn.classList.add('copied');
        
        setTimeout(() => {
          btn.textContent = 'üìã Copier';
          btn.classList.remove('copied');
        }, 2000);
        
        showToast('Token copi√© dans le presse-papier !');
      });
    }
    
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }
    
    // ==========================================
    // üìä CHARGEMENT DONN√âES UTILISATEUR
    // ==========================================
    
    async function loadUserData() {
      try {
        // üî• NOUVEAU : V√©rifier si charte accept√©e
        try {
          const charterRes = await fetch(`${API_BASE}/consent/status?session_token=${session_token}`);
          
          if (charterRes.ok) {
            const charterData = await charterRes.json();
            
            if (!charterData.accepted) {
              console.log('üìã Charte non accept√©e ‚Üí redirection');
              window.location.href = `charter.html?session_token=${session_token}&return=hub.html`;
              return;
            }
            console.log('‚úÖ Charte accept√©e');
          }
        } catch (charterErr) {
          console.warn('‚ö†Ô∏è Erreur check charte:', charterErr);
          // Continuer quand m√™me (fail-open)
        }
        
        const response = await fetch(
          `${API_BASE}/maestro/context?session_token=${session_token}`
        );
        
        if (!response.ok) {
          console.error('‚ùå Token invalide ou expir√©');
          localStorage.removeItem('session_token');
          window.location.href = 'login.html';
          return;
        }
        
        const data = await response.json();
        userData = data;
        userPlan = data.user?.plan || 'free';
        
        console.log('‚úÖ Donn√©es charg√©es:', data);
        console.log('üìã Plan utilisateur:', userPlan);
        
        // üî• V√âRIFIER SI ADMIN B2B ‚Üí REDIRECTION
        await checkB2BAdminAndRedirect();
        
        // V√©rifier si interaction accept√©e (pour Free)
        hasActiveInteraction = (data.pending?.chats_unread > 0) || 
                               (data.stats?.active_suggestions > 0);
        
        // üé™ Charger donn√©es event si event_code pr√©sent
if (pendingEventCode) {
  await loadEventAccess(pendingEventCode);
}

// üé´ Charger event passes actifs (pour affichage card persistante)
await loadActiveEventPasses();

// Mettre √† jour UI
updateUI(data);
        
        // Charger bandeau compl√©tion profil
        loadProfileCompletion();
        
        // Charger compteur nearby
        loadNearbyCount();
        
        // Charger prochaine interaction
        loadNextMeeting();
                
      } catch (err) {
        console.error('‚ùå Erreur chargement:', err);
        document.getElementById('cardsGrid').innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
            ‚ùå Erreur de chargement<br>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #F49F1C; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
              R√©essayer
            </button>
          </div>
        `;
      }
    }
    
    // ==========================================
    // üè¢ CHECK ADMIN B2B ‚Üí REDIRECTION
    // ==========================================
    
    async function checkB2BAdminAndRedirect() {
      try {
        // Charger profil complet pour v√©rifier company_id et role
        const profileRes = await fetch(`${API_BASE}/profile?session_token=${session_token}`);
        if (!profileRes.ok) return;
        
        const profile = await profileRes.json();
        
        // V√©rifier si admin B2B
        if (profile.company_id && (profile.code_admin || profile.company_role === 'admin' || profile.is_admin === true)) {
          isB2BAdmin = true;
          console.log('üè¢ Admin B2B d√©tect√© ‚Üí Redirection dashboard');
          
          // Rediriger vers B2B Dashboard
          window.location.href = `b2b-dashboard.html?session_token=${session_token}`;
          return;
        }
        
        // Si B2B member (pas admin), on reste sur le hub mais on adapte
        if (profile.company_id) {
          userPlan = 'b2b';
          console.log('üè¢ Employ√© B2B d√©tect√© (pas admin)');
        }
        
      } catch (err) {
        console.error('Erreur check B2B:', err);
      }
    }
    
    // ==========================================
    // üé® MISE √Ä JOUR UI
    // ==========================================
    
    function updateUI(data) {
      // Header
      const displayName = data.user?.pseudo || data.user?.display_name || 'MeeTemper';
      document.getElementById('userName').textContent = displayName;
      
      // Plan badge
      const planBadge = document.getElementById('planBadge');
      const planLabels = {
        'free': 'üÜì Gratuit',
        'meeting': 'ü§ù Meeting (23h)',
        'premium': '‚≠ê Premium',
        'vip': 'üëë VIP',
        'b2b': 'üè¢ Entreprise'
      };
      planBadge.textContent = planLabels[userPlan] || userPlan;
      planBadge.className = `plan-badge ${userPlan}`;
      
      // Adapter bouton retour selon contexte
      updateBackButton();
      
      // Donn√©es badges
      const requestsCount = data.pending?.requests || 0;
      const messagesCount = data.pending?.chats_unread || 0;
      const suggestionsCount = data.stats?.active_suggestions || 0;
      
      // D√©terminer acc√®s selon plan
      const access = getAccessByPlan(userPlan, hasActiveInteraction);
      
      // Cr√©er cards
      let cardsHTML = '';
      
      // Card 1 : Cr√©er suggestion
      cardsHTML += createCard({
        id: 'create',
        icon: '<i class="fas fa-plus-circle"></i>',
        image: 'https://images.unsplash.com/photo-1511632765486-a01980e01a18?q=80&w=400',
        title: 'Cr√©er une suggestion',
        subtitle: 'Propose une sortie',
        cssClass: 'card-create',
        disabled: !access.canCreate,
        planRequired: access.canCreate ? null : 'Meeting+',
        onClick: "navigate('create')"
      });
      
      // Card 2 : Map
      cardsHTML += createCard({
        id: 'map',
        icon: '<i class="fas fa-map-marked-alt"></i>',
        image: 'https://images.unsplash.com/photo-1524661135-423995f22d0b?q=80&w=400',
        title: 'Autour de moi',
        subtitle: 'Rejoins des MeeTempers',
        cssClass: 'card-map',
        badgeId: 'nearbyBadge',
        disabled: false,
        onClick: "navigate('map')"
      });
      
      // Card 3 : Mes demandes
      cardsHTML += createCard({
        id: 'requests',
        icon: '<i class="fas fa-user-friends"></i>',
        image: 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?q=80&w=400',
        title: 'Mes demandes',
        subtitle: `${requestsCount} en attente`,
        cssClass: 'card-requests',
        badge: requestsCount > 0 ? requestsCount : null,
        badgeId: 'requestsBadge',
        disabled: !access.canViewRequests,
        planRequired: access.canViewRequests ? null : 'Meeting+',
        onClick: "navigate('requests')"
      });
      
      // Card 4 : Mes suggestions
      cardsHTML += createCard({
        id: 'suggestions',
        icon: '<i class="far fa-calendar-alt"></i>',
        image: 'https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=400',
        title: 'Mes suggestions',
        subtitle: `${suggestionsCount} active${suggestionsCount > 1 ? 's' : ''}`,
        cssClass: 'card-suggestions',
        badge: suggestionsCount > 0 ? suggestionsCount : null,
        badgeId: 'suggestionsBadge',
        disabled: false,
        onClick: "navigate('suggestions')"
      });
      
      // Card 5 : Messages
      cardsHTML += createCard({
        id: 'messages',
        icon: '<i class="far fa-comments"></i>',
        image: 'https://images.unsplash.com/photo-1577563908411-5077b6dc7624?q=80&w=400',
        title: 'Messages',
        subtitle: `${messagesCount} non lu${messagesCount > 1 ? 's' : ''}`,
        cssClass: 'card-messages',
        badge: messagesCount > 0 ? messagesCount : null,
        badgeId: 'messagesBadge',
        disabled: !access.canViewMessages,
        planRequired: access.canViewMessages ? null : 'Interaction requise',
        onClick: "navigate('messages')"
      });
      
      // Card 6 : Nos offres
      const pricingSubtitle = userPlan === 'free' ? 'Go Premium & VIP' :
                              userPlan === 'meeting' ? 'Passez √† Premium' :
                              userPlan === 'premium' ? 'Devenez VIP' :
                              userPlan === 'vip' ? 'Plan actuel' : 'Plans entreprise';
      
      cardsHTML += createCard({
        id: 'pricing',
        icon: '<i class="far fa-gem"></i>',
        image: 'https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?q=80&w=400',
        title: 'Nos offres',
        subtitle: pricingSubtitle,
        cssClass: 'card-pricing',
        disabled: false,
        onClick: "navigate('pricing')"
      });

      // Card : Candidater VIP (visible si Premium + non √©ligible + pas encore candidat√©)
      const vipEligible = data.user?.vip_eligible || false;
      const vipScore = data.user?.vip_score || 0;
      const profileCompletion = data.user?.profile_completion || 0;
      const vipApplied = data.user?.vip_applied || false;

      if (userPlan === 'premium' && !vipEligible && !vipApplied) {
        let vipCardSubtitle = '';
        let vipCardDisabled = false;
        
        if (profileCompletion < 90) {
          vipCardSubtitle = `Profil ${profileCompletion}% - Compl√©tez d'abord`;
          vipCardDisabled = true;
        } else {
          vipCardSubtitle = `Score ${vipScore}/55 - Candidatez !`;
        }
        
        cardsHTML += createCard({
          id: 'vip-apply',
          icon: '<i class="fas fa-crown"></i>',
          image: 'https://images.unsplash.com/photo-1553729459-efe14ef6055d?q=80&w=400',
          title: 'Candidater VIP',
          subtitle: vipCardSubtitle,
          cssClass: 'card-vip',
          disabled: vipCardDisabled,
          planRequired: vipCardDisabled ? 'Profil 90%+' : null,
          onClick: "navigate('pricing')"
        });
      }
      
      // Card 7 : Profil
      cardsHTML += createCard({
        id: 'profile',
        icon: '<i class="fas fa-user-cog"></i>',
        image: 'https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?q=80&w=400',
        title: 'Mon profil',
        subtitle: 'G√©rer mon compte',
        cssClass: 'card-profile',
        disabled: false,
        onClick: "navigate('profile')"
      });

      // Card : Mes Events (Event Context)
      const hasEventAccess = userPlan === 'vip' || (userPlan && userPlan.startsWith('b2b'));
      const hasActivePasses = userEventPasses.length > 0;
      const showEventCard = eventCode || hasActivePasses || hasEventAccess;
      
      if (showEventCard) {
        let eventSubtitle = '';
        let eventDisabled = false;
        let eventOnClick = "navigate('events')";
        
        if (eventCode && eventAccess) {
          if (eventAccess.requires_payment) {
            eventSubtitle = `Payer 2,99‚Ç¨`;
            eventOnClick = `redirectToEventPayment('${eventCode}', '${eventData?.event_id || ''}')`;
          } else if (eventAccess.action === 'already_joined') {
            eventSubtitle = `‚úÖ Rejoint`;
          } else {
            eventSubtitle = `üéâ Acc√®s gratuit`;
            eventOnClick = `joinEventFree('${eventCode}')`;
          }
        } else if (hasActivePasses) {
          const count = userEventPasses.length;
          eventSubtitle = `${count} √©v√©nement${count > 1 ? 's' : ''} actif${count > 1 ? 's' : ''}`;
        } else if (hasEventAccess) {
             eventSubtitle = 'Organiser / Rejoindre';
        }
        
        cardsHTML += createCard({
          id: 'events',
          icon: '<i class="fas fa-ticket-alt"></i>',
          image: 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=400',
          title: 'Mes Events',
          subtitle: eventSubtitle,
          cssClass: 'card-create', // On garde le style orange
          disabled: eventDisabled,
          onClick: eventOnClick
        });
      }

      // Card 8 : Dashboard (visible pour Premium et B2B employee)
      if (userPlan === 'premium' || (userPlan && userPlan.startsWith('b2b'))) {
        cardsHTML += createCard({
          id: 'dashboard',
          icon: '<i class="fas fa-chart-line"></i>',
          image: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=400',
          title: 'Dashboard',
          subtitle: 'Stats & Infos',
          cssClass: 'card-dashboard',
          disabled: false,
          onClick: "navigate('dashboard')"
        });
      }
      
      // Card 9 : Dashboard VIP
      if (userPlan === 'vip') {
        cardsHTML += createCard({
          id: 'vip',
          icon: '<i class="fas fa-crown"></i>',
          image: 'https://images.unsplash.com/photo-1504196606672-aef5c9ce79c6?q=80&w=400',
          title: 'Espace VIP',
          subtitle: 'R√©compenses & Status',
          cssClass: 'card-vip',
          disabled: false,
          onClick: "navigate('vip')"
        });
      }
      
      document.getElementById('cardsGrid').innerHTML = cardsHTML;
    }
    
    // ==========================================
    // üîê MATRICE D'ACC√àS PAR PLAN
    // ==========================================
    
    function getAccessByPlan(plan, hasInteraction) {
      const accessMatrix = {
        'free': {
          canCreate: false, // Limit√© √† 1 (g√©r√© backend)
          canViewRequests: hasInteraction,
          canViewMessages: hasInteraction,
          canViewMap: true,
          canViewSuggestions: true
        },
        'meeting': {
          canCreate: true,
          canViewRequests: true,
          canViewMessages: true,
          canViewMap: true,
          canViewSuggestions: true
        },
        'premium': {
          canCreate: true,
          canViewRequests: true,
          canViewMessages: true,
          canViewMap: true,
          canViewSuggestions: true
        },
        'vip': {
          canCreate: true,
          canViewRequests: true,
          canViewMessages: true,
          canViewMap: true,
          canViewSuggestions: true
        },
        'b2b': {
          canCreate: true,
          canViewRequests: true,
          canViewMessages: true,
          canViewMap: true,
          canViewSuggestions: true
        }
      };
      
      // Normaliser les plans B2B
if (plan && plan.startsWith('b2b')) {
  return accessMatrix['b2b'];
}
return accessMatrix[plan] || accessMatrix['free'];
    }
    
    // ==========================================
    // üÉè CR√âATION CARD HTML
    // ==========================================
    
    function createCard(options) {
      const {
        id, icon, title, subtitle, cssClass,
        badge, badgeId, disabled, planRequired, onClick, image
      } = options;
      
      const disabledClass = disabled ? 'disabled' : '';
      const badgeHtml = badge ? `<div class="badge" id="${badgeId || ''}">${badge}</div>` : 
                        (badgeId ? `<div class="badge hidden" id="${badgeId}">0</div>` : '');
      const lockHtml = disabled ? '<div class="card-lock"><i class="fas fa-lock"></i></div>' : '';
      const planHtml = planRequired ? `<div class="plan-required">${planRequired}</div>` : '';
      const clickAttr = disabled ? '' : `onclick="${onClick}"`;
      
      // C'est ici qu'on ajoute l'image de fond
      const bgHtml = image ? `<div class="card-bg" style="background-image: url('${image}');"></div>` : '';

      return `
        <div class="card ${cssClass} ${disabledClass}" ${clickAttr}>
          ${bgHtml}
          <div class="card-overlay"></div>
          ${badgeHtml}
          ${lockHtml}
          ${planHtml}
          <div class="card-content">
            <div class="card-icon">${icon}</div>
            <div class="card-text">
              <div class="card-title">${title}</div>
              <div class="card-subtitle">${subtitle}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ==========================================
    // üîô BOUTON RETOUR CONTEXTUEL
    // ==========================================
    
    function updateBackButton() {
      const btnIcon = document.getElementById('backBtnIcon');
      const btnText = document.getElementById('backBtnText');
      
      if (isB2BAdmin) {
        btnIcon.textContent = 'üè¢';
        btnText.textContent = 'Dashboard B2B';
      } else {
        btnIcon.textContent = '‚ùå';
        btnText.textContent = 'Fermer (retour GPT)';
      }
    }
    
    function handleBackAction() {
      if (isB2BAdmin) {
        window.location.href = `b2b-dashboard.html?session_token=${session_token}`;
      } else {
        backToGPT();
      }
    }
    
    function backToGPT() {
  alert('üí° Fermez cette fen√™tre pour revenir √† votre conversation GPT.\n\n‚ö†Ô∏è Note : MeeTempo GPT n\'a pas de m√©moire des conversations. Pensez √† redonner votre token si besoin.');
}

// ==========================================
// üìä BANDEAU COMPL√âTION PROFIL
// ==========================================

async function loadProfileCompletion() {
  try {
    // V√©rifier si d√©j√† dismissed aujourd'hui
    const dismissedUntil = localStorage.getItem('profile_banner_dismissed');
    if (dismissedUntil && Date.now() < parseInt(dismissedUntil)) {
      console.log('üìä Bandeau compl√©tion masqu√© (dismissed)');
      return;
    }
    
    const res = await fetch(`${API_BASE}/profile?session_token=${session_token}`);
    if (!res.ok) return;
    
    const profile = await res.json();
    const completion = profile.profile_completion || 0;
    
    console.log(`üìä Compl√©tion profil: ${completion}%`);
    
    // Afficher si < 60% OU si signature_questions manquantes
    const missingFields = profile.missing_fields || [];
    const missingSignatures = missingFields.includes('signature_questions');
    
    if (completion < 60 || missingSignatures) {
      const banner = document.getElementById('profileCompletionBanner');
      const percentSpan = document.getElementById('completionPercent');
      const bar = document.getElementById('completionBar');
      
      if (banner && percentSpan && bar) {
        percentSpan.textContent = completion;
        bar.style.width = `${completion}%`;
        banner.classList.remove('hidden');
      }
    }
    
  } catch (err) {
    console.error('‚ùå Erreur chargement compl√©tion:', err);
  }
}

function dismissCompletionBanner() {
  const banner = document.getElementById('profileCompletionBanner');
  if (banner) banner.classList.add('hidden');
  
  // Masquer pour 24h
  const tomorrow = Date.now() + (24 * 60 * 60 * 1000);
  localStorage.setItem('profile_banner_dismissed', tomorrow.toString());
  
  showToast('Bandeau masqu√© pour 24h');
}
    
    // ==========================================
// üìÖ PROCHAINE INTERACTION
// ==========================================

async function loadNextMeeting() {
  try {
    // Utiliser les donn√©es d√©j√† charg√©es dans userData (maestro/context)
    if (!userData) return;
    
    // Chercher dans feedbacks_list (suggestions r√©centes avec date)
    const feedbacksList = userData.pending?.feedbacks_list || [];
    
    // Pour l'instant, pas de donn√©es fiables sur les rencontres futures
    // Le bandeau reste cach√© par d√©faut
    // TODO: Cr√©er endpoint /suggestions/upcoming pour cette feature
    
    console.log('üìÖ Prochaine rencontre: feature en attente');
    
  } catch (err) {
    console.error('Erreur next meeting:', err);
  }
}

// ==========================================
    // üé™ CHARGEMENT ACC√àS EVENT
    // ==========================================
    
    async function loadEventAccess(code) {
      try {
        // R√©cup√©rer email depuis /profile car maestro/context ne le contient pas toujours
        let email = '';
        try {
          const profileRes = await fetch(`${API_BASE}/profile?session_token=${session_token}`);
          if (profileRes.ok) {
            const profile = await profileRes.json();
            email = profile.email || '';
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Erreur r√©cup email:', e);
        }
        const res = await fetch(`${API_BASE}/event/check-access?event_code=${code}&email=${encodeURIComponent(email)}`);
        
        if (!res.ok) {
          console.error('‚ùå Event introuvable:', code);
          localStorage.removeItem('pending_event_code');
          return;
        }
        
        const data = await res.json();
        eventCode = code;
        eventData = data.event;
        eventAccess = data.access;
        
        console.log('üé™ Event charg√©:', eventData?.event_name);
        console.log('üé´ Acc√®s:', eventAccess);
        
        // Nettoyer localStorage si d√©j√† rejoint
        if (eventAccess?.action === 'already_joined') {
          localStorage.removeItem('pending_event_code');
        }
        
      } catch (err) {
        console.error('‚ùå Erreur chargement event:', err);
      }
    }

    // ==========================================
// üé´ CHARGEMENT EVENT PASSES ACTIFS
// ==========================================

async function loadActiveEventPasses() {
  try {
    const profileRes = await fetch(`${API_BASE}/profile?session_token=${session_token}`);
    if (!profileRes.ok) return [];
    
    const profile = await profileRes.json();
    const passes = profile.profile_rich?.event_passes || [];
    
    // Filtrer passes actifs ET non expir√©s
    const now = Date.now();
    userEventPasses = passes.filter(p => {
      if (p.status !== 'active') return false;
      const validUntil = new Date(p.valid_until).getTime();
      return validUntil > now;
    });
    
    console.log(`üé´ Event passes actifs: ${userEventPasses.length}`);
    return userEventPasses;
    
  } catch (err) {
    console.error('‚ùå Erreur chargement event passes:', err);
    return [];
  }
}

    // ==========================================
    // üé´ PAIEMENT EVENT & JOIN
    // ==========================================
    
    async function redirectToEventPayment(code, eventId) {
      try {
        showToast('Redirection vers le paiement...');
        
        const res = await fetch(`${API_BASE}/create-checkout-session?session_token=${session_token}&plan=meeting_event&event_id=${eventId}`);
        const data = await res.json();
        
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('‚ùå Erreur cr√©ation paiement: ' + (data.error || 'R√©essayez'));
        }
      } catch (err) {
        console.error('Erreur paiement event:', err);
        alert('‚ùå Erreur r√©seau. R√©essayez.');
      }
    }
    
    async function joinEventFree(code) {
      try {
        showToast('Inscription en cours...');
        
        const res = await fetch(`${API_BASE}/event/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_token: session_token,
            event_code: code
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          localStorage.removeItem('pending_event_code');
          showToast('‚úÖ Vous avez rejoint l\'√©v√©nement !');
          setTimeout(() => location.reload(), 1500);
        } else {
          alert('‚ùå Erreur: ' + (data.error || 'R√©essayez'));
        }
      } catch (err) {
        console.error('Erreur join event:', err);
        alert('‚ùå Erreur r√©seau. R√©essayez.');
      }
    }
    
    // ==========================================
    // üó∫Ô∏è COMPTEUR NEARBY
    // ==========================================
    
    async function loadNearbyCount() {
      try {
        const profileResponse = await fetch(
          `${API_BASE}/profile?session_token=${session_token}`
        );
        
        if (!profileResponse.ok) throw new Error('Erreur profil');
        
        const profile = await profileResponse.json();
        
        const lat = profile.city_coords?.lat || profile.profile?.city_coords?.lat || 48.8566;
        const lng = profile.city_coords?.lng || profile.profile?.city_coords?.lng || 2.3522;
        
        const response = await fetch(
          `${API_BASE}/suggestions/nearby?session_token=${session_token}&lat=${lat}&lng=${lng}&radius=10`
        );
        
        if (!response.ok) throw new Error('Erreur nearby');
        
        const data = await response.json();
        const allSuggestions = data.results || [];
        
        // Filtrer hors Free
        const nonFreeSuggestions = allSuggestions.filter(s => {
          const creatorPlan = s.creator?.plan || 'free';
          return creatorPlan !== 'free';
        });
        
        const badge = document.getElementById('nearbyBadge');
        if (badge) {
          if (nonFreeSuggestions.length > 0) {
            badge.textContent = nonFreeSuggestions.length;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
        
      } catch (err) {
        console.error('‚ùå Erreur nearby count:', err);
      }
    }
    
    // ==========================================
    // üß≠ NAVIGATION
    // ==========================================
    
    function navigate(section) {
      const tokenParam = `session_token=${session_token}`;
      
      switch(section) {
        case 'create':
          // Pour cr√©er, on propose 2 options
          if (confirm('Comment voulez-vous cr√©er votre suggestion ?\n\nOK = Via GPT MeeTempo (recommand√©)\nAnnuler = Via formulaire simple')) {
            // Via GPT
            const gptUrl = `https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19`;
            window.location.href = gptUrl;
          } else {
            // Via formulaire simple (√† cr√©er si besoin)
            window.location.href = `create-suggestion.html?${tokenParam}`;
          }
          break;
          
        case 'map':
          window.location.href = `map.html?${tokenParam}`;
          break;
          
        case 'requests':
          window.location.href = `my-requests.html?${tokenParam}`;
          break;
          
        case 'suggestions':
          window.location.href = `my-suggestions.html?${tokenParam}`;
          break;
          
        case 'messages':
          window.location.href = `my-chats.html?${tokenParam}`;
          break;
          
        case 'profile':
          window.location.href = `profile.html?${tokenParam}`;
          break;
          
        case 'vip':
          window.location.href = `vip-dashboard.html?${tokenParam}`;
          break;
          
        case 'pricing':
          window.location.href = `pricing.html?${tokenParam}`;
          break;

        case 'dashboard':
          window.location.href = `dashboard.html?${tokenParam}`;
          break;

        case 'events':
          window.location.href = `my-events.html?${tokenParam}`;
          break;
      }
    }
    
    // ==========================================
    // üö™ D√âCONNEXION
    // ==========================================
    
    function logout() {
      if (confirm('Voulez-vous vous d√©connecter ?')) {
        localStorage.removeItem('session_token');
        localStorage.removeItem('elevated_token');
        sessionStorage.clear();
        window.location.href = 'login.html';
      }
    }
    
    // ==========================================
    // üöÄ D√âMARRAGE
    // ==========================================
    
    loadUserData();
  </script>
</body>
</html>
