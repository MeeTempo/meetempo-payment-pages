<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MeeTempo Hub</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
      min-height: 100vh;
      padding: 20px;
      padding-top: 80px; /* Espace pour la barre token */
      color: white;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* ============================================
       BARRE TOKEN (FIXE EN HAUT)
    ============================================ */
    .token-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .token-display {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    .token-label {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .token-value {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #F49F1C;
      background: rgba(244, 159, 28, 0.1);
      padding: 6px 12px;
      border-radius: 6px;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .copy-btn {
      background: rgba(244, 159, 28, 0.2);
      border: 1px solid rgba(244, 159, 28, 0.3);
      color: #F49F1C;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .copy-btn:hover {
      background: rgba(244, 159, 28, 0.3);
    }
    
    .copy-btn.copied {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .token-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .action-btn {
      background: rgba(244, 159, 28, 0.9);
      color: #111;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .action-btn:hover {
      background: rgba(244, 159, 28, 1);
      transform: translateY(-1px);
    }
    
    .action-btn.secondary {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .action-btn.secondary:hover {
      background: rgba(255,255,255,0.2);
    }
    
    /* ============================================
       HEADER
    ============================================ */
    .header {
      text-align: center;
      margin-bottom: 20px;
      animation: fadeInDown 0.6s ease;
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }
    
    .header p {
      font-size: 15px;
      opacity: 0.8;
      font-weight: 400;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }
    
    .plan-badge.free { background: rgba(107,114,128,0.3); color: #9ca3af; }
    .plan-badge.meeting { background: rgba(59,130,246,0.3); color: #60a5fa; }
    .plan-badge.premium { background: rgba(139,92,246,0.3); color: #a78bfa; }
    .plan-badge.vip { background: rgba(245,158,11,0.3); color: #fbbf24; }
    .plan-badge.b2b { background: rgba(16,185,129,0.3); color: #34d399; }
    
    /* ============================================
       BANDEAU PROCHAINE INTERACTION
    ============================================ */
    .next-meeting-banner {
      background: linear-gradient(135deg, rgba(16,185,129,0.2) 0%, rgba(5,150,105,0.2) 100%);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      animation: fadeInDown 0.6s ease;
    }
    
    .next-meeting-banner.hidden {
      display: none;
    }
    
    .next-meeting-icon {
      font-size: 32px;
    }
    
    .next-meeting-info {
      flex: 1;
    }
    
    .next-meeting-label {
      font-size: 11px;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .next-meeting-title {
      font-size: 16px;
      font-weight: 600;
      color: #10b981;
    }
    
    .next-meeting-details {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-top: 2px;
    }
    
    .next-meeting-countdown {
      text-align: right;
    }
    
    .countdown-value {
      font-size: 24px;
      font-weight: 700;
      color: #10b981;
    }
    
    .countdown-label {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
    }
    
    /* ============================================
       GRID CARDS
    ============================================ */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .card {
      position: relative;
      height: 200px;
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: fadeInUp 0.6s ease;
      animation-fill-mode: both;
    }
    
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.15s; }
    .card:nth-child(3) { animation-delay: 0.2s; }
    .card:nth-child(4) { animation-delay: 0.25s; }
    .card:nth-child(5) { animation-delay: 0.3s; }
    .card:nth-child(6) { animation-delay: 0.35s; }
    .card:nth-child(7) { animation-delay: 0.4s; }
    
    .card:hover:not(.disabled) {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    
    /* Card d√©sactiv√©e */
    .card.disabled {
      cursor: not-allowed;
      opacity: 0.4;
      filter: grayscale(80%);
    }
    
    .card.disabled:hover {
      transform: none;
      box-shadow: none;
    }
    
    .card.disabled .card-overlay {
      background: linear-gradient(135deg, rgba(75,85,99,0.9) 0%, rgba(55,65,81,0.9) 100%) !important;
    }
    
    .card-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(10px);
      transform: scale(1.1);
      opacity: 0.3;
    }
    
    .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* Gradients pour chaque card */
    .card-create .card-overlay { background: linear-gradient(135deg, rgba(244,159,28,0.9) 0%, rgba(255,140,0,0.9) 100%); }
    .card-map .card-overlay { background: linear-gradient(135deg, rgba(74,144,226,0.9) 0%, rgba(48,91,184,0.9) 100%); }
    .card-requests .card-overlay { background: linear-gradient(135deg, rgba(16,185,129,0.9) 0%, rgba(5,150,105,0.9) 100%); }
    .card-suggestions .card-overlay { background: linear-gradient(135deg, rgba(139,92,246,0.9) 0%, rgba(109,40,217,0.9) 100%); }
    .card-messages .card-overlay { background: linear-gradient(135deg, rgba(245,158,11,0.9) 0%, rgba(217,119,6,0.9) 100%); }
    .card-profile .card-overlay { background: linear-gradient(135deg, rgba(107,114,128,0.9) 0%, rgba(75,85,99,0.9) 100%); }
    .card-vip .card-overlay { background: linear-gradient(135deg, rgba(251,191,36,0.9) 0%, rgba(245,158,11,0.9) 100%); }
    
    .card-content {
      position: relative;
      height: 100%;
      padding: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      z-index: 2;
    }
    
    .card-icon {
      font-size: 40px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .card-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .card-subtitle {
      font-size: 12px;
      opacity: 0.9;
      font-weight: 400;
    }
    
    /* Lock icon pour cards d√©sactiv√©es */
    .card-lock {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      opacity: 0.8;
      z-index: 10;
      display: none;
    }
    
    .card.disabled .card-lock {
      display: block;
    }
    
    .card.disabled .card-icon {
      opacity: 0.3;
    }
    
    /* Badge */
    .badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.95);
      color: #111;
      min-width: 28px;
      height: 28px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      padding: 0 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 3;
    }
    
    .badge.hidden {
      display: none;
    }
    
    /* Plan required tag */
    .plan-required {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 4px;
      z-index: 3;
      display: none;
    }
    
    .card.disabled .plan-required {
      display: block;
    }
    
    /* ============================================
       ANIMATIONS
    ============================================ */
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ============================================
       RESPONSIVE
    ============================================ */
    @media (max-width: 768px) {
      body {
        padding: 16px;
        padding-top: 120px;
      }
      
      .token-bar {
        flex-direction: column;
        gap: 10px;
        padding: 10px 16px;
      }
      
      .token-display {
        width: 100%;
        justify-content: center;
      }
      
      .token-actions {
        width: 100%;
        justify-content: center;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        height: 160px;
      }
      
      .card-icon {
        font-size: 32px;
      }
      
      .card-title {
        font-size: 16px;
      }
      
      .header h1 {
        font-size: 26px;
      }
      
      .next-meeting-banner {
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
      
      .next-meeting-countdown {
        text-align: center;
      }
    }
    
    /* Loading state */
    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 16px;
      opacity: 0.8;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(16, 185, 129, 0.95);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  </style>
</head>
<body>
  
  <!-- ============================================
       BARRE TOKEN FIXE
  ============================================ -->
  <div class="token-bar">
    <div class="token-display">
      <span class="token-label">Token :</span>
      <span class="token-value" id="tokenDisplay">Chargement...</span>
      <button class="copy-btn" id="copyBtn" onclick="copyToken()">üìã Copier</button>
    </div>
    <div class="token-actions">
      <button class="action-btn secondary" id="backBtn" onclick="handleBackAction()">
        <span id="backBtnIcon">ü§ñ</span>
        <span id="backBtnText">Retour GPT</span>
      </button>
      <button class="action-btn" onclick="logout()">
        üö™ D√©connexion
      </button>
    </div>
  </div>
  
  <div class="container">
    
    <!-- ============================================
         HEADER
    ============================================ -->
    <div class="header">
      <h1>MeeTempo Hub</h1>
      <p>Bienvenue, <span id="userName">Chargement...</span></p>
      <span class="plan-badge" id="planBadge">...</span>
    </div>
    
    <!-- ============================================
         BANDEAU PROCHAINE INTERACTION
    ============================================ -->
    <div class="next-meeting-banner hidden" id="nextMeetingBanner">
      <div class="next-meeting-icon">üìÖ</div>
      <div class="next-meeting-info">
        <div class="next-meeting-label">Votre prochaine rencontre</div>
        <div class="next-meeting-title" id="nextMeetingTitle">-</div>
        <div class="next-meeting-details" id="nextMeetingDetails">-</div>
      </div>
      <div class="next-meeting-countdown">
        <div class="countdown-value" id="countdownValue">-</div>
        <div class="countdown-label" id="countdownLabel">jours</div>
      </div>
    </div>
    
    <!-- ============================================
         GRID CARDS
    ============================================ -->
    <div class="grid" id="cardsGrid">
      <div class="loading" style="grid-column: 1 / -1;">
        Chargement de vos donn√©es
      </div>
    </div>
    
  </div>

  <script>
    const API_BASE = 'https://api.meetempo.com';
    let session_token = null;
    let userData = null;
    let userPlan = 'free';
    let isB2BAdmin = false;
    let hasActiveInteraction = false;
    
    // ==========================================
    // üîí R√âCUP√âRATION ET VALIDATION TOKEN
    // ==========================================
    
    (function initToken() {
      const params = new URLSearchParams(window.location.search);
      session_token = params.get('session_token') || params.get('token');
      
      if (!session_token) {
        session_token = localStorage.getItem('session_token');
      }
      
      if (!session_token) {
        console.warn('‚ö†Ô∏è Aucun token, redirection login');
        window.location.href = 'login.html';
        return;
      }
      
      localStorage.setItem('session_token', session_token);
      
      // Afficher token dans la barre
      document.getElementById('tokenDisplay').textContent = session_token;
      
      console.log('‚úÖ Token charg√©:', session_token.substring(0, 8) + '...');
    })();
    
    // ==========================================
    // üìã COPIER TOKEN
    // ==========================================
    
    function copyToken() {
      navigator.clipboard.writeText(session_token).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = '‚úÖ Copi√© !';
        btn.classList.add('copied');
        
        setTimeout(() => {
          btn.textContent = 'üìã Copier';
          btn.classList.remove('copied');
        }, 2000);
        
        showToast('Token copi√© dans le presse-papier !');
      });
    }
    
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }
    
    // ==========================================
    // üìä CHARGEMENT DONN√âES UTILISATEUR
    // ==========================================
    
    async function loadUserData() {
      try {
        const response = await fetch(
          `${API_BASE}/maestro/context?session_token=${session_token}`
        );
        
        if (!response.ok) {
          console.error('‚ùå Token invalide ou expir√©');
          localStorage.removeItem('session_token');
          window.location.href = 'login.html';
          return;
        }
        
        const data = await response.json();
        userData = data;
        userPlan = data.user?.plan || 'free';
        
        console.log('‚úÖ Donn√©es charg√©es:', data);
        console.log('üìã Plan utilisateur:', userPlan);
        
        // üî• V√âRIFIER SI ADMIN B2B ‚Üí REDIRECTION
        await checkB2BAdminAndRedirect();
        
        // V√©rifier si interaction accept√©e (pour Free)
        hasActiveInteraction = (data.pending?.chats_unread > 0) || 
                               (data.stats?.active_suggestions > 0);
        
        // Mettre √† jour UI
        updateUI(data);
        
        // Charger compteur nearby
        loadNearbyCount();
        
        // Charger prochaine interaction
        loadNextMeeting();
        
      } catch (err) {
        console.error('‚ùå Erreur chargement:', err);
        document.getElementById('cardsGrid').innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
            ‚ùå Erreur de chargement<br>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #F49F1C; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
              R√©essayer
            </button>
          </div>
        `;
      }
    }
    
    // ==========================================
    // üè¢ CHECK ADMIN B2B ‚Üí REDIRECTION
    // ==========================================
    
    async function checkB2BAdminAndRedirect() {
      try {
        // Charger profil complet pour v√©rifier company_id et role
        const profileRes = await fetch(`${API_BASE}/profile?session_token=${session_token}`);
        if (!profileRes.ok) return;
        
        const profile = await profileRes.json();
        
        // V√©rifier si admin B2B
        if (profile.company_id && (profile.code_admin || profile.company_role === 'admin' || profile.is_admin === true)) {
          isB2BAdmin = true;
          console.log('üè¢ Admin B2B d√©tect√© ‚Üí Redirection dashboard');
          
          // Rediriger vers B2B Dashboard
          window.location.href = `b2b-dashboard.html?session_token=${session_token}`;
          return;
        }
        
        // Si B2B member (pas admin), on reste sur le hub mais on adapte
        if (profile.company_id) {
          userPlan = 'b2b';
          console.log('üè¢ Employ√© B2B d√©tect√© (pas admin)');
        }
        
      } catch (err) {
        console.error('Erreur check B2B:', err);
      }
    }
    
    // ==========================================
    // üé® MISE √Ä JOUR UI
    // ==========================================
    
    function updateUI(data) {
      // Header
      const displayName = data.user?.pseudo || data.user?.display_name || 'MeeTemper';
      document.getElementById('userName').textContent = displayName;
      
      // Plan badge
      const planBadge = document.getElementById('planBadge');
      const planLabels = {
        'free': 'üÜì Gratuit',
        'meeting': 'ü§ù Meeting (23h)',
        'premium': '‚≠ê Premium',
        'vip': 'üëë VIP',
        'b2b': 'üè¢ Entreprise'
      };
      planBadge.textContent = planLabels[userPlan] || userPlan;
      planBadge.className = `plan-badge ${userPlan}`;
      
      // Adapter bouton retour selon contexte
      updateBackButton();
      
      // Donn√©es badges
      const requestsCount = data.pending?.requests || 0;
      const messagesCount = data.pending?.chats_unread || 0;
      const suggestionsCount = data.stats?.active_suggestions || 0;
      
      // D√©terminer acc√®s selon plan
      const access = getAccessByPlan(userPlan, hasActiveInteraction);
      
      // Cr√©er cards
      let cardsHTML = '';
      
      // Card 1 : Cr√©er suggestion
      cardsHTML += createCard({
        id: 'create',
        icon: '‚ûï',
        title: 'Cr√©er une suggestion',
        subtitle: 'Propose une sortie',
        cssClass: 'card-create',
        disabled: !access.canCreate,
        planRequired: access.canCreate ? null : 'Meeting+',
        onClick: "navigate('create')"
      });
      
      // Card 2 : Map
      cardsHTML += createCard({
        id: 'map',
        icon: 'üó∫Ô∏è',
        title: 'D√©couvrir autour de moi',
        subtitle: 'Rejoins des MeeTempers',
        cssClass: 'card-map',
        badgeId: 'nearbyBadge',
        disabled: false, // Toujours accessible
        onClick: "navigate('map')"
      });
      
      // Card 3 : Mes demandes
      cardsHTML += createCard({
        id: 'requests',
        icon: 'üë•',
        title: 'Mes demandes',
        subtitle: `${requestsCount} en attente de r√©ponse`,
        cssClass: 'card-requests',
        badge: requestsCount > 0 ? requestsCount : null,
        badgeId: 'requestsBadge',
        disabled: !access.canViewRequests,
        planRequired: access.canViewRequests ? null : 'Meeting+',
        onClick: "navigate('requests')"
      });
      
      // Card 4 : Mes suggestions
      cardsHTML += createCard({
        id: 'suggestions',
        icon: 'üìÖ',
        title: 'Mes suggestions',
        subtitle: `${suggestionsCount} suggestion${suggestionsCount > 1 ? 's' : ''} active${suggestionsCount > 1 ? 's' : ''}`,
        cssClass: 'card-suggestions',
        badge: suggestionsCount > 0 ? suggestionsCount : null,
        badgeId: 'suggestionsBadge',
        disabled: false, // Toujours accessible
        onClick: "navigate('suggestions')"
      });
      
      // Card 5 : Messages
      cardsHTML += createCard({
        id: 'messages',
        icon: 'üí¨',
        title: 'Messages',
        subtitle: `${messagesCount} conversation${messagesCount > 1 ? 's' : ''} active${messagesCount > 1 ? 's' : ''}`,
        cssClass: 'card-messages',
        badge: messagesCount > 0 ? messagesCount : null,
        badgeId: 'messagesBadge',
        disabled: !access.canViewMessages,
        planRequired: access.canViewMessages ? null : 'Interaction requise',
        onClick: "navigate('messages')"
      });
      
      // Card 6 : Profil
      cardsHTML += createCard({
        id: 'profile',
        icon: '‚öôÔ∏è',
        title: 'Mon profil',
        subtitle: displayName,
        cssClass: 'card-profile',
        disabled: false,
        onClick: "navigate('profile')"
      });
      
      // Card 7 : Dashboard VIP (visible uniquement pour VIP)
      if (userPlan === 'vip') {
        cardsHTML += createCard({
          id: 'vip',
          icon: 'üëë',
          title: 'Espace VIP',
          subtitle: 'Points, r√©compenses, parrainage',
          cssClass: 'card-vip',
          disabled: false,
          onClick: "navigate('vip')"
        });
      }
      
      document.getElementById('cardsGrid').innerHTML = cardsHTML;
    }
    
    // ==========================================
    // üîê MATRICE D'ACC√àS PAR PLAN
    // ==========================================
    
    function getAccessByPlan(plan, hasInteraction) {
      const accessMatrix = {
        'free': {
          canCreate: false, // Limit√© √† 1 (g√©r√© backend)
          canViewRequests: hasInteraction,
          canViewMessages: hasInteraction,
          canViewMap: true,
          canViewSuggestions: true
        },
        'meeting': {
          canCreate: true,
          canViewRequests: true,
          canViewMessages: true,
          canViewMap: true,
          canViewSuggestions: true
        },
        'premium': {
          canCreate: true,
          canViewRequests: true,
          canViewMessages: true,
          canViewMap: true,
          canViewSuggestions: true
        },
        'vip': {
          canCreate: true,
          canViewRequests: true,
          canViewMessages: true,
          canViewMap: true,
          canViewSuggestions: true
        },
        'b2b': {
          canCreate: true,
          canViewRequests: true,
          canViewMessages: true,
          canViewMap: true,
          canViewSuggestions: true
        }
      };
      
      // Normaliser les plans B2B
if (plan && plan.startsWith('b2b')) {
  return accessMatrix['b2b'];
}
return accessMatrix[plan] || accessMatrix['free'];
    }
    
    // ==========================================
    // üÉè CR√âATION CARD HTML
    // ==========================================
    
    function createCard(options) {
      const {
        id, icon, title, subtitle, cssClass,
        badge, badgeId, disabled, planRequired, onClick
      } = options;
      
      const disabledClass = disabled ? 'disabled' : '';
      const badgeHtml = badge ? `<div class="badge" id="${badgeId || ''}">${badge}</div>` : 
                        (badgeId ? `<div class="badge hidden" id="${badgeId}">0</div>` : '');
      const lockHtml = disabled ? '<div class="card-lock">üîí</div>' : '';
      const planHtml = planRequired ? `<div class="plan-required">${planRequired}</div>` : '';
      const clickAttr = disabled ? '' : `onclick="${onClick}"`;
      
      return `
        <div class="card ${cssClass} ${disabledClass}" ${clickAttr}>
          <div class="card-overlay"></div>
          ${badgeHtml}
          ${lockHtml}
          ${planHtml}
          <div class="card-content">
            <div class="card-icon">${icon}</div>
            <div class="card-text">
              <div class="card-title">${title}</div>
              <div class="card-subtitle">${subtitle}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ==========================================
    // üîô BOUTON RETOUR CONTEXTUEL
    // ==========================================
    
    function updateBackButton() {
      const btnIcon = document.getElementById('backBtnIcon');
      const btnText = document.getElementById('backBtnText');
      
      if (isB2BAdmin) {
        btnIcon.textContent = 'üè¢';
        btnText.textContent = 'Dashboard B2B';
      } else {
        btnIcon.textContent = 'ü§ñ';
        btnText.textContent = 'Retour GPT';
      }
    }
    
    function handleBackAction() {
      if (isB2BAdmin) {
        window.location.href = `b2b-dashboard.html?session_token=${session_token}`;
      } else {
        backToGPT();
      }
    }
    
    function backToGPT() {
      const gptUrl = `https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19`;
      // Ouvrir GPT sans le token dans l'URL pour s√©curit√©
      window.location.href = gptUrl;
    }
    
    // ==========================================
// üìÖ PROCHAINE INTERACTION
// ==========================================

async function loadNextMeeting() {
  try {
    // Utiliser les donn√©es d√©j√† charg√©es dans userData (maestro/context)
    if (!userData) return;
    
    // Chercher dans feedbacks_list (suggestions r√©centes avec date)
    const feedbacksList = userData.pending?.feedbacks_list || [];
    
    // Pour l'instant, pas de donn√©es fiables sur les rencontres futures
    // Le bandeau reste cach√© par d√©faut
    // TODO: Cr√©er endpoint /suggestions/upcoming pour cette feature
    
    console.log('üìÖ Prochaine rencontre: feature en attente');
    
  } catch (err) {
    console.error('Erreur next meeting:', err);
  }
}
    
    // ==========================================
    // üó∫Ô∏è COMPTEUR NEARBY
    // ==========================================
    
    async function loadNearbyCount() {
      try {
        const profileResponse = await fetch(
          `${API_BASE}/profile?session_token=${session_token}`
        );
        
        if (!profileResponse.ok) throw new Error('Erreur profil');
        
        const profile = await profileResponse.json();
        
        const lat = profile.city_coords?.lat || profile.profile?.city_coords?.lat || 48.8566;
        const lng = profile.city_coords?.lng || profile.profile?.city_coords?.lng || 2.3522;
        
        const response = await fetch(
          `${API_BASE}/suggestions/nearby?session_token=${session_token}&lat=${lat}&lng=${lng}&radius=10`
        );
        
        if (!response.ok) throw new Error('Erreur nearby');
        
        const data = await response.json();
        const allSuggestions = data.results || [];
        
        // Filtrer hors Free
        const nonFreeSuggestions = allSuggestions.filter(s => {
          const creatorPlan = s.creator?.plan || 'free';
          return creatorPlan !== 'free';
        });
        
        const badge = document.getElementById('nearbyBadge');
        if (badge) {
          if (nonFreeSuggestions.length > 0) {
            badge.textContent = nonFreeSuggestions.length;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
        
      } catch (err) {
        console.error('‚ùå Erreur nearby count:', err);
      }
    }
    
    // ==========================================
    // üß≠ NAVIGATION
    // ==========================================
    
    function navigate(section) {
      const tokenParam = `session_token=${session_token}`;
      
      switch(section) {
        case 'create':
          // Pour cr√©er, on propose 2 options
          if (confirm('Comment voulez-vous cr√©er votre suggestion ?\n\nOK = Via GPT MeeTempo (recommand√©)\nAnnuler = Via formulaire simple')) {
            // Via GPT
            const gptUrl = `https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19`;
            window.location.href = gptUrl;
          } else {
            // Via formulaire simple (√† cr√©er si besoin)
            window.location.href = `create-suggestion.html?${tokenParam}`;
          }
          break;
          
        case 'map':
          window.location.href = `map.html?${tokenParam}`;
          break;
          
        case 'requests':
          window.location.href = `my-requests.html?${tokenParam}`;
          break;
          
        case 'suggestions':
          window.location.href = `my-suggestions.html?${tokenParam}`;
          break;
          
        case 'messages':
          window.location.href = `my-chats.html?${tokenParam}`;
          break;
          
        case 'profile':
          window.location.href = `profile.html?${tokenParam}`;
          break;
          
        case 'vip':
          window.location.href = `vip-dashboard.html?${tokenParam}`;
          break;
      }
    }
    
    // ==========================================
    // üö™ D√âCONNEXION
    // ==========================================
    
    function logout() {
      if (confirm('Voulez-vous vous d√©connecter ?')) {
        localStorage.removeItem('session_token');
        localStorage.removeItem('elevated_token');
        sessionStorage.clear();
        window.location.href = 'login.html';
      }
    }
    
    // ==========================================
    // üöÄ D√âMARRAGE
    // ==========================================
    
    loadUserData();
  </script>
</body>
</html>
