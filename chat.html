<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Chat Groupe - MeeTempo</title>
  
  <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               img-src https: data:; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; 
               font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; 
               connect-src https://api.meetempo.com;">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root {
      /* Palette Hub Premium */
      --mt-bg: #0f172a;
      --mt-accent: #f97316;
      --mt-text: #f8fafc;
      --mt-muted: #94a3b8;
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      --msg-me-bg: #f97316;
      --msg-me-text: #fff;
      --msg-other-bg: rgba(255, 255, 255, 0.1);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--mt-bg);
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      background-attachment: fixed;
      color: var(--mt-text);
      height: 100dvh;
      overflow: hidden;
      display: flex; flex-direction: column;
    }
    
    /* === HEADER (Glass) === */
    .chat-header {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      padding: 16px 20px;
      border-bottom: 1px solid var(--glass-border);
      display: flex; align-items: center; gap: 16px;
      z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .back-btn {
      background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
      border-radius: 50%; width: 40px; height: 40px; font-size: 16px;
      cursor: pointer; color: white; display: flex; align-items: center; justify-content: center;
      transition: 0.2s;
    }
    .back-btn:hover { background: var(--mt-accent); border-color: var(--mt-accent); }
    
    .chat-info { flex: 1; overflow: hidden; }
    .chat-title { font-size: 16px; font-weight: 700; margin-bottom: 2px; font-family: 'Montserrat', sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-subtitle { font-size: 12px; color: var(--mt-muted); display: flex; align-items: center; gap: 6px; }
    
    .participants-badge {
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      border-radius: 20px; padding: 6px 12px; font-size: 12px; font-weight: 600;
      color: var(--mt-muted); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .participants-badge:hover { background: rgba(255,255,255,0.1); color: white; }
    
    /* === MESSAGES === */
    .messages-container {
      flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px;
      display: flex; flex-direction: column; gap: 20px;
      scroll-behavior: smooth;
    }
    
    .message { display: flex; gap: 12px; max-width: 85%; animation: fadeInUp 0.3s ease; }
    .message.me { align-self: flex-end; flex-direction: row-reverse; }
    
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .message-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #a855f7);
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: 700; font-size: 14px; flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .message-content { display: flex; flex-direction: column; gap: 4px; }
    
    .message-header { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--mt-muted); margin-bottom: 2px; }
    .message.me .message-header { justify-content: flex-end; }
    
    .message-author { font-weight: 600; color: white; }
    .message-time { opacity: 0.7; }
    
    .message-bubble {
      padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5;
      position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Style Bulle "Autre" */
    .message:not(.me) .message-bubble {
      background: var(--msg-other-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-top-left-radius: 4px;
    }
    
    /* Style Bulle "Moi" */
    .message.me .message-bubble {
      background: var(--msg-me-bg); color: white;
      border-top-right-radius: 4px;
      box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
    }
    
    /* GPT Message Style */
    .message-gpt .message-bubble {
      border-left: 3px solid #10b981;
      background: rgba(16, 185, 129, 0.1);
    }
    
    /* === INPUT AREA (Floating Glass) === */
    .chat-input-container {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 95%; max-width: 800px; z-index: 100;
    }
    
    .chat-input-wrapper {
      display: flex; align-items: center; gap: 10px;
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 50px; padding: 8px 8px 8px 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    
    .chat-input {
      flex: 1; background: transparent; border: none; font-size: 15px;
      color: white; outline: none; font-family: 'Inter', sans-serif;
      padding: 8px 0;
    }
    .chat-input::placeholder { color: rgba(255,255,255,0.3); }
    
    .send-btn {
      background: var(--mt-accent); border: none; border-radius: 50%;
      width: 44px; height: 44px; font-size: 18px; color: white;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.2s; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
    }
    .send-btn:hover:not(:disabled) { transform: scale(1.05); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; background: var(--mt-muted); }
    
    .char-counter {
      position: absolute; right: 70px; bottom: 22px; font-size: 10px;
      color: var(--mt-muted); font-weight: 600; pointer-events: none;
    }
    
    /* New Messages Badge */
    .new-messages-badge {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: var(--mt-accent); color: white; padding: 8px 16px;
      border-radius: 20px; font-size: 13px; font-weight: 600;
      cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex; align-items: center; gap: 6px; z-index: 90;
      animation: bounce 1s infinite;
    }
    @keyframes bounce { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -5px); } }

    /* PARTICIPANTS PANEL */
    .participants-panel {
      position: fixed; top: 0; right: -100%; width: 100%; max-width: 320px; height: 100%;
      background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
      border-left: 1px solid var(--glass-border); z-index: 2000;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column;
    }
    .participants-panel.open { right: 0; }
    
    .panel-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
    .close-btn { background: rgba(255,255,255,0.1); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; color: white; }
    
    .panel-content { flex: 1; overflow-y: auto; padding: 16px; }
    .participant-item {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px;
      border: 1px solid transparent; transition: 0.2s;
    }
    .participant-item:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); }
    
    .participant-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #8b5cf6); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: white; }
    .participant-info { flex: 1; }
    .participant-name { font-size: 14px; font-weight: 600; color: white; }
    .participant-city { font-size: 12px; color: var(--mt-muted); }
    
    /* REVELATION BANNER */
    .revelation-banner {
      background: linear-gradient(90deg, rgba(249, 115, 22, 0.1), rgba(249, 115, 22, 0.05));
      border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 12px;
      padding: 16px; margin: 20px 0; text-align: center;
    }
    .revelation-text strong { color: var(--mt-accent); display: block; margin-bottom: 4px; font-size: 15px; }
    .revelation-text { font-size: 13px; color: var(--mt-muted); }

    /* LOADING */
    .loading { position: fixed; inset: 0; background: var(--mt-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--mt-accent); border-radius: 50%; animation: spin 0.8s infinite linear; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 640px) {
      .chat-header { padding: 12px 16px; }
      .message { max-width: 90%; }
      .chat-input-container { bottom: 10px; width: 95%; }
    }
  </style>
</head>
<body>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div style="margin-top:15px; color:#94a3b8; font-size:14px;">Chargement du chat...</div>
  </div>
  
  <div class="chat-header" id="chatHeader" style="display: none;">
    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    <div class="chat-info">
      <div class="chat-title" id="chatTitle">...</div>
      <div class="chat-subtitle" id="chatSubtitle"><i class="far fa-clock"></i> Chargement...</div>
    </div>
    <div class="participants-badge" id="participantsBadge" onclick="toggleParticipantsPanel()">
      <i class="fas fa-users"></i> 0
    </div>
    <button class="back-btn" onclick="goToHub()" title="Hub"><i class="fas fa-home"></i></button>
  </div>
  
  <div class="messages-container" id="messagesContainer" style="display: none;">
    </div>
  
  <div class="chat-input-container" id="chatInputContainer" style="display: none;">
    <div class="chat-input-wrapper">
      <input type="text" class="chat-input" id="messageInput" placeholder="√âcris un message..." maxlength="1000" oninput="updateCharCounter()">
      <span class="char-counter" id="charCounter"></span>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
  
  <div class="participants-panel" id="participantsPanel">
    <div class="panel-header">
      <h2>Participants</h2>
      <button class="close-btn" onclick="toggleParticipantsPanel()"><i class="fas fa-times"></i></button>
    </div>
    <div class="panel-content" id="participantsList"></div>
  </div>

  <script>
    // === BLOC UNIVERSEL TOKEN ===
    (function() {
      const params = new URLSearchParams(location.search);
      window.MT_TOKEN = params.get('session_token') || params.get('token') || params.get('t')
                       || localStorage.getItem('session_token') || sessionStorage.getItem('meetempo_token');
      if (window.MT_TOKEN) {
        localStorage.setItem('session_token', window.MT_TOKEN);
        sessionStorage.setItem('meetempo_token', window.MT_TOKEN);
      }
      if (!window.MT_TOKEN) {
        alert('‚ùå Session expir√©e.');
        window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
      }
    })();

    // === LOGIQUE M√âTIER ===
    const API_BASE = 'https://api.meetempo.com';
    const params = new URLSearchParams(location.search);
    const suggestion_id = params.get('suggestion_id');
    const session_token = window.MT_TOKEN;
    
    let currentUserId = null;
    let conversationData = null;
    let pollInterval = null;
    let eventHappened = false;
    let isActive = true;
    let isAtBottom = true;
    let userScrolled = false;
    let lastMessageCount = 0;
    
    if (!suggestion_id) alert('ID manquant');

    // SCROLL LOGIC
    function scrollToBottom(force = false) {
      const c = document.getElementById('messagesContainer');
      if (isAtBottom || force) c.scrollTop = c.scrollHeight;
    }
    
    function checkScrollPosition() {
      const c = document.getElementById('messagesContainer');
      const threshold = 100;
      const pos = c.scrollHeight - c.scrollTop - c.clientHeight;
      isAtBottom = pos < threshold;
      userScrolled = !isAtBottom;
      
      let badge = document.getElementById('newMessagesBadge');
      if (userScrolled && lastMessageCount < (conversationData?.messages?.length || 0)) {
        if (!badge) {
          badge = document.createElement('div');
          badge.id = 'newMessagesBadge';
          badge.className = 'new-messages-badge';
          badge.innerHTML = '<i class="fas fa-arrow-down"></i> Nouveaux messages';
          badge.onclick = () => { scrollToBottom(true); badge.remove(); };
          document.body.appendChild(badge);
        }
      } else if (badge) badge.remove();
    }

    // LOAD CONVERSATION
    async function loadConversation() {
      try {
        const res = await fetch(`${API_BASE}/chat/messages?session_token=${session_token}&suggestion_id=${suggestion_id}`);
        if (!res.ok) throw new Error('Erreur chargement');
        conversationData = await res.json();
        
        const me = conversationData.participants.find(p => p.is_me);
        if (me) currentUserId = me.id;
        
        eventHappened = conversationData.event_happened || false;
        isActive = conversationData.can_send_messages !== false;
        
        if(!isActive) {
            document.getElementById('messageInput').disabled = true;
            document.getElementById('messageInput').placeholder = "Chat archiv√© (Lecture seule)";
            document.getElementById('sendBtn').disabled = true;
        }

        // Render Header
        document.getElementById('chatTitle').textContent = conversationData.suggestion.activity_type || 'Chat';
        document.getElementById('chatSubtitle').textContent = `${conversationData.suggestion.city} ‚Ä¢ ${conversationData.suggestion.date}`;
        document.getElementById('participantsBadge').innerHTML = `<i class="fas fa-users"></i> ${conversationData.participants.length}`;
        
        // Render Content
        displayParticipants();
        displayMessages();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('chatHeader').style.display = 'flex';
        document.getElementById('messagesContainer').style.display = 'flex';
        document.getElementById('chatInputContainer').style.display = 'block';
        
        if (!pollInterval) startPolling();
        markAsRead();
        
      } catch (err) { console.error(err); alert('Erreur chargement'); }
    }

    function displayParticipants() {
      const container = document.getElementById('participantsList');
      container.innerHTML = conversationData.participants.map(p => {
        const name = eventHappened && p.name ? p.name : (p.initials || 'XX');
        const initials = p.initials || name.substring(0,2).toUpperCase();
        return `
          <div class="participant-item">
            <div class="participant-avatar">${initials}</div>
            <div class="participant-info">
              <div class="participant-name">${name} ${p.is_me ? '(Moi)' : ''}</div>
              <div class="participant-city">${p.is_creator ? 'üëë Cr√©ateur' : (p.city || 'Participant')}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function displayMessages() {
      const container = document.getElementById('messagesContainer');
      if (!conversationData.messages.length) {
        container.innerHTML = '<div style="text-align:center; color:#94a3b8; margin-top:50px;">D√©but de la conversation</div>';
        return;
      }
      
      let html = '';
      let bannerAdded = false;
      
      conversationData.messages.forEach(msg => {
        // Revelation Banner
        if (eventHappened && !bannerAdded) {
            const eventTime = new Date(conversationData.suggestion.date).getTime();
            if (msg.timestamp > eventTime) {
                html += `<div class="revelation-banner"><div class="revelation-text"><strong>üîì Identit√©s R√©v√©l√©es</strong>La rencontre a eu lieu !</div></div>`;
                bannerAdded = true;
            }
        }
      
        const isGPT = msg.type === 'gpt';
        const ownerId = isGPT ? msg.owner_user_id : msg.from_user;
        const isMe = ownerId === currentUserId;
        const p = conversationData.participants.find(p => p.id === ownerId) || {};
        
        const name = isMe ? 'Moi' : (eventHappened && p.name ? p.name : (p.initials || 'XX'));
        const initials = p.initials || 'XX';
        const time = new Date(msg.timestamp).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
        
        html += `
          <div class="message ${isMe ? 'me' : ''} ${isGPT ? 'message-gpt' : ''}">
            <div class="message-avatar">${initials}</div>
            <div class="message-content">
              <div class="message-header">
                <span class="message-author">${isGPT ? 'ü§ñ ' + name : name}</span>
                <span class="message-time">${time}</span>
              </div>
              <div class="message-bubble">${escapeHTML(msg.message)}</div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      scrollToBottom();
      
      container.removeEventListener('scroll', checkScrollPosition);
      container.addEventListener('scroll', checkScrollPosition);
      lastMessageCount = conversationData.messages.length;
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();
      if (!msg) return;
      
      input.disabled = true;
      try {
        await fetch(`${API_BASE}/chat/send`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ session_token, suggestion_id, message: msg })
        });
        input.value = '';
        updateCharCounter();
        await loadConversation();
      } catch (e) { console.error(e); }
      finally { input.disabled = false; input.focus(); }
    }

    function startPolling() {
      pollInterval = setInterval(async () => {
        try {
            const res = await fetch(`${API_BASE}/chat/messages?session_token=${session_token}&suggestion_id=${suggestion_id}`);
            if(res.ok) {
                const data = await res.json();
                if(data.messages.length > conversationData.messages.length) {
                    conversationData = data;
                    displayMessages();
                    if(isAtBottom) markAsRead();
                }
            }
        } catch(e){}
      }, 3000);
    }

    async function markAsRead() {
        try { await fetch(`${API_BASE}/chat/mark-read`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_token, suggestion_id}) }); } catch(e){}
    }

    function updateCharCounter() {
        const len = document.getElementById('messageInput').value.length;
        document.getElementById('charCounter').textContent = len > 0 ? `${len}/1000` : '';
        document.getElementById('sendBtn').disabled = len === 0;
    }

    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function toggleParticipantsPanel() {
        document.getElementById('participantsPanel').classList.toggle('open');
    }
    
    function goBack() { window.history.length > 1 ? window.history.back() : goToHub(); }
    function goToHub() { window.location.href = `hub.html?session_token=${session_token}`; }

    // Init
    document.getElementById('messageInput').addEventListener('keypress', e => { if(e.key==='Enter') sendMessage(); });
    window.addEventListener('beforeunload', () => clearInterval(pollInterval));
    loadConversation();
  </script>
</body>
</html>
