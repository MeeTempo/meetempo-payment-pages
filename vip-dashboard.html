<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Espace VIP - MeeTempo</title>
    
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        mt: {
                            dark: '#030E4F',    // Ton bleu nuit
                            bg: '#0a133f',      // Ton fond
                            accent: '#F49F1C',  // Ton orange/or
                            muted: '#c9d1ff',   // Ton texte gris/bleu
                            card: 'rgba(255, 255, 255, 0.08)',
                            border: 'rgba(255, 255, 255, 0.12)'
                        }
                    },
                    backgroundImage: {
                        'vip-gradient': 'linear-gradient(160deg, #030E4F 0%, #0a133f 100%)',
                        'gold-gradient': 'linear-gradient(135deg, #F49F1C 0%, #FFD700 100%)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Styles spÃ©cifiques pour l'ambiance VIP */
        body {
            background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
            color: white;
            /* Padding pour la bottom nav */
            padding-bottom: 80px; 
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Animation Pulse Gold */
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(244, 159, 28, 0.2); }
            50% { box-shadow: 0 0 20px rgba(244, 159, 28, 0.6); }
        }
        .animate-glow {
            animation: glow 3s infinite;
        }

        /* Masquer scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="min-h-screen font-sans">

    <header class="relative p-6 pb-12 rounded-b-3xl bg-mt-dark overflow-hidden border-b border-mt-border">
        <div class="absolute top-0 right-0 w-64 h-64 bg-mt-accent opacity-5 rounded-full -mr-20 -mt-20 blur-3xl"></div>

        <div class="relative z-10">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-crown text-mt-accent text-xl"></i>
                        <span class="text-xs font-bold tracking-widest text-mt-accent uppercase">Espace Membre</span>
                    </div>
                    <h1 class="text-2xl font-bold text-white">Mon Cockpit VIP</h1>
                    <p class="text-mt-muted text-sm" id="user-name">Chargement...</p>
                </div>
                <div class="glass-panel px-3 py-1 rounded-full border-mt-accent/30">
                    <span class="text-xs font-bold text-mt-accent" id="vip-level">GOLD</span>
                </div>
            </div>

            <div class="bg-black/20 rounded-xl p-4 border border-white/5">
                <div class="flex justify-between text-xs mb-2 text-mt-muted">
                    <span>Score VIP</span>
                    <span class="text-mt-accent font-bold" id="vip-score-text">0/100</span>
                </div>
                <div class="w-full bg-white/10 rounded-full h-2 overflow-hidden">
                    <div id="vip-score-bar" class="bg-gradient-to-r from-mt-accent to-yellow-300 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-[10px] text-right text-gray-400">Prochain palier : Platinum (900 pts)</div>
            </div>
        </div>
    </header>

    <main class="px-4 -mt-6 relative z-20 space-y-5">

        <div class="grid grid-cols-2 gap-3">
            <div class="glass-panel p-4 rounded-2xl relative overflow-hidden group animate-glow border-mt-accent/20">
                <div class="absolute -right-2 -top-2 text-4xl opacity-10 text-mt-accent">ðŸŽ®</div>
                <div class="text-mt-muted text-xs mb-1">Points FidÃ©litÃ©</div>
                <div class="text-2xl font-bold text-white" id="points-total">...</div>
                <div class="text-[10px] text-green-400 mt-1 font-bold">+50 = Cadeau !</div>
            </div>
            
            <div class="glass-panel p-4 rounded-2xl relative overflow-hidden">
                <div class="absolute -right-2 -top-2 text-4xl opacity-10 text-white">ðŸ‘¥</div>
                <div class="text-mt-muted text-xs mb-1">Filleuls Actifs</div>
                <div class="text-2xl font-bold text-white" id="referral-count">...</div>
                <div class="text-[10px] text-mt-accent mt-1 font-bold" id="referral-gains">0 pts gagnÃ©s</div>
            </div>
        </div>

        <section>
            <h2 class="text-sm font-bold text-mt-muted mb-3 uppercase tracking-wider flex items-center">
                <i class="fas fa-gift mr-2"></i> RÃ©compenses
            </h2>
            <div class="space-y-3" id="rewards-list">
                <div class="text-center py-4">
                    <div class="inline-block w-6 h-6 border-2 border-mt-accent border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>
        </section>

        <section class="glass-panel p-5 rounded-2xl border-mt-accent/20">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm font-bold text-white">Mon Lien Unique</h2>
                <i class="fas fa-share-alt text-mt-accent"></i>
            </div>
            
            <div class="flex gap-2 mb-3">
                <input type="text" id="referral-link" readonly 
                    class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-3 text-xs text-gray-300 font-mono focus:outline-none focus:border-mt-accent"
                    value="...">
                <button onclick="copyLink()" class="bg-mt-accent text-black font-bold px-4 rounded-lg text-xs hover:bg-yellow-400 transition">
                    COPIER
                </button>
            </div>
            
            <div class="bg-mt-accent/10 border border-mt-accent/20 p-3 rounded-lg">
                <p class="text-xs text-mt-muted">
                    ðŸ’¡ Gagnez <strong class="text-mt-accent">30 points</strong> pour chaque ami qui rejoint MeeTempo avec votre lien !
                </p>
            </div>
        </section>

        <section id="b2b-section" class="hidden">
            <div class="bg-gradient-to-br from-indigo-900 to-blue-900 rounded-2xl p-5 border border-indigo-500/30 shadow-lg relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-white text-lg">Espace Entreprise</h3>
                        <span class="bg-white text-indigo-900 text-[10px] font-bold px-2 py-1 rounded">DIRIGEANT</span>
                    </div>
                    <p class="text-xs text-indigo-100 mb-4 leading-relaxed">
                        Connectez vos collÃ¨gues. Si 5 personnes rejoignent, vous obtenez le <strong>VIP gratuit</strong> pour toute l'Ã©quipe.
                    </p>
                    <button onclick="goToB2B()" class="w-full bg-white text-indigo-900 py-3 rounded-xl font-bold text-sm hover:bg-gray-50 transition shadow-lg">
                        GÃ©rer mon Ã©quipe
                    </button>
                </div>
            </div>
        </section>

        <div class="h-8"></div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-[#030E4F]/90 backdrop-blur-lg border-t border-white/10 pb-safe z-50 pb-2">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="goToMap()" class="flex flex-col items-center justify-center w-16 h-full text-gray-400 hover:text-white transition">
                <i class="fas fa-map text-lg mb-1"></i>
                <span class="text-[10px]">Carte</span>
            </button>
            
            <button onclick="goToRequests()" class="flex flex-col items-center justify-center w-16 h-full text-gray-400 hover:text-white transition">
                <i class="fas fa-inbox text-lg mb-1"></i>
                <span class="text-[10px]">Demandes</span>
            </button>

            <button onclick="createNew()" class="relative -top-6 bg-mt-accent text-mt-dark w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/20 border-4 border-[#030E4F] transform transition active:scale-95">
                <i class="fas fa-plus text-xl"></i>
            </button>

            <button onclick="goToSuggestions()" class="flex flex-col items-center justify-center w-16 h-full text-gray-400 hover:text-white transition">
                <i class="fas fa-list text-lg mb-1"></i>
                <span class="text-[10px]">ActivitÃ©s</span>
            </button>

            <button class="flex flex-col items-center justify-center w-16 h-full text-mt-accent">
                <i class="fas fa-crown text-lg mb-1"></i>
                <span class="text-[10px] font-bold">VIP</span>
            </button>
        </div>
    </nav>

    <script>
        const API_BASE = 'https://api.meetempo.com';
        
        // --- 1. INITIALISATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // RÃ©cupÃ©ration Token (PrioritÃ© URL > SessionStorage)
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('session_token') || urlParams.get('token');
            
            if (!token) {
                token = sessionStorage.getItem('meetempo_token');
            }

            if (!token) {
                window.location.href = 'login.html'; // Fallback sÃ©curitÃ©
                return;
            }

            // Sauvegarde fraÃ®che
            sessionStorage.setItem('meetempo_token', token);
            console.log('ðŸ”‘ VIP Dashboard initialized with token');

            // Chargement DonnÃ©es
            await loadVipData(token);
        });

        // --- 2. CHARGEMENT DONNÃ‰ES ---
        async function loadVipData(token) {
            try {
                // On utilise l'endpoint MAESTRO qui contient tout le contexte (Profile + Gamification + Status)
                // Si Maestro n'est pas dispo, on fallback sur /profile + /gamification
                
                // Pour l'instant, simulation des appels basiques existants
                const profileRes = await fetch(`${API_BASE}/profile?session_token=${token}`);
                
                if (!profileRes.ok) throw new Error('Session expirÃ©e');
                
                const profile = await profileRes.json();
                
                // TODO: Remplacer par vrai endpoint gamification quand dispo
                // Mock des donnÃ©es gamification en attendant l'implÃ©mentation backend complÃ¨te
                const gamification = {
                    points: profile.points || 0, // Supposant que le profil renvoie les points
                    referral_code: profile.referral_code || `VIP-${profile.first_name}-${new Date().getFullYear()}`,
                    referral_count: profile.referral_count || 0
                };

                renderDashboard(profile, gamification);

            } catch (err) {
                console.error('Erreur chargement:', err);
                // Mode dÃ©gradÃ© / Mock pour dÃ©mo si API fail
                renderDashboard(
                    { first_name: 'Membre', vip_score: 0, job_level: 'user' },
                    { points: 0, referral_code: '...', referral_count: 0 }
                );
            }
        }

        // --- 3. RENDU GRAPHIQUE ---
        function renderDashboard(user, game) {
            // Header
            document.getElementById('user-name').textContent = `Bonjour, ${user.first_name}`;
            
            // Score (Simulation calcul score)
            const score = user.vip_score || 50; 
            document.getElementById('vip-score-text').textContent = `${score}/100`;
            document.getElementById('vip-score-bar').style.width = `${score}%`;

            // Stats
            document.getElementById('points-total').textContent = game.points;
            document.getElementById('referral-count').textContent = game.referral_count;
            document.getElementById('referral-gains').textContent = `${game.referral_count * 30} pts gagnÃ©s`;

            // Lien
            const link = `https://meetempo.com/?ref=${game.referral_code}`;
            document.getElementById('referral-link').value = link;

            // Section B2B
            if (user.job_level === 'dirigeant' || user.job_level === 'cadre' || user.plan === 'b2b') {
                document.getElementById('b2b-section').classList.remove('hidden');
            }

            // RÃ©compenses (Statique pour l'instant, dynamique bientÃ´t)
            renderRewards(game.points);
        }

        function renderRewards(points) {
            const rewards = [
                { cost: 500, title: "Badge Ambassadeur", icon: "ðŸ†" },
                { cost: 1000, title: "1 mois VIP offert", icon: "ðŸŽ" },
                { cost: 2000, title: "AccÃ¨s VTC Prioritaire", icon: "ðŸš—" }
            ];

            const container = document.getElementById('rewards-list');
            container.innerHTML = rewards.map(r => {
                const unlocked = points >= r.cost;
                const btnClass = unlocked 
                    ? 'bg-mt-accent text-black animate-pulse' 
                    : 'bg-white/10 text-gray-500 cursor-not-allowed';
                const btnText = unlocked ? 'RÃ‰CLAMER' : `<i class="fas fa-lock"></i> ${r.cost}`;

                return `
                <div class="glass-panel p-3 rounded-xl flex items-center gap-3 ${!unlocked ? 'opacity-60' : 'border-mt-accent/50'}">
                    <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-xl">
                        ${r.icon}
                    </div>
                    <div class="flex-1">
                        <h3 class="text-sm font-bold text-white">${r.title}</h3>
                        <div class="w-full bg-gray-700 h-1 rounded-full mt-1 overflow-hidden">
                            <div class="bg-mt-accent h-1 rounded-full" style="width: ${Math.min(100, (points/r.cost)*100)}%"></div>
                        </div>
                    </div>
                    <button class="text-[10px] font-bold px-3 py-1.5 rounded-lg ${btnClass}" ${!unlocked ? 'disabled' : ''}>
                        ${btnText}
                    </button>
                </div>`;
            }).join('');
        }

        // --- 4. FONCTIONS NAVIGATION (Critique) ---
        
        // Copier lien
        function copyLink() {
            const input = document.getElementById('referral-link');
            input.select();
            input.setSelectionRange(0, 99999); // Mobile
            navigator.clipboard.writeText(input.value);
            
            const btn = document.querySelector('button[onclick="copyLink()"]');
            const original = btn.innerText;
            btn.innerText = "OK !";
            btn.classList.add('bg-green-500', 'text-white');
            setTimeout(() => {
                btn.innerText = original;
                btn.classList.remove('bg-green-500', 'text-white');
            }, 2000);
        }

        function getToken() {
            return sessionStorage.getItem('meetempo_token');
        }

        // Navigation Simple
        function goToRequests() {
            window.location.href = `my-requests.html?session_token=${getToken()}`;
        }

        function goToSuggestions() {
            window.location.href = `my-suggestions.html?session_token=${getToken()}`;
        }

        function createNew() {
            window.location.href = `create-suggestion.html?token=${getToken()}`;
        }

        function goToB2B() {
            window.location.href = `b2b-dashboard.html?session_token=${getToken()}`;
        }

        // ðŸ”¥ NAVIGATION CARTE (Ã‰LÃ‰VATION REQUISE)
        async function goToMap() {
            const token = getToken();
            if (!token) return;

            try {
                // On change l'icÃ´ne pour montrer le chargement
                const btn = document.querySelector('button[onclick="goToMap()"] i');
                const originalClass = btn.className;
                btn.className = 'fas fa-circle-notch fa-spin text-lg mb-1';

                const response = await fetch(`${API_BASE}/auth/elevate-session?session_token=${token}`);
                
                if (!response.ok) throw new Error('Session invalide');
                
                const data = await response.json();
                
                // Redirection avec token court
                window.location.href = `map.html?token=${data.token}`;

            } catch (err) {
                console.error('Erreur map:', err);
                alert('Impossible d\'ouvrir la carte. Veuillez revenir au GPT.');
                window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
            }
        }
    </script>
</body>
</html>
