<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MeeTempo VIP Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'] },
                    colors: {
                        gold: {
                            light: '#FDE047',
                            DEFAULT: '#F59E0B',
                            dark: '#B45309',
                        },
                        deep: {
                            bg: '#0f172a',
                            card: '#1e293b'
                        }
                    },
                    animation: {
                        'shine': 'shine 3s infinite linear',
                        'float': 'float 6s ease-in-out infinite',
                        'slideUp': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        shine: {
                            '0%': { backgroundPosition: '200% center' },
                            '100%': { backgroundPosition: '-200% center' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: radial-gradient(circle at 50% 0%, #4a3812 0%, #0f172a 60%, #020617 100%);
            color: white;
            padding-bottom: 90px;
        }

        .text-gradient-gold {
            background: linear-gradient(to right, #FDE047, #F59E0B, #FDE047);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shine 4s linear infinite;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 215, 0, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .vip-pass-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border: 1px solid rgba(253, 224, 71, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .vip-pass-card::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(253, 224, 71, 0.1) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .progress-glow {
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .fade-in {
            animation: slideUp 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[9999] flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-crown text-6xl text-yellow-400 animate-pulse mb-4"></i>
            <p class="text-white font-bold text-lg">Chargement VIP...</p>
            <div class="mt-4 flex gap-2 justify-center">
                <div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <div class="p-4 pt-6">
            <div class="vip-pass-card rounded-2xl p-6 shadow-2xl animate-float relative fade-in">
                <div class="absolute top-0 right-0 w-32 h-32 bg-yellow-500 opacity-20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-8">
                        <div class="bg-black/30 backdrop-blur-md px-3 py-1 rounded-full border border-yellow-500/30">
                            <span class="text-xs font-bold text-yellow-400 tracking-widest uppercase">MeeTempo VIP</span>
                        </div>
                        <i class="fas fa-crown text-3xl text-gradient-gold drop-shadow-lg"></i>
                    </div>

                    <div class="mb-1">
                        <h1 class="text-2xl font-black tracking-wide text-white uppercase" id="user-name">...</h1>
                        <div class="text-xs text-yellow-200/70 font-mono tracking-widest" id="member-since">MEMBER SINCE 2025</div>
                    </div>
                </div>
            </div>
        </div>

        <main class="px-4 space-y-6">
            <!-- XP Progress -->
            <div class="text-center -mt-2 fade-in" style="animation-delay: 0.1s">
                <div class="inline-flex items-center gap-2 mb-2">
                    <span class="text-sm font-bold text-gray-400">Niveau Actuel</span>
                    <span class="text-xl font-black text-yellow-400" id="level-badge">GOLD</span>
                </div>
                
                <div class="relative h-6 bg-gray-800 rounded-full border border-gray-700 shadow-inner overflow-hidden">
                    <div class="absolute inset-0 opacity-20" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #000 10px, #000 20px);"></div>
                    <div id="xp-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-yellow-600 via-yellow-400 to-yellow-200 progress-glow transition-all duration-1000" style="width: 0%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-black z-10">
                        <span id="xp-text">0 / 1000 XP</span>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Plus que <span class="text-white font-bold" id="xp-needed">...</span> XP pour le niveau Platinum üíé</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-4 fade-in" style="animation-delay: 0.2s">
                <div class="glass-card p-4 rounded-xl text-center relative overflow-hidden group cursor-pointer transition hover:scale-[1.02]">
                    <div class="absolute inset-0 bg-gradient-to-b from-yellow-500/10 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                    <div class="text-3xl mb-1">ü™ô</div>
                    <div class="text-2xl font-black text-white" id="points-total">
                        <div class="skeleton h-8 w-16 mx-auto rounded"></div>
                    </div>
                    <div class="text-[10px] uppercase tracking-wider text-yellow-500 font-bold">MeeCoins</div>
                </div>

                <div class="glass-card p-4 rounded-xl text-center relative overflow-hidden group cursor-pointer transition hover:scale-[1.02]">
                    <div class="absolute inset-0 bg-gradient-to-b from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                    <div class="text-3xl mb-1">üë•</div>
                    <div class="text-2xl font-black text-white" id="referral-count">
                        <div class="skeleton h-8 w-16 mx-auto rounded"></div>
                    </div>
                    <div class="text-[10px] uppercase tracking-wider text-blue-400 font-bold">Filleuls</div>
                </div>
            </div>

            <!-- Referral Card -->
            <div class="glass-card p-1 rounded-2xl fade-in" style="animation-delay: 0.3s">
                <div class="bg-black/20 rounded-xl p-5 border border-white/5">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center shadow-lg border border-white/20">
                            <i class="fas fa-rocket text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-sm">Mission Parrainage</h3>
                            <p class="text-[10px] text-gray-400">Invitez des amis, gagnez du VIP.</p>
                        </div>
                    </div>

                    <div class="relative mb-3 group">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-yellow-600 to-purple-600 rounded-lg blur opacity-30 group-hover:opacity-75 transition duration-1000"></div>
                        <div class="relative flex">
                            <input type="text" id="referral-link" readonly 
                                class="w-full bg-gray-900 text-gray-300 text-xs p-3 rounded-l-lg border border-gray-700 focus:outline-none font-mono"
                                value="Chargement...">
                            <button onclick="copyLink()" class="bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-bold px-4 rounded-r-lg text-xs hover:brightness-110 transition">
                                COPIER
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center text-[10px] text-gray-400 px-1">
                        <span>R√©compense :</span>
                        <span class="text-yellow-400 font-bold">+30 XP par ami</span>
                    </div>
                </div>
            </div>

            <!-- Rewards Section -->
            <div class="fade-in" style="animation-delay: 0.4s">
                <h2 class="text-lg font-black text-white mb-4 flex items-center">
                    <i class="fas fa-gift text-purple-400 mr-2"></i> R√âCOMPENSES
                </h2>
                <div class="space-y-3" id="rewards-list">
                    <!-- Skeleton Loaders -->
                    <div class="skeleton glass-card p-4 rounded-xl h-20"></div>
                    <div class="skeleton glass-card p-4 rounded-xl h-20"></div>
                    <div class="skeleton glass-card p-4 rounded-xl h-20"></div>
                </div>
            </div>

            <!-- Profils Retenus Section (Pense-b√™tes VIP) -->
            <div class="fade-in" style="animation-delay: 0.45s" id="saved-profiles-section">
                <h2 class="text-lg font-black text-white mb-4 flex items-center">
                    <i class="fas fa-star text-yellow-400 mr-2"></i> PROFILS RETENUS
                </h2>
                
                <!-- Stats rapides -->
                <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center">
                        <div class="text-center flex-1">
                            <div class="text-2xl font-black text-white" id="profiles-total">0</div>
                            <div class="text-[10px] text-gray-400 uppercase">Total</div>
                        </div>
                        <div class="w-px h-10 bg-white/10"></div>
                        <div class="text-center flex-1">
                            <div class="text-2xl font-black text-yellow-400" id="profiles-pending">0</div>
                            <div class="text-[10px] text-gray-400 uppercase">√Ä suivre</div>
                        </div>
                    </div>
                </div>

                <!-- Liste des profils -->
                <div class="space-y-3" id="saved-profiles-list">
                    <!-- Skeleton ou contenu -->
                    <div class="skeleton glass-card p-4 rounded-xl h-24"></div>
                </div>

                <!-- Message si vide -->
                <div id="profiles-empty" class="glass-card p-6 rounded-xl text-center" style="display: none;">
                    <div class="text-4xl mb-3">‚≠ê</div>
                    <h3 class="font-bold text-white mb-2">Aucun profil retenu</h3>
                    <p class="text-xs text-gray-400">
                        Apr√®s vos rencontres MeeTempo, marquez les profils int√©ressants pour les retrouver ici.
                    </p>
                </div>

                <!-- Tip upsell B2B -->
                <div class="glass-card p-4 rounded-xl mt-4 border border-purple-500/30" id="b2b-upsell-tip">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">üí°</div>
                        <div class="flex-1">
                            <p class="text-xs text-gray-300 mb-2">
                                <strong class="text-white">Vous recrutez r√©guli√®rement ?</strong><br>
                                Cr√©ez votre compte Entreprise pour partager automatiquement vos recommandations avec vos RH.
                            </p>
                            <button onclick="openB2BForm()" class="text-xs bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 border border-purple-500/30 px-3 py-1.5 rounded-lg transition">
                                En savoir plus ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B2B Section (Hidden by default) -->
            <div id="b2b-section" class="hidden fade-in" style="animation-delay: 0.5s">
                <div class="relative rounded-2xl overflow-hidden p-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500">
                    <div class="bg-gray-900 rounded-xl p-5 relative h-full">
                        <div class="absolute top-0 right-0 bg-white text-black text-[10px] font-bold px-2 py-1 rounded-bl-lg">BOSS MODE</div>
                        <h3 class="font-bold text-white mb-1">Dirigeant ?</h3>
                        <p class="text-xs text-gray-400 mb-3">Connectez votre √©quipe : d√©bloquez 4 mois offerts ou <span class="text-yellow-400 font-bold">-50% pendant 1 an</span>.</p>
                        <button onclick="openB2BForm()" class="w-full bg-white/10 hover:bg-white/20 text-white border border-white/20 py-2 rounded-lg text-xs font-bold transition">
                            ACTIVER MODE ENTREPRISE
                        </button>
                    </div>
                </div>
            </div>
                    <!-- Modal B2B Form -->
            <div id="b2b-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-4">
                <div class="bg-deep-card rounded-2xl p-6 max-w-md w-full border border-yellow-500/30 animate-slideUp">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-xl font-black text-white mb-1">Mode Entreprise</h2>
                            <p class="text-xs text-gray-400">Remplissez ce formulaire, on vous recontacte sous 24h</p>
                        </div>
                        <button onclick="closeB2BForm()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <form id="b2b-form" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">Nom de l'entreprise *</label>
                            <input type="text" name="company" required 
                                class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-700 focus:border-yellow-500 focus:outline-none text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">Votre fonction *</label>
                            <select name="job_level" required 
                                class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-700 focus:border-yellow-500 focus:outline-none text-sm">
                                <option value="">-- S√©lectionnez --</option>
                                <option value="dirigeant">Dirigeant / CEO</option>
                                <option value="cadre">Cadre sup√©rieur</option>
                                <option value="manager">Manager / Chef d'√©quipe</option>
                                <option value="rh">RH / DRH</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">Email professionnel *</label>
                            <input type="email" name="email" required 
                                placeholder="vous@entreprise.com"
                                class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-700 focus:border-yellow-500 focus:outline-none text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">Taille de l'√©quipe *</label>
                            <select name="team_size" required 
                                class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-700 focus:border-yellow-500 focus:outline-none text-sm">
                                <option value="">-- S√©lectionnez --</option>
                                <option value="1-10">1 √† 10 salari√©s</option>
                                <option value="11-30">11 √† 30 salari√©s</option>
                                <option value="31-100">31 √† 100 salari√©s</option>
                                <option value="100+">Plus de 100 salari√©s</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">T√©l√©phone (optionnel)</label>
                            <input type="tel" name="phone" 
                                class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-700 focus:border-yellow-500 focus:outline-none text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">Message / Besoins (optionnel)</label>
                            <textarea name="message" rows="3" 
                                class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-700 focus:border-yellow-500 focus:outline-none text-sm resize-none"></textarea>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-bold py-3 rounded-lg hover:brightness-110 transition">
                            ENVOYER MA DEMANDE
                        </button>

                        <p class="text-[10px] text-gray-500 text-center">
                            Nous vous recontactons sous 24h pour activer votre offre B2B
                        </p>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-4 left-4 right-4 bg-[#0f172a]/80 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl z-50 h-16 flex items-center justify-around px-2">
        <button onclick="goToMap()" class="flex flex-col items-center justify-center w-12 text-gray-400 hover:text-white transition">
            <i class="fas fa-map text-lg mb-1"></i>
            <span class="text-[9px]">Map</span>
        </button>
        
        <button onclick="goToRequests()" class="flex flex-col items-center justify-center w-12 text-gray-400 hover:text-white transition">
            <i class="fas fa-inbox text-lg mb-1"></i>
            <span class="text-[9px]">Inbox</span>
        </button>

        <button onclick="createNew()" class="relative -top-6">
            <div class="absolute inset-0 bg-yellow-500 rounded-full blur opacity-40 animate-pulse"></div>
            <div class="relative bg-gradient-to-br from-yellow-400 to-orange-500 w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4 border-[#0f172a] text-black transform transition active:scale-95">
                <i class="fas fa-plus text-xl"></i>
            </div>
        </button>

        <button onclick="goToSuggestions()" class="flex flex-col items-center justify-center w-12 text-gray-400 hover:text-white transition">
            <i class="fas fa-list text-lg mb-1"></i>
            <span class="text-[9px]">Listes</span>
        </button>

        <button class="flex flex-col items-center justify-center w-12">
            <i class="fas fa-crown text-lg mb-1 text-yellow-400 drop-shadow-[0_0_5px_rgba(250,204,21,0.8)]"></i>
            <span class="text-[9px] font-bold text-yellow-400">VIP</span>
        </button>
    </nav>

    <script>
        const API_BASE = 'https://api.meetempo.com';
        
        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('session_token') || urlParams.get('token') || sessionStorage.getItem('meetempo_token');
            
            if (!token) {
                window.location.href = 'login.html?error=no_session';
                return;
            }
            
            // Validate token first
            if (!(await validateToken(token))) {
                return; // Redirect handled in validateToken
            }
            
            sessionStorage.setItem('meetempo_token', token);
            
            // Load all VIP data
            await loadVipData(token);
        });

        // ========================================
        // TOKEN VALIDATION
        // ========================================
        async function validateToken(token) {
            try {
                const res = await fetch(`${API_BASE}/auth/check-session?session_token=${token}`);
                
                if (!res.ok) {
                    throw new Error('Token invalide');
                }
                
                return true;
            } catch (err) {
                console.error('Token validation failed:', err);
                sessionStorage.removeItem('meetempo_token');
                window.location.href = 'login.html?error=session_expired';
                return false;
            }
        }

        // ========================================
        // MAIN DATA LOADING
        // ========================================
        async function loadVipData(token) {
            try {
                // Fetch all data in parallel
                const [profileRes, gamifRes, refRes] = await Promise.all([
                    fetch(`${API_BASE}/profile?session_token=${token}`),
                    fetch(`${API_BASE}/gamification/points?session_token=${token}`),
                    fetch(`${API_BASE}/referral/status?session_token=${token}`)
                ]);

                if (!profileRes.ok || !gamifRes.ok || !refRes.ok) {
                    throw new Error('API Error');
                }

                const profile = await profileRes.json();
                const gamif = await gamifRes.json();
                const referral = await refRes.json();

                // Merge data
                const userData = {
                    ...profile,
                    points: gamif.current_points || 0,
                    achievements: gamif.achievements || [],
                    next_palier: gamif.next_palier || { level: 1, points: 1000 },
                    referral_count: referral.stats?.active_referred || 0,
                    referral_code: referral.referrals?.[0]?.code || 'VIP-NEW',
                    rewards: gamif.all_paliers || []
                };

                // Render dashboard
                renderDashboard(userData, token);

                // Load saved profiles (pense-b√™tes VIP)
                loadSavedProfiles(token);

                // Hide loading, show content
                hideLoading();

            } catch (err) {
                console.error('Load VIP data error:', err);
                showError('Impossible de charger vos donn√©es VIP. Veuillez r√©essayer.');
                
                // Render fallback data
                renderDashboard({
                    first_name: 'Utilisateur',
                    plan: 'vip',
                    vip_score: 0,
                    points: 0,
                    referral_count: 0,
                    referral_code: 'ERROR',
                    next_palier: { level: 1, points: 1000, points_needed: 1000 },
                    rewards: [],
                    job_level: null
                }, token);
                
                hideLoading();
            }
        }

        // ========================================
        // UI RENDERING
        // ========================================
        function renderDashboard(user, token) {
            // User Info
            document.getElementById('user-name').textContent = (user.first_name || 'VIP').toUpperCase();
            document.getElementById('member-since').textContent = `MEMBER SINCE ${new Date().getFullYear()}`;

            // XP Bar
            const currentPoints = user.points || 0;
            const nextPalier = user.next_palier || { points: 1000 };
            const progress = Math.min(100, (currentPoints / nextPalier.points) * 100);
            
            document.getElementById('xp-text').textContent = `${currentPoints} / ${nextPalier.points} XP`;
            document.getElementById('xp-needed').textContent = Math.max(0, nextPalier.points - currentPoints);
            
            setTimeout(() => {
                document.getElementById('xp-bar').style.width = `${progress}%`;
            }, 500);

            // Level Badge
            let level = 'BRONZE';
            if (currentPoints >= 5000) level = 'PLATINUM';
            else if (currentPoints >= 2000) level = 'GOLD';
            else if (currentPoints >= 1000) level = 'SILVER';
            document.getElementById('level-badge').textContent = level;

            // Stats
            document.getElementById('points-total').textContent = currentPoints;
            document.getElementById('referral-count').textContent = user.referral_count || 0;

            // Referral Link
            const referralUrl = `https://meetempo.github.io/meetempo-payment-pages/login.html?ref=${user.referral_code}`;
            document.getElementById('referral-link').value = referralUrl;

            // B2B Section - Visible pour tous les VIP
            if (user.plan === 'vip') {
                document.getElementById('b2b-section').classList.remove('hidden');
            }

            // Rewards
            renderRewards(user.rewards || [], currentPoints, token);
        }

        function renderRewards(paliers, userPoints, token) {
            const defaultRewards = [
                { level: 1, points: 1000, reward: '1 mois VIP offert' },
                { level: 2, points: 2000, reward: '3 mois VIP offerts' },
                { level: 3, points: 5000, reward: 'Statut Ambassadeur' }
            ];

            const rewards = paliers.length > 0 ? paliers : defaultRewards;

            const container = document.getElementById('rewards-list');
            container.innerHTML = rewards.map(r => {
                const unlocked = userPoints >= r.points;
                const progressPercent = Math.min(100, (userPoints / r.points) * 100);
                
                const icons = {
                    1: 'üéÅ',
                    2: 'üíé',
                    3: 'üéñÔ∏è'
                };
                const icon = icons[r.level] || 'üèÜ';

                return `
                <div class="glass-card p-3 rounded-xl flex items-center gap-4 ${unlocked ? 'border-yellow-500/50 bg-yellow-500/5' : 'opacity-60'} transition hover:scale-[1.01]">
                    <div class="w-12 h-12 rounded-lg bg-black/40 flex items-center justify-center text-2xl border border-white/10 shadow-inner ${unlocked ? 'animate-pulse' : ''}">
                        ${icon}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="text-sm font-bold text-white">${r.reward}</h3>
                            <span class="text-[10px] font-mono text-gray-400">${r.points} XP</span>
                        </div>
                        <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-${unlocked ? 'green-500' : 'gray-600'} h-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    ${unlocked 
                        ? `<button onclick="claimReward('palier_${r.points}', '${token}')" class="bg-yellow-500 text-black text-[10px] font-bold px-3 py-1 rounded shadow-lg hover:bg-yellow-400 transition">R√âCUP</button>` 
                        : `<i class="fas fa-lock text-gray-500"></i>`}
                </div>`;
            }).join('');
        }

        // ========================================
        // REWARD CLAIMING
        // ========================================
        async function claimReward(rewardId, token) {
            try {
                const res = await fetch(`${API_BASE}/gamification/reward/claim`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_token: token,
                        reward_id: rewardId
                    })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Claim failed');
                }

                const data = await res.json();

                // Success notification
                showSuccess(`üéâ ${data.message || 'R√©compense r√©cup√©r√©e !'}`);

                // Reload data after 1.5s
                setTimeout(() => {
                    loadVipData(token);
                }, 1500);

            } catch (err) {
                console.error('Claim reward error:', err);
                
                if (err.message.includes('d√©j√† r√©clam√©e')) {
                    showError('‚ùå Cette r√©compense a d√©j√† √©t√© r√©clam√©e.');
                } else if (err.message.includes('Points insuffisants')) {
                    showError('‚ùå Pas assez de points pour cette r√©compense.');
                } else {
                    showError('‚ùå Erreur lors de la r√©cup√©ration. R√©essayez.');
                }
            }
        }

        // ========================================
        // SAVED PROFILES (PENSE-B√äTES VIP)
        // ========================================
        async function loadSavedProfiles(token) {
            try {
                const res = await fetch(`${API_BASE}/recommendation/list?session_token=${token}`);
                
                if (!res.ok) {
                    console.warn('Recommandations non disponibles');
                    document.getElementById('saved-profiles-section').style.display = 'none';
                    return;
                }

                const data = await res.json();

                if (data.success && data.list_type === 'vip') {
                    displaySavedProfiles(data.recommendations, data.stats);
                } else {
                    // Pas VIP ou pas de recommandations
                    document.getElementById('saved-profiles-section').style.display = 'none';
                }
            } catch (err) {
                console.error('Erreur chargement profils:', err);
                document.getElementById('saved-profiles-section').style.display = 'none';
            }
        }

        function displaySavedProfiles(profiles, stats) {
            const container = document.getElementById('saved-profiles-list');
            const emptyState = document.getElementById('profiles-empty');
            const section = document.getElementById('saved-profiles-section');

            // Update stats
            document.getElementById('profiles-total').textContent = stats?.total || 0;
            document.getElementById('profiles-pending').textContent = stats?.pending || 0;

            if (!profiles || profiles.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            let html = '';
            profiles.forEach(profile => {
                const date = profile.meeting_date 
                    ? new Date(profile.meeting_date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })
                    : '-';

                const notePreview = profile.personal_note && profile.personal_note.length > 50
                    ? profile.personal_note.substring(0, 50) + '...'
                    : (profile.personal_note || 'Aucune note');

                html += `
                    <div class="glass-card p-4 rounded-xl">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center text-lg shadow-lg">
                                ‚≠ê
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-1">
                                    <h3 class="font-bold text-white text-sm truncate">${profile.recommended_pseudonym || 'Profil anonyme'}</h3>
                                    <span class="text-[10px] text-gray-400 whitespace-nowrap ml-2">${date}</span>
                                </div>
                                <p class="text-xs text-gray-400 mb-2">${profile.meeting_context || 'Rencontre MeeTempo'} ‚Ä¢ ${profile.meeting_city || '-'}</p>
                                <p class="text-xs text-gray-300 italic">"${notePreview}"</p>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3 pt-3 border-t border-white/10">
                            <button onclick="viewProfileDetail('${profile.recommendation_id}')" class="flex-1 text-[10px] bg-white/5 hover:bg-white/10 text-gray-300 py-2 rounded-lg transition">
                                üëÅÔ∏è D√©tails
                            </button>
                            <button onclick="exportProfile('${profile.recommendation_id}')" class="flex-1 text-[10px] bg-white/5 hover:bg-white/10 text-gray-300 py-2 rounded-lg transition">
                                üìß Exporter
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function viewProfileDetail(recommendationId) {
            // Chercher dans le cache ou refetch
            showSuccess('Fonctionnalit√© d√©tails - Bient√¥t disponible !');
        }

        function exportProfile(recommendationId) {
            // Export par email ou copie
            showSuccess('üìã Fonctionnalit√© export - Bient√¥t disponible !');
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function copyLink() {
            const input = document.getElementById('referral-link');
            input.select();
            
            navigator.clipboard.writeText(input.value).then(() => {
                showSuccess('‚úÖ Lien copi√© dans le presse-papier !');
            }).catch(() => {
                showError('‚ùå Erreur lors de la copie.');
            });
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.remove();
                document.getElementById('main-content').classList.remove('hidden');
            }, 300);
        }

        function showSuccess(message) {
            const toast = `
                <div id="toast" class="fixed top-20 left-4 right-4 bg-green-500 text-white p-4 rounded-xl shadow-2xl z-[9999] animate-slideUp flex items-center gap-3">
                    <i class="fas fa-check-circle text-2xl"></i>
                    <p class="font-bold">${message}</p>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', toast);
            
            setTimeout(() => {
                const el = document.getElementById('toast');
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        function showError(message) {
            const toast = `
                <div id="toast-error" class="fixed top-20 left-4 right-4 bg-red-500 text-white p-4 rounded-xl shadow-2xl z-[9999] animate-slideUp">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                        <div class="flex-1">
                            <p class="font-bold mb-1">${message}</p>
                            <button onclick="this.closest('#toast-error').remove()" class="text-xs bg-white/20 px-2 py-1 rounded mt-2">
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', toast);
            
            setTimeout(() => {
                const el = document.getElementById('toast-error');
                if (el) {
                    el.style.opacity = '0';
                    setTimeout(() => el.remove(), 300);
                }
            }, 5000);
        }

        // ========================================
        // NAVIGATION
        // ========================================
        function getToken() { 
            return sessionStorage.getItem('meetempo_token'); 
        }

        function goToRequests() { 
            window.location.href = `my-requests.html?session_token=${getToken()}`; 
        }

        function goToSuggestions() { 
            window.location.href = `my-suggestions.html?session_token=${getToken()}`; 
        }

        function createNew() { 
            window.location.href = `create-suggestion.html?token=${getToken()}`; 
        }

        function goToB2B() { 
            window.location.href = `b2b-dashboard.html?session_token=${getToken()}`; 
        }
        
        async function goToMap() {
        const token = getToken();
        try {
            const res = await fetch(`${API_BASE}/auth/elevate-session?session_token=${token}`);
            if (!res.ok) throw new Error('Auth fail');
            
            const data = await res.json();
            
            // ‚úÖ HYBRIDE : SessionStorage + URL
            try {
                sessionStorage.setItem('meetempo_elevated_token', data.token);
            } catch (e) {
                console.warn('SessionStorage failed:', e);
            }
            
            // ‚úÖ Token TOUJOURS dans URL (pour compatibilit√©)
            window.location.href = `map.html?token=${data.token}`;
            
        } catch(e) {
            showError('Erreur de connexion √† la carte');
            console.error(e);
        }
    }

        // ========================================
// B2B FORM MODAL
// ========================================
function openB2BForm() {
    document.getElementById('b2b-modal').classList.remove('hidden');
}

function closeB2BForm() {
    document.getElementById('b2b-modal').classList.add('hidden');
}

// Close modal on outside click
document.addEventListener('click', (e) => {
    const modal = document.getElementById('b2b-modal');
    if (e.target === modal) {
        closeB2BForm();
    }
});

// ========================================
// B2B FORM SUBMISSION
// ========================================
document.getElementById('b2b-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Get user info
    const token = getToken();
    
    try {
        // Get user profile for email
        const profileRes = await fetch(`${API_BASE}/profile?session_token=${token}`);
        const profile = await profileRes.json();
        
        // Send email via backend
        const emailBody = {
            session_token: token,
            to: 'support@meetempo.com',
            subject: `üè¢ Demande B2B - ${data.company}`,
            html: `
                <h2>Nouvelle demande B2B</h2>
                <p><strong>De:</strong> ${profile.first_name} ${profile.last_name || ''} (${profile.email})</p>
                <p><strong>Plan actuel:</strong> ${profile.plan?.toUpperCase()}</p>
                <hr>
                <p><strong>Entreprise:</strong> ${data.company}</p>
                <p><strong>Fonction:</strong> ${data.job_level}</p>
                <p><strong>Email pro:</strong> ${data.email}</p>
                <p><strong>Taille √©quipe:</strong> ${data.team_size}</p>
                <p><strong>T√©l√©phone:</strong> ${data.phone || 'Non renseign√©'}</p>
                <p><strong>Message:</strong><br>${data.message || 'Aucun message'}</p>
                <hr>
                <p><strong>Action:</strong> Contacter ce VIP √† ${data.email} sous 24h</p>
            `
        };

        const res = await fetch(`${API_BASE}/admin/send-email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(emailBody)
        });
        
        if (!res.ok) throw new Error('Email send failed');
        
        // Success
        closeB2BForm();
        showSuccess('‚úÖ Demande envoy√©e ! Nous vous recontactons sous 24h.');
        
        // Reset form
        e.target.reset();
        
    } catch (err) {
        console.error('B2B form error:', err);
        showError('‚ùå Erreur lors de l\'envoi. R√©essayez ou contactez support@meetempo.com');
    }
});

    </script>
</body>
</html>
