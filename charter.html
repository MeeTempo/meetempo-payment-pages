<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Charte d'usage ‚Äì MeeTempo</title>
  <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               img-src https: data:; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               font-src https://fonts.gstatic.com; 
               connect-src https://api.meetempo.com;">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --mt-dark:#030E4F;
      --mt-accent:#F49F1C;
      --mt-bg:#0a133f;
      --mt-card:#0e184f;
      --mt-text:#ffffff;
      --mt-muted:#c9d1ff;
      --ok:#23c55e;
      --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(160deg,#030E4F 0%,#0a133f 60%,#11183f 100%);color:var(--mt-text);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:900px;margin:32px auto;padding:16px}
    .logo{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .logo-badge{width:40px;height:40px;border-radius:999px;background:conic-gradient(from 0deg,var(--mt-accent),#ffca63,var(--mt-accent));display:grid;place-items:center;color:#111;font-weight:800}
    .card{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);backdrop-filter: blur(6px);border-radius:16px;padding:24px}
    h1{font-size:26px;margin:8px 0 4px}
    h2{font-size:18px;margin:24px 0 12px;color:#e8ecff}
    p,li{line-height:1.6;color:#ebefff}
    small, .muted{color:var(--mt-muted)}
    .lang{display:flex;gap:8px;margin:8px 0 16px}
    .lang button{background:transparent;border:1px solid rgba(255,255,255,.25);color:var(--mt-text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .lang button.active{border-color:var(--mt-accent);box-shadow:0 0 0 2px rgba(244,159,28,.25) inset}
    .sections{display:grid;gap:14px}
    .section{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px}
    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:18px}
    .btn{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--mt-accent);color:#111}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.25);color:var(--mt-text)}
    .state{margin-top:12px;font-weight:600}
    .state.ok{color:var(--ok)}
    .state.err{color:var(--err)}
    .check{display:flex;gap:10px;align-items:flex-start;margin-top:10px}
    .check input{margin-top:4px;transform:scale(1.1)}
    .footer{margin-top:18px;font-size:12px}
    a{color:#ffd68a}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:16px 0}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="logo">
      <div class="logo-badge">MT</div>
      <div>
        <div class="muted">MeeTempo</div>
        <strong>Charte d‚Äôusage & √©thique</strong>
      </div>
    </div>

    <div class="card">
      <div class="lang">
        <button id="btn-fr" class="active" aria-pressed="true">FR</button>
        <button id="btn-en" aria-pressed="false">EN</button>
      </div>

      <!-- FR -->
      <div id="content-fr">
        <h1>Charte d‚Äôusage MeeTempo</h1>
        <div class="sections">
          <div class="section">
            <h2>1. Valeurs</h2>
            <p>MeeTempo favorise des connexions responsables entre professionnels, cr√©ateurs, voyageurs et passionn√©s. Respect, authenticit√©, s√©curit√© et confidentialit√© priment.</p>
            <ul>
              <li>Rencontres <strong>non</strong> orient√©es vers des rendez-vous intimes ou ‚Äúos√©s‚Äù.</li>
              <li>Interdits : harc√®lement, discrimination, comportements ill√©gaux, d√©tournements.</li>
            </ul>
          </div>
          <div class="section">
            <h2>2. Acc√®s & authentification</h2>
            <p>Acc√®s via <strong>code √† 6 chiffres</strong> + v√©rification e-mail. Les liens d‚Äô√©dition utilisent des <strong>tokens temporaires</strong>. Votre <code>user_id</code> n‚Äôest jamais expos√© publiquement.</p>
          </div>
          <div class="section">
            <h2>3. Donn√©es & confidentialit√©</h2>
            <ul>
              <li>Collecte minimale (profil, pr√©f√©rences, localisation approximative).</li>
              <li>Pas de vente de donn√©es. Partages limit√©s et conformes.</li>
              <li>Droit d‚Äôacc√®s/suppression sur demande.</li>
            </ul>
          </div>
          <div class="section">
            <h2>4. Suggestions & mod√©ration</h2>
            <ul>
              <li>Suggestions orient√©es activit√©s, pro, social. Contenu ‚Äúrencontres os√©es‚Äù refus√©.</li>
              <li><strong>Deux tentatives</strong> inappropri√©es ‚Üí suspension possible.</li>
              <li>Signalement discret disponible. Analyses comportementales pour pr√©venir les abus.</li>
            </ul>
          </div>
          <div class="section">
            <h2>5. Comportement attendu</h2>
            <ul>
              <li>Informations exactes et √† jour.</li>
              <li>Respect du consentement et des pr√©f√©rences.</li>
              <li>Signalement des abus via l‚Äôoutil pr√©vu.</li>
            </ul>
          </div>
          <div class="section">
            <h2>6. S√©curit√©</h2>
            <ul>
              <li>Code + e-mail + token court-v√©cu.</li>
              <li>Journalisation minimale des actions sensibles.</li>
              <li>Rate-limit et protections anti-bruteforce.</li>
            </ul>
          </div>
          <div class="section">
            <h2>7. Limites & Responsabilit√©</h2>
            <p>Les rencontres ont lieu sous votre enti√®re responsabilit√©. MeeTempo agit en tant que facilitateur et d√©cline toute responsabilit√© pour :</p>
            <ul>
              <li>Les interactions priv√©es et leurs cons√©quences (personnelles, professionnelles, financi√®res).</li>
              <li>Les comportements des autres utilisateurs, y compris les employ√©s d'entreprises partenaires.</li>
              <li>Les informations inexactes fournies par les membres.</li>
              <li>Toute perte, dommage ou pr√©judice r√©sultant de l'utilisation de la plateforme.</li>
            </ul>
            <p>En utilisant MeeTempo, vous reconnaissez que vous √™tes seul responsable de vos choix et actions.</p>
          </div>
          <div class="section">
            <h2>8. √âvolution de la charte</h2>
            <p>Cette charte peut √©voluer. Toute modification significative sera notifi√©e. L‚Äôusage continu vaut acceptation.</p>
          </div>
          <div class="section">
            <h2>9. Utilisation B2B / Entreprise</h2>
            <p>MeeTempo propose des offres destin√©es aux entreprises et √† leurs collaborateurs.</p>
            <ul>
              <li><strong>Responsabilit√© employeur :</strong> L'entreprise souscriptrice est responsable de l'information et de la sensibilisation de ses collaborateurs aux pr√©sentes r√®gles.</li>
              <li><strong>Responsabilit√© individuelle :</strong> Chaque utilisateur (employ√© ou non) reste personnellement responsable de son comportement et de ses interactions sur la plateforme.</li>
              <li><strong>Limitation de responsabilit√© :</strong> MeeTempo ne saurait √™tre tenu responsable de l'utilisation faite par les membres employ√©s, ni des cons√©quences professionnelles ou personnelles r√©sultant des rencontres facilit√©es par la plateforme.</li>
              <li><strong>Donn√©es entreprise :</strong> Les administrateurs B2B ont acc√®s √† des statistiques agr√©g√©es uniquement. Aucune donn√©e personnelle de conversation ou de rencontre n'est partag√©e avec l'employeur.</li>
              <li><strong>S√©paration pro/perso :</strong> Les suggestions cr√©√©es dans un cadre B2B restent soumises aux m√™mes r√®gles √©thiques que les comptes individuels.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <label class="check">
          <input type="checkbox" id="chk-accept-fr">
          <span>J‚Äôai lu et j‚Äôaccepte la charte MeeTempo.</span>
        </label>
        <div class="actions">
          <button class="btn btn-primary" id="btn-accept-fr">Accepter</button>
          <button class="btn btn-ghost" id="btn-back-fr">Retour</button>
        </div>
        <div id="state-fr" class="state hidden"></div>

        <div class="footer muted">
          <p>Vie priv√©e : aucune donn√©e sensible n‚Äôest visible publiquement sans consentement. Les tokens sont temporaires afin de limiter l‚Äôacc√®s non autoris√©.</p>
        </div>
      </div>

      <!-- EN -->
      <div id="content-en" class="hidden" lang="en">
        <h1>MeeTempo Usage Charter</h1>
        <div class="sections">
          <div class="section">
            <h2>1. Values</h2>
            <p>MeeTempo enables responsible connections among professionals, creators, travelers and enthusiasts. Respect, authenticity, safety and privacy first.</p>
            <ul>
              <li>No features for intimate or ‚Äúadult‚Äù meetups.</li>
              <li>Prohibited: harassment, discrimination, illegal or abusive behavior.</li>
            </ul>
          </div>
          <div class="section">
            <h2>2. Access & Authentication</h2>
            <p>Access requires a <strong>6-digit code</strong> plus e-mail verification. Edit links use <strong>short-lived tokens</strong>. Your <code>user_id</code> is never exposed publicly.</p>
          </div>
          <div class="section">
            <h2>3. Data & Privacy</h2>
            <ul>
              <li>Minimal data (profile, preferences, approximate location).</li>
              <li>No data selling. Limited, compliant sharing.</li>
              <li>Right to access/delete upon request.</li>
            </ul>
          </div>
          <div class="section">
            <h2>4. Suggestions & Moderation</h2>
            <ul>
              <li>Suggestions are activity/pro/social oriented. ‚ÄúAdult/explicit‚Äù content is rejected.</li>
              <li><strong>Two attempts</strong> at inappropriate use may lead to suspension.</li>
              <li>Discrete reporting is available. Behavioral checks help prevent abuse.</li>
            </ul>
          </div>
          <div class="section">
            <h2>5. Expected Conduct</h2>
            <ul>
              <li>Accurate, up-to-date information.</li>
              <li>Respect consent and preferences.</li>
              <li>Report abuse via the provided tool.</li>
            </ul>
          </div>
          <div class="section">
            <h2>6. Security</h2>
            <ul>
              <li>Code + e-mail + short-lived token.</li>
              <li>Minimal logging of sensitive actions.</li>
              <li>Rate-limit and anti-bruteforce protections.</li>
            </ul>
          </div>
          <div class="section">
            <h2>7. Limits & Liability</h2>
            <p>In-person meetups happen under your sole responsibility. MeeTempo acts as a facilitator and disclaims all liability for:</p>
            <ul>
              <li>Private interactions and their consequences (personal, professional, financial).</li>
              <li>The behavior of other users, including employees of partner companies.</li>
              <li>Inaccurate information provided by members.</li>
              <li>Any loss, damage or harm resulting from use of the platform.</li>
            </ul>
            <p>By using MeeTempo, you acknowledge that you are solely responsible for your choices and actions.</p>
          </div>
          <div class="section">
            <h2>8. Changes</h2>
            <p>This charter may evolve. Significant changes will be notified. Continued use means acceptance.</p>
          </div>
          <div class="section">
            <h2>9. B2B / Enterprise Usage</h2>
            <p>MeeTempo offers plans for companies and their employees.</p>
            <ul>
              <li><strong>Employer responsibility:</strong> The subscribing company is responsible for informing and educating its employees about these rules.</li>
              <li><strong>Individual responsibility:</strong> Each user (employee or not) remains personally responsible for their behavior and interactions on the platform.</li>
              <li><strong>Limitation of liability:</strong> MeeTempo cannot be held liable for the use made by employee members, nor for any professional or personal consequences resulting from meetings facilitated by the platform.</li>
              <li><strong>Company data:</strong> B2B administrators only have access to aggregated statistics. No personal conversation or meeting data is shared with the employer.</li>
              <li><strong>Work/personal separation:</strong> Suggestions created in a B2B context remain subject to the same ethical rules as individual accounts.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <label class="check">
          <input type="checkbox" id="chk-accept-en">
          <span>I have read and accept the MeeTempo charter.</span>
        </label>
        <div class="actions">
          <button class="btn btn-primary" id="btn-accept-en">Accept</button>
          <button class="btn btn-ghost" id="btn-back-en">Back</button>
        </div>
        <div id="state-en" class="state hidden"></div>

        <div class="footer muted">
          <p>Privacy: no sensitive data is publicly visible without consent. Short-lived tokens limit unauthorized access.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
  const API_BASE = 'https://api.meetempo.com';
  const params = new URLSearchParams(location.search);
  const token = params.get('session_token') || params.get('token') || '';
  const returnUrl = params.get('return') || params.get('return_url') || 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
  const langParam = (params.get('lang') || 'fr').toLowerCase();
  const GPT_URL_FALLBACK = returnUrl;

  // UI refs
  const frBtn = document.getElementById("btn-fr");
  const enBtn = document.getElementById("btn-en");
  const fr = document.getElementById("content-fr");
  const en = document.getElementById("content-en");
  const chkFr = document.getElementById("chk-accept-fr");
  const chkEn = document.getElementById("chk-accept-en");
  const stateFr = document.getElementById("state-fr");
  const stateEn = document.getElementById("state-en");
  const btnAccFr = document.getElementById("btn-accept-fr");
  const btnAccEn = document.getElementById("btn-accept-en");
  const btnBackFr = document.getElementById("btn-back-fr");
  const btnBackEn = document.getElementById("btn-back-en");

  // Lang toggle
  function setLang(l){ 
    const isFr = l==='fr';
    (isFr?fr:en).classList.remove("hidden");
    (isFr?en:fr).classList.add("hidden");
    (isFr?frBtn:enBtn).classList.add("active");
    (isFr?enBtn:frBtn).classList.remove("active");
  }
  frBtn.onclick = ()=>setLang('fr');
  enBtn.onclick = ()=>setLang('en');

  // API helper
  const j = (p,opt={}) => fetch(`${API_BASE}${p}`, {
    ...opt,
    headers: { "Content-Type":"application/json", ...(opt.headers||{}) }
  }).then(r=>r.json());

  function showDenied(msgFr, msgEn){
    stateFr.classList.remove('hidden'); stateEn.classList.remove('hidden');
    stateFr.classList.add('err'); stateEn.classList.add('err');
    stateFr.textContent = msgFr; stateEn.textContent = msgEn;
    btnAccFr.disabled = true; btnAccEn.disabled = true;
  }

  async function verifySession(){
    if(!token){ showDenied("‚ùå Token manquant.","‚ùå Missing token."); return false; }
    try{
      // üî• NOUVEAU : Validation multi-source (comme les autres pages)
      let isValid = false;
      
      // Essayer /profile d'abord (session_token 24h)
      const profileRes = await fetch(`${API_BASE}/profile?session_token=${encodeURIComponent(token)}`);
      if(profileRes.ok){
        const profileData = await profileRes.json();
        if(profileData.user_id || profileData.email){
          isValid = true;
          console.log('‚úÖ Token valid√© via /profile (24h)');
        }
      }
      
      // Fallback /auth/session (elevated_token 15min)
      if(!isValid){
        const sessionRes = await fetch(`${API_BASE}/auth/session?token=${encodeURIComponent(token)}`);
        if(sessionRes.ok){
          const sessionData = await sessionRes.json();
          if(sessionData.user_id){
            isValid = true;
            console.log('‚úÖ Token valid√© via /auth/session (15min)');
          }
        }
      }
      
      if(!isValid){ 
        showDenied("‚ùå Session expir√©e.","‚ùå Session expired."); 
        return false; 
      }
      
      sessionStorage.setItem('meetempo_token', token);
      return true;
    }catch(err){
      console.error('Verify session error:', err);
      showDenied("‚ùå Erreur r√©seau.","‚ùå Network error."); 
      return false;
    }
  }

  async function loadConsent(){
    try{
      const s = await j(`/consent/status?session_token=${encodeURIComponent(token)}`);
      const accepted = !!s.accepted;
      chkFr.checked = accepted; chkEn.checked = accepted;
      if(accepted){
        stateFr.classList.remove('hidden'); stateFr.classList.add('ok'); stateFr.textContent = "D√©j√† accept√©.";
        stateEn.classList.remove('hidden'); stateEn.classList.add('ok'); stateEn.textContent = "Already accepted.";
      }
    }catch{/* silencieux */}
  }

  async function accept(lang){
    const chk = lang==='fr'? chkFr : chkEn;
    const state = lang==='fr'? stateFr : stateEn;
    const btn = lang==='fr'? btnAccFr : btnAccEn;
    
    if(!chk.checked){ 
      state.classList.remove('hidden','ok','err'); 
      state.classList.add('err'); 
      state.textContent = lang==='fr'?"Cochez la case pour accepter.":"Please tick the checkbox to accept."; 
      return; 
    }
    
    btn.disabled = true; 
    state.classList.remove('hidden','ok','err'); 
    state.textContent = lang==='fr'?"Enregistrement...":"Saving...";
    
    try{
      const response = await fetch(`${API_BASE}/consent/accept`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ token })
      });
      
      const r = await response.json();
      
      if(response.ok && r.success){
  state.classList.add('ok'); 
  
  // üî• NOUVEAU : Rediriger vers return URL ou fermer
  if(returnUrl && !returnUrl.includes('chatgpt.com')){
    // Redirection interne (hub.html, map.html, etc.)
    state.textContent = lang==='fr'?"‚úÖ Charte accept√©e ! Redirection...":"‚úÖ Charter accepted! Redirecting...";
    setTimeout(()=>{
      // Construire URL avec token
      const redirectTarget = returnUrl.includes('?') 
        ? `${returnUrl}&session_token=${token}` 
        : `${returnUrl}?session_token=${token}`;
      window.location.href = redirectTarget;
    }, 1500);
  } else {
    // Retour GPT (fermer fen√™tre)
    state.textContent = lang==='fr'?"‚úÖ Charte accept√©e ! Retourne √† ton onglet GPT.":"‚úÖ Charter accepted! Return to your GPT tab.";
    setTimeout(()=>window.close(), 1500);
  }
} else {
        state.classList.add('err'); 
        state.textContent = lang==='fr'?`‚ùå Erreur: ${r.error || 'inconnue'}`:`‚ùå Error: ${r.error || 'unknown'}`;
        btn.disabled = false;
      }
    } catch(err) {
      console.error('Accept error:', err);
      state.classList.add('err'); 
      state.textContent = lang==='fr'?`‚ùå Erreur r√©seau: ${err.message}`:`‚ùå Network error: ${err.message}`;
      btn.disabled = false;
    }
  }

  btnAccFr.onclick = ()=>accept('fr');
  btnAccEn.onclick = ()=>accept('en');
  btnBackFr.onclick = ()=> location.href = returnUrl || GPT_URL_FALLBACK;
  btnBackEn.onclick = ()=> location.href = returnUrl || GPT_URL_FALLBACK;

  // Init
  (async () => {
    setLang(langParam === 'en' ? 'en' : 'fr');
    const ok = await verifySession();
    if(ok) await loadConsent();
  })();
</script>
</body>
</html>
