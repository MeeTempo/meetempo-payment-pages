<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Carte MeeTempers - MeeTempo</title>
  
  <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               img-src https: data: blob:; 
               script-src 'self' https://js.api.here.com 'unsafe-inline' 'unsafe-eval'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://js.api.here.com; 
               font-src https://fonts.gstatic.com https://js.api.here.com https://cdnjs.cloudflare.com; 
               worker-src blob:; 
               connect-src 'self' blob: https://api.meetempo.com https://*.hereapi.com https://js.api.here.com;">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-clustering.js"></script>
  
  <style>
    :root {
      --mt-bg: #0f172a;
      --mt-accent: #f97316;
      --mt-text: #f8fafc;
      --mt-muted: #94a3b8;
      --glass-bg: rgba(15, 23, 42, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--mt-bg);
      color: var(--mt-text);
      overflow: hidden;
      height: 100vh;
    }
    
    /* === TOP BAR === */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 64px;
      background: var(--glass-bg); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .logo-section { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .logo-badge {
      width: 36px; height: 36px; border-radius: 12px;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      display: flex; align-items: center; justify-content: center;
      color: #fff; transition: 0.2s;
    }
    .logo-section:hover .logo-badge { background: rgba(255,255,255,0.2); }
    .top-bar h1 { font-size: 16px; font-weight: 600; }
    
    .stats { display: flex; align-items: center; gap: 8px; }
    .stat-item {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      padding: 6px 12px; border-radius: 50px; font-size: 12px;
      cursor: pointer; transition: 0.2s;
    }
    .stat-item:hover { background: rgba(255,255,255,0.1); }

    /* === SEARCH === */
    .search-bar {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 400px; z-index: 999;
    }
    .search-wrapper {
      display: flex; gap: 10px; align-items: center;
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border); border-radius: 50px;
      padding: 12px 20px; box-shadow: var(--glass-shadow);
    }
    #citySearchInput {
      flex: 1; border: none; background: transparent;
      font-size: 15px; color: white; outline: none;
    }
    
    /* Autocomplete */
    .search-autocomplete-results {
      display: none; position: absolute; top: calc(100% + 8px); left: 0; right: 0;
      background: var(--mt-bg); border: 1px solid var(--glass-border);
      border-radius: 16px; overflow: hidden; z-index: 10000;
    }
    .search-autocomplete-results.show { display: block; }
    .search-autocomplete-item {
      padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .search-autocomplete-item:hover { background: rgba(255,255,255,0.1); }

    /* === CONTROLS === */
    .distance-selector {
      position: fixed; top: 150px; right: 20px;
      background: var(--glass-bg); backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border); border-radius: 16px;
      padding: 12px; z-index: 999; display: flex; flex-direction: column; gap: 8px;
    }
    .distance-btn {
      padding: 8px; border: 1px solid transparent; border-radius: 8px;
      background: rgba(255,255,255,0.05); color: var(--mt-muted);
      font-size: 11px; font-weight: 600; cursor: pointer;
    }
    .distance-btn.active { background: var(--mt-accent); color: white; }

    .my-location-btn {
      position: fixed; bottom: 260px; right: 20px;
      width: 48px; height: 48px; background: var(--mt-accent);
      border: none; border-radius: 50%; color: white; font-size: 20px;
      box-shadow: 0 4px 15px rgba(249, 115, 22, 0.5);
      cursor: pointer; z-index: 999; display: flex; justify-content: center; align-items: center;
    }

    /* === MAP === */
    #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

    /* === BOTTOM SHEET (Suggestions) === */
    .bottom-sheet {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 240px; /* Plus haut pour bien voir */
      background: var(--glass-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.5);
      z-index: 999; transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .sheet-handle {
      width: 40px; height: 4px; background: rgba(255,255,255,0.2);
      border-radius: 2px; margin: 12px auto; cursor: grab;
    }
    
    .sheet-container {
      position: relative;
      height: calc(100% - 30px);
      padding: 0 40px; /* Espace pour les fl√®ches */
    }

    /* Scroll Arrows */
    .scroll-arrow {
      position: absolute; top: 50%; transform: translateY(-50%);
      width: 36px; height: 36px; border-radius: 50%;
      background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2);
      color: white; font-size: 14px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 1001; transition: 0.2s; opacity: 0; pointer-events: none;
    }
    .scroll-arrow.visible { opacity: 1; pointer-events: auto; }
    .scroll-arrow:hover { background: var(--mt-accent); border-color: var(--mt-accent); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .scroll-arrow.left { left: 10px; }
    .scroll-arrow.right { right: 10px; }

    .users-grid {
      display: flex; gap: 16px; overflow-x: auto; 
      padding: 10px 0 20px 0;
      scroll-behavior: smooth;
      scrollbar-width: none; /* Hide scrollbar Firefox */
    }
    .users-grid::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome */

    /* === USER CARD === */
    .user-card {
      min-width: 280px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px; padding: 16px;
      cursor: pointer; transition: 0.2s; position: relative;
    }
    .user-card:hover, .user-card.active {
      background: rgba(255,255,255,0.07);
      border-color: var(--mt-accent);
      transform: translateY(-2px);
    }
    
    .user-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .user-avatar {
      width: 44px; height: 44px; border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: white; font-size: 16px;
    }
    .user-info h3 { font-size: 15px; font-weight: 600; color: white; margin-bottom: 2px; }
    .user-distance { font-size: 12px; color: var(--mt-accent); }
    
    .btn {
      width: 100%; padding: 8px; border-radius: 8px; border: none;
      font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 10px;
    }
    .btn-primary { background: var(--mt-accent); color: white; }

    /* Loading & Error */
    .loading, .error-screen {
      position: fixed; inset: 0; background: var(--mt-bg);
      display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
    }
    .spinner {
      width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--mt-accent); border-radius: 50%; animation: spin 1s infinite linear;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* InfoBubble Styling */
    .H_ib_body { background: #0f172a !important; color: white !important; border-radius: 8px; padding: 0 !important; }
    .H_ib_content { margin: 0 !important; }
    .H_ib_close { display: none; }
    .H_ib_tail { fill: #0f172a !important; }

    @media (max-width: 640px) {
      .top-bar { height: 56px; padding: 0 16px; }
      .stats span:not(#locationText):not([id*="Count"]) { display: none; }
      .search-bar { top: 66px; width: 92%; }
      .distance-selector { top: 130px; }
      .my-location-btn { bottom: 250px; right: 16px; }
      /* Cacher fl√®ches sur mobile (on swipe) */
      .scroll-arrow { display: none; }
      .sheet-container { padding: 0 16px; }
    }
  </style>
</head>
<body>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div style="margin-top: 15px; color: var(--mt-muted); font-size: 14px;">Chargement de la carte...</div>
  </div>
  
  <div id="errorScreen" class="error-screen" style="display: none;">
    <i class="fas fa-exclamation-circle" style="font-size: 40px; color: #ef4444; margin-bottom: 20px;"></i>
    <h2 id="errorTitle" style="margin-bottom: 10px;">Erreur</h2>
    <p id="errorMessage" style="color: var(--mt-muted); margin-bottom: 20px;">Une erreur est survenue</p>
    <button class="btn-primary" style="padding:10px 20px; width:auto;" onclick="goBackToHub()">Retour au Hub</button>
  </div>

  <div class="top-bar">
    <div class="logo-section" onclick="goBackToHub()">
      <div class="logo-badge"><i class="fas fa-arrow-left"></i></div>
      <h1>Hub</h1>
    </div>
    <div class="stats">
      <div class="stat-item"><i class="fas fa-map-marker-alt" style="color:#f87171;"></i><span id="locationText">...</span></div>
      <div class="stat-item"><i class="fas fa-users" style="color:#60a5fa;"></i><span id="userCount">0</span></div>
      <div class="stat-item"><i class="fas fa-list-ul" style="color:var(--mt-accent);"></i><span id="suggestionCount">0</span></div>
    </div>
  </div>

  <div class="search-bar">
    <div class="search-wrapper">
      <i class="fas fa-search" style="color:#94a3b8;"></i>
      <input type="text" id="citySearchInput" placeholder="Chercher une ville..." autocomplete="off">
      <div id="searchAutocomplete" class="search-autocomplete-results"></div>
    </div>
  </div>

  <div id="map"></div>

  <div class="distance-selector">
    <div class="distance-label">RAYON</div>
    <div class="distance-buttons">
      <button class="distance-btn" data-radius="5">5 km</button>
      <button class="distance-btn" data-radius="10">10 km</button>
      <button class="distance-btn active" data-radius="20">20 km</button>
      <button class="distance-btn" data-radius="50">50 km</button>
    </div>
  </div>

  <button class="my-location-btn" onclick="goToMyLocation()"><i class="fas fa-crosshairs"></i></button>

  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-handle" id="sheetHandle"></div>
    <div class="sheet-container">
      <button class="scroll-arrow left" id="arrowLeft" onclick="scrollUsers(-300)"><i class="fas fa-chevron-left"></i></button>
      <button class="scroll-arrow right" id="arrowRight" onclick="scrollUsers(300)"><i class="fas fa-chevron-right"></i></button>
      
      <div class="users-grid" id="usersGrid">
        </div>
    </div>
  </div>

  <script>
    // ============================================
    // ‚öôÔ∏è LOGIQUE & ENDPOINTS (INTOUCH√âS)
    // ============================================
    
    // Bloc Universel Token
    (function() {
      const params = new URLSearchParams(location.search);
      window.MT_TOKEN = params.get('session_token') || params.get('token') || params.get('t')
                       || localStorage.getItem('session_token') || sessionStorage.getItem('meetempo_token');
      if (window.MT_TOKEN) {
        localStorage.setItem('session_token', window.MT_TOKEN);
        sessionStorage.setItem('meetempo_token', window.MT_TOKEN);
      }
    })();

    const API_BASE = 'https://api.meetempo.com';
    let token = window.MT_TOKEN;
    let activeToken = null;
    let HERE_API_KEY = null;
    let map, ui;
    let userGpsLocation = { lat: 48.8566, lng: 2.3522, source: 'default' };
    let currentLocation = { lat: 48.8566, lng: 2.3522 };
    let currentRadius = 20;
    let markers = [];
    let usersData = [];
    let suggestionsData = [];
    let clusteringLayer = null;
    let isManualRadius = false;
    let reloadTimeout = null;
    let searchAutocompleteTimeout = null;

    const MARKER_COLORS = ['#F49F1C', '#3B82F6', '#10B981', '#8B5CF6', '#EF4444'];

    // üîô Retour Hub S√©curis√©
    function goBackToHub() {
      const t = activeToken || token;
      if (t) window.location.href = `hub.html?session_token=${t}`;
      else window.location.href = 'hub.html';
    }

    // üìç NOUVEAUX MARQUEURS "N√âON"
    
    function createClusterIcon(count) {
      return `<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feComposite in="SourceGraphic" in2="blur" operator="over"/>
          </filter>
        </defs>
        <circle cx="30" cy="30" r="22" fill="#F49F1C" opacity="0.3" />
        <circle cx="30" cy="30" r="16" fill="#F49F1C" stroke="#fff" stroke-width="2" />
        <text x="30" y="35" text-anchor="middle" font-family="'Inter', sans-serif" font-size="14" font-weight="800" fill="#fff">${count}</text>
      </svg>`;
    }

    function createDropletIcon(color, affinityScore = 50, plan = "free", visibility = "visible") {
      const ringColor = getAffinityColor(affinityScore);
      let glowColor = 'none', glowOpacity = 0;
      if (plan === 'vip') { glowColor = '#FFD700'; glowOpacity = 0.5; }
      else if (visibility === 'discret') { glowColor = '#1e293b'; glowOpacity = 0.5; }
      
      return `<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg">
        ${glowOpacity > 0 ? `<circle cx="30" cy="30" r="24" fill="${glowColor}" opacity="${glowOpacity}" />` : ''}
        <circle cx="30" cy="30" r="18" fill="#0f172a" />
        <circle cx="30" cy="30" r="16" fill="none" stroke="${ringColor}" stroke-width="3" />
        <text x="30" y="34" font-family="'Inter', sans-serif" font-size="11" font-weight="700" fill="#fff" text-anchor="middle">${affinityScore}</text>
        <path d="M26 44 L30 50 L34 44 Z" fill="${ringColor}" />
      </svg>`;
    }

    function getAffinityColor(score) {
      if (score >= 80) return '#10B981';
      if (score >= 60) return '#F49F1C';
      return '#3B82F6';
    }

    // üõ†Ô∏è INIT & LOGIQUE
    async function init() {
      if (!token) { showError('Non connect√©', 'Acc√®s refus√©'); return; }
      
      try {
        // Validate
        const profileRes = await fetch(`${API_BASE}/profile?session_token=${token}`);
        if (!profileRes.ok) throw new Error('Session invalide');
        const profile = await profileRes.json();
        activeToken = token;

        // Get Key
        const keyRes = await fetch(`${API_BASE}/config/here-key?session_token=${activeToken}`);
        const keyData = await keyRes.json();
        HERE_API_KEY = keyData.key;

        await getUserLocation();
        initMap();
        setupControls();
        
      } catch (err) {
        console.error(err);
        showError('Erreur', 'Impossible de charger la carte');
      }
    }

    async function getUserLocation() {
      return new Promise(resolve => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            userGpsLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, source: 'gps' };
            currentLocation = { ...userGpsLocation };
            resolve();
          }, () => resolve(), { timeout: 5000 });
        } else resolve();
      });
    }

    function initMap() {
      const platform = new H.service.Platform({ apikey: HERE_API_KEY });
      const defaultLayers = platform.createDefaultLayers();
      map = new H.Map(document.getElementById('map'), defaultLayers.vector.normal.map, {
        center: currentLocation, zoom: 13, pixelRatio: window.devicePixelRatio || 1
      });
      new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
      ui = H.ui.UI.createDefault(map, defaultLayers);

      map.addEventListener('mapviewchangeend', () => {
        if (reloadTimeout) clearTimeout(reloadTimeout);
        reloadTimeout = setTimeout(() => {
          const center = map.getCenter();
          currentLocation.lat = center.lat;
          currentLocation.lng = center.lng;
          loadNearbyUsers();
        }, 800);
      });
      
      // Marker Moi
      const meIcon = new H.map.Icon(createDropletIcon('#3B82F6', 100), { size: { w: 60, h: 60 }, anchor: { x: 30, y: 30 }});
      map.addObject(new H.map.Marker(currentLocation, { icon: meIcon }));
      
      loadNearbyUsers();
    }

    async function loadNearbyUsers() {
      try {
        document.getElementById('loading').style.display = 'flex';
        const res = await fetch(`${API_BASE}/users/nearby?lat=${currentLocation.lat}&lng=${currentLocation.lng}&radius=${currentRadius}&session_token=${activeToken}`);
        const data = await res.json();
        usersData = data.users || [];
        
        document.getElementById('userCount').textContent = usersData.length;
        suggestionsData = usersData.filter(u => u.latest_suggestion);
        document.getElementById('suggestionCount').textContent = suggestionsData.length;
        
        updateMarkers();
        updateUserCards();
        document.getElementById('loading').style.display = 'none';
      } catch (e) { console.error(e); document.getElementById('loading').style.display = 'none'; }
    }

    function updateMarkers() {
      if (clusteringLayer) map.removeLayer(clusteringLayer);
      markers.forEach(m => map.removeObject(m));
      markers = [];
      
      const dataPoints = usersData.map((u, i) => new H.clustering.DataPoint(u.location.lat, u.location.lng, null, { user: u, index: i }));
      
      const provider = new H.clustering.Provider(dataPoints, {
        clusteringOptions: { eps: 64, minWeight: 1 },
        theme: {
          getClusterPresentation: cluster => new H.map.Marker(cluster.getPosition(), {
            icon: new H.map.Icon(createClusterIcon(cluster.getWeight()), { size: {w:60, h:60}, anchor:{x:30,y:30} }),
            min: cluster.getMinZoom(), max: cluster.getMaxZoom()
          }),
          getNoisePresentation: point => {
            const u = point.getData().user;
            const marker = new H.map.Marker(point.getPosition(), {
              icon: new H.map.Icon(createDropletIcon(MARKER_COLORS[point.getData().index % 5], u.compatibility_score, u.plan), { size:{w:60,h:60}, anchor:{x:30,y:30} })
            });
            // Click Tooltip
            marker.addEventListener('tap', () => {
              // Highlight card
              highlightUserCard(point.getData().index);
              // Show bubble
              const bubble = new H.ui.InfoBubble(point.getPosition(), {
                content: `<div style="padding:10px; font-family:'Inter',sans-serif; color:#0f172a;">
                  <b>${u.anonymous_display || u.pseudo}</b><br>
                  ${u.latest_suggestion || 'Dispo'}<br>
                  <button onclick="contactUser('${u.id}')" style="margin-top:5px; background:#f97316; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Contacter</button>
                </div>`
              });
              ui.addBubble(bubble);
            });
            return marker;
          }
        }
      });
      clusteringLayer = new H.map.layer.ObjectLayer(provider);
      map.addLayer(clusteringLayer);
    }

    // üìú NAVIGATION BOTTOM SHEET & FL√àCHES
    
    function updateUserCards() {
      const grid = document.getElementById('usersGrid');
      grid.innerHTML = '';
      
      if(usersData.length === 0) {
        grid.innerHTML = '<div style="color:#94a3b8; width:100%; text-align:center; padding-top:20px;">Personne ici ü¶ó</div>';
        return;
      }

      usersData.forEach((u, i) => {
        const div = document.createElement('div');
        div.className = 'user-card';
        div.dataset.index = i;
        div.onclick = (e) => {
            if(e.target.tagName !== 'BUTTON') {
                map.setCenter(u.location); map.setZoom(15);
                highlightUserCard(i);
            }
        };
        
        const pseudo = u.anonymous_display || u.pseudo;
        div.innerHTML = `
          <div class="user-header">
            <div class="user-avatar">${pseudo.substring(0,2).toUpperCase()}</div>
            <div class="user-info">
              <h3>${pseudo}</h3>
              <div class="user-distance">${u.distance ? u.distance+' km' : ''}</div>
            </div>
          </div>
          <div style="font-size:14px; color:rgba(255,255,255,0.9); margin-bottom:10px;">${u.latest_suggestion || 'Disponible'}</div>
          <button class="btn btn-primary" onclick="contactUser('${u.id}')">Contacter</button>
        `;
        grid.appendChild(div);
      });
      
      updateArrows();
    }

    // Gestion du Scroll Horizontal
    const grid = document.getElementById('usersGrid');
    const arrowLeft = document.getElementById('arrowLeft');
    const arrowRight = document.getElementById('arrowRight');

    function scrollUsers(offset) {
        grid.scrollBy({ left: offset, behavior: 'smooth' });
    }

    function updateArrows() {
        // Afficher/Masquer fl√®ches selon position scroll
        if(grid.scrollLeft > 20) arrowLeft.classList.add('visible');
        else arrowLeft.classList.remove('visible');
        
        if(grid.scrollLeft < (grid.scrollWidth - grid.clientWidth - 20)) arrowRight.classList.add('visible');
        else arrowRight.classList.remove('visible');
    }

    grid.addEventListener('scroll', updateArrows);
    window.addEventListener('resize', updateArrows);

    function highlightUserCard(i) {
      document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
      const card = document.querySelector(`.user-card[data-index="${i}"]`);
      if(card) {
          card.classList.add('active');
          card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    }

    function setupControls() {
        // Distance
        document.querySelectorAll('.distance-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.distance-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                currentRadius = parseInt(btn.dataset.radius);
                loadNearbyUsers();
                if(currentRadius <= 5) map.setZoom(14);
                else if(currentRadius >= 50) map.setZoom(10);
                else map.setZoom(12);
            };
        });
        
        // Search
        const input = document.getElementById('citySearchInput');
        const results = document.getElementById('searchAutocomplete');
        
        input.oninput = (e) => {
            const q = e.target.value;
            if(q.length < 3) { results.classList.remove('show'); return; }
            if(searchAutocompleteTimeout) clearTimeout(searchAutocompleteTimeout);
            
            searchAutocompleteTimeout = setTimeout(async () => {
                const res = await fetch(`https://autosuggest.search.hereapi.com/v1/autosuggest?q=${encodeURIComponent(q)}&at=${currentLocation.lat},${currentLocation.lng}&limit=5&apiKey=${HERE_API_KEY}`);
                const data = await res.json();
                if(data.items.length) {
                    results.innerHTML = data.items.map(i => `
                        <div class="search-autocomplete-item" onclick="selectCity(${i.position.lat}, ${i.position.lng}, '${i.title.replace(/'/g,"\\'")}')">
                            ${i.title}
                        </div>
                    `).join('');
                    results.classList.add('show');
                }
            }, 400);
        };
    }

    window.selectCity = (lat, lng, name) => {
        document.getElementById('searchAutocomplete').classList.remove('show');
        document.getElementById('citySearchInput').value = '';
        currentLocation = { lat, lng };
        map.setCenter(currentLocation);
        map.setZoom(13);
        document.getElementById('locationText').textContent = name;
        loadNearbyUsers();
    };

    window.contactUser = (id) => alert('Messagerie : Arrive Samedi !');
    
    function showError(t, m) {
        document.getElementById('loading').style.display='none';
        document.getElementById('errorScreen').style.display='flex';
        document.getElementById('errorTitle').textContent=t;
        document.getElementById('errorMessage').textContent=m;
    }

    init();
  </script>
</body>
</html>
