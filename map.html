<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Carte MeeTempers - MeeTempo</title>
  
  <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               img-src https: data: blob:; 
               script-src 'self' https://js.api.here.com 'unsafe-inline' 'unsafe-eval'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://js.api.here.com; 
               font-src https://fonts.gstatic.com https://js.api.here.com; 
               worker-src blob:; 
               connect-src 'self' blob: https://api.meetempo.com https://*.hereapi.com https://js.api.here.com;">
               
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-clustering.js"></script>
  
  <style>
    :root {
      --mt-dark: #030E4F;
      --mt-accent: #F49F1C;
      --mt-bg: #0a133f;
      --mt-card: #0e184f;
      --mt-text: #ffffff;
      --mt-muted: #c9d1ff;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: Montserrat, sans-serif;
      background: var(--mt-bg);
      color: var(--mt-text);
      overflow: hidden;
      height: 100vh;
      touch-action: pan-y;
    }
    
    /* Top Bar */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; box-shadow: 0 2px 20px rgba(0,0,0,0.3); z-index: 1000;
    }
    
    .logo-section { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    
    .logo-badge {
      width: 36px; height: 36px; border-radius: 50%;
      background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 800; font-size: 18px;
    }
    
    .top-bar h1 { font-size: 18px; font-weight: 700; }
    
    .stats { display: flex; align-items: center; gap: 12px; font-size: 13px; }
    .stat-item {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.1); padding: 6px 10px;
      border-radius: 16px; cursor: pointer; transition: all 0.2s;
    }
    .stat-item:hover { background: rgba(255,255,255,0.15); }
    
    /* Search Bar */
    .search-bar {
      position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 500px; z-index: 999;
    }
    .search-wrapper {
      display: flex; gap: 8px; background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px); border-radius: 16px;
      padding: 12px 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
    }
    .search-icon { font-size: 20px; color: #666; }
    #citySearchInput {
      flex: 1; border: none; background: transparent;
      font-size: 16px; font-family: 'Montserrat', sans-serif; color: #1a1a1a; outline: none;
    }
    
    /* Autocomplete */
    .search-autocomplete-results {
      display: none; position: absolute; top: calc(100% + 8px); left: 0; right: 0;
      background: rgba(14, 24, 79, 0.98); border: 2px solid var(--mt-accent);
      border-radius: 12px; max-height: 400px; overflow-y: auto; z-index: 10000;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }
    .search-autocomplete-results.show { display: block; }
    .search-autocomplete-item {
      padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex; align-items: start; gap: 12px;
    }
    .search-autocomplete-item:hover { background: rgba(244, 159, 28, 0.2); }
    .search-autocomplete-title { font-size: 14px; font-weight: 600; color: var(--mt-text); }
    .search-autocomplete-subtitle { font-size: 12px; color: var(--mt-muted); }

    /* Controls */
    .distance-selector {
      position: fixed; top: 140px; right: 20px;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      border: 1px solid rgba(255,255,255,0.12); backdrop-filter: blur(6px);
      border-radius: 12px; padding: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 999;
    }
    .distance-buttons { display: flex; gap: 6px; flex-wrap: wrap; max-width: 120px; justify-content: center; }
    .distance-btn {
      padding: 6px 12px; border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px; background: rgba(255,255,255,0.08); color: var(--mt-text);
      font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit;
    }
    .distance-btn.active { background: var(--mt-accent); color: #111; border-color: var(--mt-accent); }

    .my-location-btn {
      position: fixed; top: 260px; right: 20px;
      width: 48px; height: 48px; background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      border: 1px solid rgba(255,255,255,0.12); backdrop-filter: blur(6px);
      border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 999;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
    }

    /* Map */
    #map { position: fixed; top: 60px; left: 0; right: 0; bottom: 200px; width: 100%; }

    /* Bottom Sheet & Navigation Arrows */
    .bottom-sheet {
      position: fixed; bottom: 0; left: 0; right: 0; height: 200px;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      border-top-left-radius: 24px; border-top-right-radius: 24px;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.4); z-index: 999;
      transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .bottom-sheet.expanded { height: 60vh; }
    
    .sheet-handle {
      width: 40px; height: 4px; background: rgba(255,255,255,0.3);
      border-radius: 2px; margin: 12px auto; cursor: grab;
    }
    
    .sheet-content { padding: 0 40px 20px 40px; overflow: hidden; height: calc(100% - 28px); position: relative; }
    
    .users-grid {
      display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px;
      scroll-behavior: smooth;
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    .users-grid::-webkit-scrollbar { display: none; }

    /* üî• FL√àCHES DE NAVIGATION */
    .scroll-btn {
      position: absolute; top: 40%; transform: translateY(-50%);
      width: 36px; height: 36px; border-radius: 50%;
      background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2);
      color: white; font-size: 18px; cursor: pointer; z-index: 1002;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .scroll-btn:hover { background: var(--mt-accent); border-color: var(--mt-accent); box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .scroll-btn.left { left: 5px; }
    .scroll-btn.right { right: 5px; }
    
    @media (max-width: 640px) {
        .scroll-btn { display: none; } /* Pas de fl√®ches sur mobile (swipe naturel) */
        .sheet-content { padding: 0 20px 20px 20px; }
    }

    .bottom-sheet.expanded .users-grid { flex-direction: column; overflow-x: visible; overflow-y: auto; height: 100%; }
    .bottom-sheet.expanded .scroll-btn { display: none; }

    /* User Card */
    .user-card {
      min-width: 280px; background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12); backdrop-filter: blur(6px);
      border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s;
    }
    .user-card:hover, .user-card.active {
      transform: translateY(-4px); box-shadow: 0 8px 25px rgba(244,159,28,0.3);
      border-color: var(--mt-accent);
    }
    
    .user-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .user-avatar {
      width: 44px; height: 44px; border-radius: 50%;
      background: conic-gradient(from 0deg, var(--mt-accent), #ffca63, var(--mt-accent));
      display: flex; align-items: center; justify-content: center;
      color: #111; font-weight: 700; font-size: 16px; flex-shrink: 0;
    }
    .user-info h3 { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
    .user-distance { font-size: 12px; color: var(--mt-muted); }
    
    .btn {
      flex: 1; padding: 8px 12px; border: none; border-radius: 8px;
      font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit;
    }
    .btn-primary { background: var(--mt-accent); color: #111; }
    
    /* Loading & Error */
    .loading, .error-screen {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
    }
    .spinner {
      width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1);
      border-top-color: var(--mt-accent); border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-screen { display: none; }
    .error-screen.show { display: flex; }

    /* Suggestions Panel */
    .suggestions-panel {
      position: fixed; top: 60px; right: -400px; width: 400px; height: calc(100vh - 60px);
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      box-shadow: -4px 0 30px rgba(0,0,0,0.4); z-index: 1001;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
    }
    .suggestions-panel.open { right: 0; }
    .panel-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
    .close-btn { background: rgba(255,255,255,0.1); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; color: #fff; }
    .panel-content { flex: 1; overflow-y: auto; padding: 16px; }
    .suggestion-item {
      background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer;
    }
    
    @media (max-width: 640px) {
      .top-bar { height: 56px; padding: 0 12px; }
      .search-bar { top: 66px; width: calc(100% - 24px); }
      .distance-selector { top: 135px; right: 12px; }
      #map { top: 56px; }
      .my-location-btn { top: 210px; right: 12px; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div class="loading-text" style="margin-top:20px; color:#c9d1ff;">Chargement de la carte...</div>
  </div>
  
  <div id="errorScreen" class="error-screen">
    <div class="error-content" style="text-align:center;">
      <div style="font-size:64px; margin-bottom:20px;">‚ùå</div>
      <h2 id="errorTitle" style="font-size:24px; font-weight:700; margin-bottom:12px;">Erreur</h2>
      <p id="errorMessage" style="color:#c9d1ff; margin-bottom:24px;">Une erreur est survenue</p>
      <button class="btn btn-primary" onclick="goBackToHub()" style="padding:12px 24px; width:auto;">Retour au Hub</button>
    </div>
  </div>
  
  <div class="top-bar">
    <div class="logo-section" onclick="goBackToHub()">
      <div class="logo-badge">‚¨ÖÔ∏è</div>
      <h1>Hub</h1>
    </div>
    <div class="stats" id="statsHeader">
      <div class="stat-item"><span>üìç</span><span id="locationText">Paris</span></div>
      <div class="stat-item"><span>üë•</span><span id="userCount">0</span></div>
      <div class="stat-item" onclick="openSuggestionsList()" style="cursor: pointer;"><span>üìã</span><span id="suggestionCount">0</span></div>
      <div class="stat-item"><span>üìè</span><span id="radiusText">20 km</span></div>
      <div class="stat-item" id="visibilityToggle" onclick="toggleVisibility()"><span id="visibilityIcon">üëÅÔ∏è</span><span id="visibilityText">Visible</span></div>
    </div>
  </div>
  
  <div class="search-bar">
    <div class="search-wrapper">
      <span class="search-icon">üîç</span>
      <input type="text" id="citySearchInput" placeholder="O√π aller ?" autocomplete="off">
      <div id="searchAutocomplete" class="search-autocomplete-results"></div>
    </div>
  </div>
  
  <div class="distance-selector">
    <div class="distance-label" style="font-size:11px; color:#c9d1ff; font-weight:600; text-align:center; margin-bottom:8px;">RAYON</div>
    <div class="distance-buttons">
      <button class="distance-btn" data-radius="5">5 km</button>
      <button class="distance-btn" data-radius="10">10 km</button>
      <button class="distance-btn active" data-radius="20">20 km</button>
      <button class="distance-btn" data-radius="50">50 km</button>
    </div>
  </div>

  <button class="my-location-btn" onclick="goToMyLocation()" title="Recentrer sur ma position">üéØ</button>
  
  <div id="map"></div>
  
  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-handle" id="sheetHandle"></div>
    <div class="sheet-content">
      <button class="scroll-btn left" onclick="scrollGrid(-300)">‚ùÆ</button>
      <div class="users-grid" id="usersGrid"></div>
      <button class="scroll-btn right" onclick="scrollGrid(300)">‚ùØ</button>
    </div>
  </div>

  <div class="suggestions-panel" id="suggestionsPanel">
    <div class="panel-header">
      <h2>üìã Suggestions √† proximit√©</h2>
      <button class="close-btn" onclick="closeSuggestionsPanel()">‚úï</button>
    </div>
    <div class="panel-content" id="suggestionsList"></div>
    <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreSuggestions()" style="display: none; margin:16px; padding:12px; background:#F49F1C; border:none; border-radius:10px; cursor:pointer; font-weight:600;">üîç Voir plus loin</button>
  </div>

  <script>
    // === BLOC UNIVERSEL TOKEN ===
    (function() {
      const params = new URLSearchParams(location.search);
      window.MT_TOKEN = params.get('session_token') || params.get('token') || params.get('t')
                       || localStorage.getItem('session_token') || sessionStorage.getItem('meetempo_token');
      if (window.MT_TOKEN) {
        localStorage.setItem('session_token', window.MT_TOKEN);
        sessionStorage.setItem('meetempo_token', window.MT_TOKEN);
      }
    })();

    // üî• NOUVEAU : Fonction retour s√©curis√©e
    function goBackToHub() {
        const t = window.MT_TOKEN || localStorage.getItem('session_token');
        window.location.href = t ? `hub.html?session_token=${t}` : 'hub.html';
    }

    // üî• NOUVEAU : Scroll horizontal liste
    function scrollGrid(offset) {
        const grid = document.getElementById('usersGrid');
        grid.scrollBy({ left: offset, behavior: 'smooth' });
    }

    const API_BASE = 'https://api.meetempo.com';
    let token = window.MT_TOKEN;
    let activeToken = null;
    let HERE_API_KEY = null;
    let map;
    let ui;
    let userGpsLocation = { lat: 48.8566, lng: 2.3522, source: 'default' };
    let currentLocation = { lat: 48.8566, lng: 2.3522 };
    let currentRadius = 20;
    let markers = [];
    let usersData = [];
    let clusteringLayer = null;
    let isManualRadius = false;
    let suggestionsData = [];
    let allSuggestionsData = [];
    let reloadTimeout = null;
    let searchAutocompleteTimeout = null;
    let lastReverseGeocodingCall = 0;
    
    const MARKER_COLORS = ['#F49F1C', '#3B82F6', '#10B981', '#8B5CF6', '#EF4444', '#F59E0B', '#06B6D4', '#EC4899'];

    // üî• NOUVEAU DESIGN : Cluster "Orbe Lumineux"
    function createClusterIcon(count) {
      return `<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feComposite in="SourceGraphic" in2="blur" operator="over"/>
          </filter>
        </defs>
        <circle cx="30" cy="30" r="22" fill="#F49F1C" opacity="0.3" />
        <circle cx="30" cy="30" r="16" fill="#F49F1C" stroke="#fff" stroke-width="2" />
        <text x="30" y="35" text-anchor="middle" font-family="Montserrat, sans-serif" font-size="14" font-weight="800" fill="#fff">${count}</text>
      </svg>`;
    }
    
    // üî• NOUVEAU DESIGN : Pin "Tech" (Rond pur + Bordure N√©on)
    function createDropletIcon(color, affinityScore = 50, plan = "free", visibility = "visible") {
      const ringColor = getAffinityColor(affinityScore);
      let glowColor = 'none';
      let glowOpacity = 0;
      
      if (plan === 'vip') { glowColor = '#FFD700'; glowOpacity = 0.5; } 
      else if (visibility === 'discret') { glowColor = '#1e293b'; glowOpacity = 0.5; }
      
      return `<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg">
        ${glowOpacity > 0 ? `<circle cx="30" cy="30" r="24" fill="${glowColor}" opacity="${glowOpacity}" />` : ''}
        <circle cx="30" cy="30" r="18" fill="#030E4F" />
        <circle cx="30" cy="30" r="16" fill="none" stroke="${ringColor}" stroke-width="3" />
        <text x="30" y="34" font-family="Montserrat, sans-serif" font-size="11" font-weight="700" fill="#fff" text-anchor="middle">${affinityScore}</text>
        <path d="M26 44 L30 50 L34 44 Z" fill="${ringColor}" />
      </svg>`;
    }

    function getAffinityColor(score) {
      if (score >= 80) return '#10B981';
      if (score >= 60) return '#F49F1C';
      if (score >= 40) return '#3B82F6';
      return '#9CA3AF';
    }

    // === Logique Initiale & HERE Maps ===
    // (J'ai conserv√© toute ta logique m√©tier existante)

    async function init() {
        if (!token) { showError('Token manquant', 'Acc√®s depuis MeeTempo GPT requis'); return; }
        
        try {
            // Validation Session
            const profileRes = await fetch(`${API_BASE}/profile?session_token=${token}`);
            if(profileRes.ok) {
                const p = await profileRes.json();
                if(p.user_id) activeToken = token;
            }
            if(!activeToken) { showError('Session invalide', 'Reconnectez-vous'); return; }

            // Config HERE
            const keyRes = await fetch(`${API_BASE}/config/here-key?session_token=${activeToken}`);
            const keyData = await keyRes.json();
            HERE_API_KEY = keyData.key;

            await getUserLocation();
            initMap();
            setupControls();
            
        } catch(e) { console.error(e); showError('Erreur', 'Impossible de charger'); }
    }

    async function getUserLocation() {
        return new Promise(resolve => {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userGpsLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, source:'gps' };
                    currentLocation = {...userGpsLocation};
                    resolve();
                }, () => resolve(), {timeout: 5000});
            } else resolve();
        });
    }

    function initMap() {
        const platform = new H.service.Platform({ apikey: HERE_API_KEY });
        const defaultLayers = platform.createDefaultLayers();
        map = new H.Map(document.getElementById('map'), defaultLayers.vector.normal.map, {
            center: currentLocation, zoom: 13, pixelRatio: window.devicePixelRatio || 1
        });
        new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
        ui = H.ui.UI.createDefault(map, defaultLayers);

        map.addEventListener('mapviewchangeend', () => {
            if(reloadTimeout) clearTimeout(reloadTimeout);
            reloadTimeout = setTimeout(() => {
                const center = map.getCenter();
                currentLocation = {lat: center.lat, lng: center.lng};
                loadNearbyUsers();
            }, 800);
        });
        
        // Marker Moi
        const meIcon = new H.map.Icon(createDropletIcon('#3B82F6', 100), {size:{w:60,h:60}, anchor:{x:30,y:30}});
        map.addObject(new H.map.Marker(currentLocation, {icon: meIcon}));
        
        loadNearbyUsers();
    }

    async function loadNearbyUsers() {
        try {
            document.getElementById('loading').style.display='flex';
            const res = await fetch(`${API_BASE}/users/nearby?lat=${currentLocation.lat}&lng=${currentLocation.lng}&radius=${currentRadius}&session_token=${activeToken}`);
            const data = await res.json();
            usersData = data.users || [];
            
            document.getElementById('userCount').textContent = usersData.length;
            suggestionsData = usersData.filter(u => u.latest_suggestion);
            document.getElementById('suggestionCount').textContent = suggestionsData.length;
            
            updateMarkers();
            updateUserCards();
            document.getElementById('loading').style.display='none';
        } catch(e) { console.error(e); }
    }

    function updateMarkers() {
        if(clusteringLayer) map.removeLayer(clusteringLayer);
        markers.forEach(m => map.removeObject(m));
        markers = [];
        
        const dataPoints = usersData.map((u,i) => new H.clustering.DataPoint(u.location.lat, u.location.lng, null, {user:u, index:i}));
        const provider = new H.clustering.Provider(dataPoints, {
            clusteringOptions: {eps:64, minWeight:1},
            theme: {
                getClusterPresentation: cluster => new H.map.Marker(cluster.getPosition(), {
                    icon: new H.map.Icon(createClusterIcon(cluster.getWeight()), {size:{w:60,h:60}, anchor:{x:30,y:30}}),
                    min: cluster.getMinZoom(), max: cluster.getMaxZoom()
                }),
                getNoisePresentation: point => {
                    const u = point.getData().user;
                    const marker = new H.map.Marker(point.getPosition(), {
                        icon: new H.map.Icon(createDropletIcon(MARKER_COLORS[point.getData().index%5], u.compatibility_score, u.plan), {size:{w:60,h:60}, anchor:{x:30,y:30}})
                    });
                    marker.addEventListener('tap', () => {
                        highlightUserCard(point.getData().index);
                        const bubble = new H.ui.InfoBubble(point.getPosition(), {
                            content: `<div style="padding:10px; font-family:Montserrat,sans-serif; color:#030E4F;">
                                <b>${u.anonymous_display||u.pseudo}</b><br>
                                ${u.latest_suggestion||'Dispo'}<br>
                                <button onclick="contactUser('${u.id}')" style="margin-top:5px; background:#F49F1C; border:none; padding:5px; border-radius:5px; cursor:pointer;">Contacter</button>
                            </div>`
                        });
                        ui.addBubble(bubble);
                    });
                    return marker;
                }
            }
        });
        clusteringLayer = new H.map.layer.ObjectLayer(provider);
        map.addLayer(clusteringLayer);
    }

    function updateUserCards() {
        const grid = document.getElementById('usersGrid');
        grid.innerHTML = '';
        if(usersData.length === 0) { grid.innerHTML = '<div style="color:#c9d1ff; width:100%; text-align:center; padding-top:20px;">Personne ici ü¶ó</div>'; return; }

        usersData.forEach((u, i) => {
            const div = document.createElement('div');
            div.className = 'user-card';
            div.dataset.index = i;
            div.onclick = (e) => {
                if(e.target.tagName !== 'BUTTON') {
                    map.setCenter(u.location); map.setZoom(15);
                    highlightUserCard(i);
                }
            };
            const pseudo = u.anonymous_display || u.pseudo;
            div.innerHTML = `
                <div class="user-header">
                    <div class="user-avatar">${pseudo.substring(0,2).toUpperCase()}</div>
                    <div class="user-info"><h3>${pseudo}</h3><div class="user-distance">${u.distance} km</div></div>
                </div>
                <div style="font-size:14px; margin-bottom:10px;">${u.latest_suggestion || 'Disponible'}</div>
                <button class="btn btn-primary" onclick="contactUser('${u.id}')">Contacter</button>
            `;
            grid.appendChild(div);
        });
    }

    function highlightUserCard(i) {
        document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
        const card = document.querySelector(`.user-card[data-index="${i}"]`);
        if(card) { card.classList.add('active'); card.scrollIntoView({behavior:'smooth', inline:'center'}); }
    }

    function setupControls() {
        // Distance buttons logic
        document.querySelectorAll('.distance-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.distance-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRadius = parseInt(btn.dataset.radius);
                loadNearbyUsers();
                if(currentRadius <= 5) map.setZoom(14);
                else if(currentRadius >= 50) map.setZoom(10);
                else map.setZoom(12);
            }
        });
        
        // Search logic
        const input = document.getElementById('citySearchInput');
        const res = document.getElementById('searchAutocomplete');
        input.oninput = (e) => {
            const q = e.target.value;
            if(q.length < 3) { res.classList.remove('show'); return; }
            if(searchAutocompleteTimeout) clearTimeout(searchAutocompleteTimeout);
            searchAutocompleteTimeout = setTimeout(async () => {
                const response = await fetch(`https://autosuggest.search.hereapi.com/v1/autosuggest?q=${encodeURIComponent(q)}&at=${currentLocation.lat},${currentLocation.lng}&limit=5&apiKey=${HERE_API_KEY}`);
                const data = await response.json();
                if(data.items.length) {
                    res.innerHTML = data.items.map(i => `<div class="search-autocomplete-item" onclick="selectCity(${i.position.lat}, ${i.position.lng}, '${i.title.replace(/'/g,"\\'")}')"><div class="search-autocomplete-title">${i.title}</div></div>`).join('');
                    res.classList.add('show');
                }
            }, 400);
        }
    }

    window.selectCity = (lat, lng, name) => {
        document.getElementById('searchAutocomplete').classList.remove('show');
        document.getElementById('citySearchInput').value = '';
        currentLocation = {lat, lng};
        map.setCenter(currentLocation); map.setZoom(13);
        document.getElementById('locationText').textContent = name;
        loadNearbyUsers();
    }

    window.contactUser = () => alert('Messagerie : Arrive Samedi !');
    window.goToMyLocation = () => {
        if(userGpsLocation.source === 'gps') { currentLocation={...userGpsLocation}; map.setCenter(currentLocation); loadNearbyUsers(); }
        else alert('GPS non dispo');
    }
    window.toggleVisibility = () => alert('Toggle visibilit√© (simulation)');
    window.openSuggestionsList = () => document.getElementById('suggestionsPanel').classList.add('open');
    window.closeSuggestionsPanel = () => document.getElementById('suggestionsPanel').classList.remove('open');
    window.loadMoreSuggestions = () => { currentRadius+=10; loadNearbyUsers(); };

    function setupBottomSheet() {
      const sheet = document.getElementById('bottomSheet');
      const handle = document.getElementById('sheetHandle');
      handle.addEventListener('click', () => { sheet.classList.toggle('expanded'); if(sheet.classList.contains('expanded')) sheet.style.height='60vh'; else sheet.style.height='200px'; });
    }

    function showError(t, m) {
        document.getElementById('loading').style.display='none';
        document.getElementById('errorScreen').style.display='flex';
        document.getElementById('errorTitle').textContent=t;
        document.getElementById('errorMessage').textContent=m;
    }

    init();
    setupBottomSheet();
  </script>
</body>
</html>
