<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte MeeTempers - MeeTempo</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- HERE Maps -->
  <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-clustering.js"></script>
  
  <style>
    :root {
      --mt-dark: #030E4F;
      --mt-accent: #F49F1C;
      --mt-bg: #0a133f;
      --mt-card: #0e184f;
      --mt-text: #ffffff;
      --mt-muted: #c9d1ff;
      --ok: #23c55e;
      --err: #ef4444;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Montserrat, system-ui, -apple-system, sans-serif;
      background: var(--mt-bg);
      color: var(--mt-text);
      overflow: hidden;
      height: 100vh;
    }
    
    /* Top Bar */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-badge {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, var(--mt-accent), #ffca63, var(--mt-accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111;
      font-weight: 800;
      font-size: 14px;
    }
    
    .top-bar h1 {
      font-size: 18px;
      font-weight: 700;
    }
    
    .stats {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.1);
      padding: 6px 12px;
      border-radius: 20px;
    }
    
    /* Distance Selector */
    .distance-selector {
      position: fixed;
      top: 70px;
      right: 20px;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(6px);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .distance-label {
      font-size: 12px;
      color: var(--mt-muted);
      font-weight: 600;
      text-align: center;
      margin-bottom: 4px;
    }
    
    .distance-buttons {
      display: flex;
      gap: 6px;
    }
    
    .distance-btn {
      padding: 6px 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.08);
      color: var(--mt-text);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .distance-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-1px);
    }
    
    .distance-btn.active {
      background: var(--mt-accent);
      color: #111;
      border-color: var(--mt-accent);
    }
    
    /* Map Container */
    #map {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 200px;
      width: 100%;
    }
    
    /* Bottom Sheet */
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.4);
      z-index: 999;
      overflow: hidden;
    }
    
    .sheet-handle {
      width: 40px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      margin: 12px auto;
    }
    
    .sheet-content {
      padding: 0 20px 20px;
      overflow-y: auto;
      height: calc(100% - 28px);
    }
    
    .users-grid {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .users-grid::-webkit-scrollbar {
      height: 6px;
    }
    
    .users-grid::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 3px;
    }
    
    .users-grid::-webkit-scrollbar-thumb {
      background: var(--mt-accent);
      border-radius: 3px;
    }
    
    .user-card {
      min-width: 280px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(6px);
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .user-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(244,159,28,0.3);
      border-color: var(--mt-accent);
    }
    
    .user-card.active {
      border-color: var(--mt-accent);
      box-shadow: 0 0 0 2px rgba(244,159,28,0.3);
    }
    
    .user-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .user-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, var(--mt-accent), #ffca63, var(--mt-accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111;
      font-weight: 700;
      font-size: 16px;
    }
    
    .user-info h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 2px;
    }
    
    .user-distance {
      font-size: 12px;
      color: var(--mt-muted);
    }
    
    .user-suggestion {
      font-size: 14px;
      margin-bottom: 8px;
      color: #ebefff;
      line-height: 1.4;
    }
    
    .user-location {
      font-size: 13px;
      color: var(--mt-muted);
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .user-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .btn-primary {
      background: var(--mt-accent);
      color: #111;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244,159,28,0.4);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--mt-text);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
    }
    
    /* Loading */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top-color: var(--mt-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      color: var(--mt-muted);
    }
    
    /* Error */
    .error-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      z-index: 2000;
    }
    
    .error-screen.show {
      display: flex;
    }
    
    .error-content {
      max-width: 400px;
    }
    
    .error-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .error-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .error-message {
      font-size: 16px;
      color: var(--mt-muted);
      margin-bottom: 24px;
      line-height: 1.5;
    }
    
    /* Responsive */
    @media (max-width: 640px) {
      .top-bar {
        height: 56px;
        padding: 0 16px;
      }
      
      .top-bar h1 {
        font-size: 16px;
      }
      
      .stats {
        gap: 12px;
        font-size: 13px;
      }
      
      .stat-item {
        padding: 5px 10px;
      }
      
      .distance-selector {
        top: 66px;
        right: 10px;
        padding: 8px;
      }
      
      .distance-buttons {
        flex-wrap: wrap;
      }
      
      .distance-btn {
        font-size: 11px;
        padding: 5px 10px;
      }
      
      #map {
        top: 56px;
        bottom: 180px;
      }
      
      .bottom-sheet {
        height: 180px;
      }
      
      .user-card {
        min-width: 260px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div class="loading-text">Chargement de la carte...</div>
  </div>
  
  <!-- Error Screen -->
  <div id="errorScreen" class="error-screen">
    <div class="error-content">
      <div class="error-icon">‚ùå</div>
      <h2 class="error-title" id="errorTitle">Erreur</h2>
      <p class="error-message" id="errorMessage">Une erreur est survenue</p>
      <button class="btn btn-primary" onclick="window.location.href='https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19'">
        Retour √† MeeTempo
      </button>
    </div>
  </div>
  
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="logo-section">
      <div class="logo-badge">MT</div>
      <h1>üó∫ Carte MeeTempers</h1>
    </div>
    <div class="stats" id="statsHeader">
      <div class="stat-item">
        <span>üìç</span>
        <span id="locationText">Paris</span>
      </div>
      <div class="stat-item">
        <span>üë•</span>
        <span id="userCount">0 MeeTempers</span>
      </div>
      <div class="stat-item">
        <span>üìè</span>
        <span id="radiusText">20 km</span>
      </div>
    </div>
  </div>
  
  <!-- Distance Selector -->
  <div class="distance-selector">
    <div class="distance-label">RAYON DE RECHERCHE</div>
    <div class="distance-buttons">
      <button class="distance-btn" data-radius="5">5 km</button>
      <button class="distance-btn" data-radius="10">10 km</button>
      <button class="distance-btn active" data-radius="20">20 km</button>
      <button class="distance-btn" data-radius="50">50 km</button>
    </div>
  </div>
  
  <!-- Map -->
  <div id="map"></div>
  
  <!-- Bottom Sheet -->
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-content">
      <div class="users-grid" id="usersGrid">
        <!-- User cards dynamically inserted -->
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://api.meetempo.com';
    
    // üé® Palette de couleurs MeeTempo (8 couleurs harmonieuses)
    const MARKER_COLORS = [
      '#F49F1C', // Orange (signature MeeTempo)
      '#3B82F6', // Bleu
      '#10B981', // Vert
      '#8B5CF6', // Violet
      '#EF4444', // Rouge
      '#F59E0B', // Ambre
      '#06B6D4', // Cyan
      '#EC4899'  // Rose
    ];
    
    const params = new URLSearchParams(location.search);
    const token = params.get('token');
    
    let HERE_API_KEY = null;
    let map;
    let ui;
    let currentLocation = { lat: 48.8566, lng: 2.3522 }; // Paris par d√©faut
    let currentRadius = 20; // ‚úÖ D√©faut 20 km
    let markers = [];
    let usersData = [];
    let currentUser = null;
    
    // ‚úÖ Fonction √©chappement HTML (XSS fix)
    function escapeHTML(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    // üé® Fonction pour obtenir couleur par index (rotation tous les 8)
    function getMarkerColor(index) {
      return MARKER_COLORS[index % MARKER_COLORS.length];
    }
    
    // üé® Fonction pour obtenir couleur d'anneau selon score (0-100)
function getAffinityColor(score) {
  if (score >= 80) return '#10B981'; // Vert (excellente affinit√©)
  if (score >= 60) return '#F49F1C'; // Orange (bonne affinit√©)
  if (score >= 40) return '#3B82F6'; // Bleu (affinit√© moyenne)
  return '#9CA3AF'; // Gris (faible affinit√©)
}

// üìç Cr√©er SVG ic√¥ne goutte avec anneau de score
function createDropletIcon(color, affinityScore = 50) {
  const ringColor = getAffinityColor(affinityScore);
  const ringWidth = 4;
  
  return `<svg width="48" height="54" xmlns="http://www.w3.org/2000/svg">
    <!-- Anneau d'affinit√© (cercle ext√©rieur) -->
    <circle cx="24" cy="20" r="20" 
            fill="none" 
            stroke="${ringColor}" 
            stroke-width="${ringWidth}"
            opacity="0.9"/>
    
    <!-- Goutte centrale -->
    <path d="M24 8 C24 8, 14 20, 14 28 C14 33, 18 38, 24 38 C30 38, 34 33, 34 28 C34 20, 24 8, 24 8 Z" 
          fill="${color}" 
          stroke="white" 
          stroke-width="2.5"
          stroke-linejoin="round"/>
    
    <!-- Score textuel (optionnel, pour debug) -->
    <text x="24" y="50" 
          font-family="Montserrat, sans-serif" 
          font-size="9" 
          font-weight="700" 
          fill="${ringColor}" 
          text-anchor="middle">
      ${affinityScore}%
    </text>
  </svg>`;
}
    
    // ‚úÖ Fonction erreur pr√©cise
    function showError(title, message, type = 'unknown') {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorTitle').textContent = title;
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorScreen').classList.add('show');
      
      // Auto-redirect pour session expir√©e
      if (type === 'expired') {
        setTimeout(() => {
          window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
        }, 3000);
      }
    }
    
    // ‚úÖ Init principale
    async function init() {
      if (!token) {
        showError('Token manquant', 'Veuillez acc√©der √† cette page depuis MeeTempo GPT', 'missing');
        return;
      }
      
      try {
        // 1. Valider session
        const sessionResponse = await fetch(`${API_BASE}/auth/session?token=${token}`);
        
        if (!sessionResponse.ok) {
          if (sessionResponse.status === 401) {
            showError('Session expir√©e', 'Votre session a expir√©. Redirection vers MeeTempo GPT...', 'expired');
          } else {
            showError('Erreur serveur', 'Le service est temporairement indisponible. R√©essayez dans quelques instants.', 'server');
          }
          return;
        }
        
        const sessionData = await sessionResponse.json();
        if (!sessionData.user_id) {
          showError('Session invalide', 'Impossible de valider votre session', 'invalid');
          return;
        }
        
        // 2. V√©rifier charte
        const charterResponse = await fetch(`${API_BASE}/consent/status?token=${token}`);
        
        if (charterResponse.ok) {
          const charterData = await charterResponse.json();
          
          if (!charterData.accepted) {
            // Rediriger vers charte avec return URL
            const returnUrl = encodeURIComponent(window.location.href);
            window.location.href = `charter.html?token=${token}&return=${returnUrl}`;
            return;
          }
        }
        
        // 3. Charger cl√© HERE
        const keyResponse = await fetch(`${API_BASE}/config/here-key?token=${token}`);
        
        if (!keyResponse.ok) {
          showError('Erreur configuration', 'Impossible de charger la configuration carte', 'config');
          return;
        }
        
        const keyData = await keyResponse.json();
        HERE_API_KEY = keyData.key;
        
        // 4. G√©olocalisation avec fallback
        await getUserLocation();
        
        // 5. Initialiser carte
        initMap();
        
        // 6. Setup distance selector
        setupDistanceSelector();
        
      } catch (err) {
        console.error('Init error:', err);
        
        if (!navigator.onLine) {
          showError('Pas de connexion', 'V√©rifiez votre connexion internet', 'offline');
        } else {
          showError('Erreur inattendue', 'Une erreur est survenue lors du chargement. R√©essayez.', 'unknown');
        }
      }
    }
    
    // ‚úÖ G√©olocalisation avec fallback
    async function getUserLocation() {
      return new Promise((resolve) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                source: 'gps',
                accuracy: position.coords.accuracy
              };
              console.log('‚úÖ G√©oloc GPS:', currentLocation);
              resolve();
            },
            (error) => {
              console.warn('‚ö†Ô∏è Geoloc failed:', error.message);
              // Fallback Paris
              currentLocation = {
                lat: 48.8566,
                lng: 2.3522,
                source: 'default',
                city: 'Paris'
              };
              resolve();
            },
            { timeout: 5000, enableHighAccuracy: true }
          );
        } else {
          currentLocation = {
            lat: 48.8566,
            lng: 2.3522,
            source: 'default',
            city: 'Paris'
          };
          resolve();
        }
      });
    }
    
    // üéõÔ∏è Setup distance selector
    function setupDistanceSelector() {
      const buttons = document.querySelectorAll('.distance-btn');
      
      buttons.forEach(btn => {
        btn.addEventListener('click', function() {
          const radius = parseInt(this.dataset.radius);
          
          // Update active state
          buttons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Update radius and reload
          currentRadius = radius;
          document.getElementById('radiusText').textContent = `${radius} km`;
          
          // Reload users
          loadNearbyUsers();
        });
      });
    }
    
    // Initialize HERE Map
    function initMap() {
      const platform = new H.service.Platform({
        apikey: HERE_API_KEY
      });
      
      const defaultLayers = platform.createDefaultLayers();
      
      map = new H.Map(
        document.getElementById('map'),
        defaultLayers.vector.normal.map,
        {
          center: currentLocation,
          zoom: 13,
          pixelRatio: window.devicePixelRatio || 1
        }
      );
      
      // Enable map interactions
      const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
      ui = H.ui.UI.createDefault(map, defaultLayers);
      
      // ‚úÖ Resize handler
      window.addEventListener('resize', () => {
        if (map) map.getViewPort().resize();
      });
      
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          if (map) map.getViewPort().resize();
        }, 100);
      });
      
      // Add user position marker (blue droplet)
      const userIcon = new H.map.Icon(createDropletIcon('#3B82F6'), { 
        size: { w: 36, h: 42 },
        anchor: { x: 18, y: 38 }
      });
      
      const userMarker = new H.map.Marker(currentLocation, { icon: userIcon });
      map.addObject(userMarker);
      
      // Load nearby users
      loadNearbyUsers();
    }
    
    // ‚úÖ Load nearby users from API
    async function loadNearbyUsers() {
      try {
        // Show loading state
        document.getElementById('loading').style.display = 'flex';
        
        const response = await fetch(
          `${API_BASE}/users/nearby?lat=${currentLocation.lat}&lng=${currentLocation.lng}&radius=${currentRadius}&token=${token}`
        );
        
        if (!response.ok) {
          if (response.status === 401) {
            showError('Session expir√©e', 'Votre session a expir√©. Redirection...', 'expired');
          } else if (response.status === 429) {
            showError('Trop de requ√™tes', 'Vous avez effectu√© trop de recherches. R√©essayez dans 1 minute.', 'rate-limit');
          } else if (response.status >= 500) {
            showError('Service indisponible', 'Nos serveurs rencontrent un probl√®me. R√©essayez.', 'server');
          } else {
            throw new Error('Failed to load users');
          }
          return;
        }
        
        const data = await response.json();
        usersData = data.users || [];
        
        // ‚úÖ Update stats header
        document.getElementById('userCount').textContent = `${usersData.length} MeeTemper${usersData.length > 1 ? 's' : ''}`;
        document.getElementById('locationText').textContent = currentLocation.city || 'Paris';
        
        // Add markers
        addMarkersToMap(usersData);
        
        // Populate bottom sheet
        populateUserCards(usersData);
        
        // Hide loading
        document.getElementById('loading').style.display = 'none';
        
      } catch (err) {
        console.error('Error loading users:', err);
        showError('Erreur chargement', 'Impossible de charger les MeeTempers √† proximit√©', 'load');
      }
    }
    
    // üé® Add markers to map with colored droplets
    function addMarkersToMap(users) {
      // Clear existing markers (except user marker)
      markers.forEach(m => map.removeObject(m));
      markers = [];
      
      users.forEach((user, index) => {
        // üé® Get color for this user (rotation every 8)
        const color = getMarkerColor(index);
        
        // üî• NOUVEAU : Utiliser le score d'affinit√©
    const affinityScore = user.compatibility_score || 50;
    
    // üìç Create droplet icon AVEC anneau de score
    const markerIcon = new H.map.Icon(createDropletIcon(color, affinityScore), {
      size: { w: 48, h: 54 },
      anchor: { x: 24, y: 50 }
    });
    
    const marker = new H.map.Marker(user.location, { icon: markerIcon });
    marker.setData({ userId: user.id, index, affinityScore });
    
    // ‚úÖ Add tooltip AVEC score
    marker.addEventListener('tap', function(evt) {
      const data = evt.target.getData();
      const bubble = new H.ui.InfoBubble(evt.target.getGeometry(), {
        content: `
          <div style="padding: 8px; font-family: Montserrat, sans-serif;">
            <div style="font-weight: 700; font-size: 14px; margin-bottom: 4px;">
              ${escapeHTML(user.pseudo)}
            </div>
            <div style="font-size: 13px; margin-bottom: 4px;">
              ${escapeHTML(user.latest_suggestion)}
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
              üìç ${escapeHTML(user.city)}
            </div>
            <div style="font-size: 12px; font-weight: 600; color: ${getAffinityColor(data.affinityScore)};">
              üéØ Affinit√© : ${data.affinityScore}%
            </div>
          </div>
        `
      });
          ui.addBubble(bubble);
          
          // Highlight card
          highlightUserCard(index);
        });
        
        map.addObject(marker);
        markers.push(marker);
      });
    }
    
    // ‚úÖ Populate user cards
    function populateUserCards(users) {
      const grid = document.getElementById('usersGrid');
      grid.innerHTML = '';
      
      if (users.length === 0) {
        grid.innerHTML = '<div style="padding: 20px; color: var(--mt-muted); text-align: center; width: 100%;">Aucun MeeTemper √† proximit√© pour le moment</div>';
        return;
      }
      
      users.forEach((user, index) => {
        const card = document.createElement('div');
        card.className = 'user-card';
        card.dataset.index = index;
        
        const initials = escapeHTML(user.pseudo.substring(0, 2).toUpperCase());
        const pseudo = escapeHTML(user.pseudo);
        const suggestion = escapeHTML(user.latest_suggestion);
        const city = escapeHTML(user.city);
        const distance = user.distance ? `${user.distance} km` : '√Ä proximit√©';
        const affinityScore = user.compatibility_score || 50;
        const affinityColor = getAffinityColor(affinityScore);

        card.innerHTML = `
          <div class="user-header">
            <div class="user-avatar">${initials}</div>
            <div class="user-info">
              <h3>${pseudo}</h3>
              <div class="user-distance">${distance} ‚Ä¢ <span style="color: ${affinityColor}; font-weight: 600;">üéØ ${affinityScore}%</span></div>
            </div>
          </div>
          <div class="user-suggestion">${suggestion}</div>
          <div class="user-location">üìç ${city}</div>
                  <div class="user-actions">
                    <button class="btn btn-primary" onclick="contactUser('${user.id}')">üí¨ Contacter</button>
                    <button class="btn btn-secondary" onclick="viewProfile('${user.id}')">üëÄ Profil</button>
                  </div>
                `;
        
        card.onclick = function() {
          centerOnMarker(index);
        };
        
        grid.appendChild(card);
      });
    }
    
    // Highlight user card
    function highlightUserCard(index) {
      document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
      const card = document.querySelector(`.user-card[data-index="${index}"]`);
      if (card) {
        card.classList.add('active');
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    }
    
    // Center map on marker
    function centerOnMarker(index) {
      if (usersData[index]) {
        map.setCenter(usersData[index].location);
        map.setZoom(15);
        highlightUserCard(index);
        
        // Simulate marker tap
        if (markers[index]) {
          markers[index].dispatchEvent('tap');
        }
      }
    }
    
    // ‚úÖ Contact user
    function contactUser(userId) {
      alert('üí¨ Messagerie en d√©veloppement\n\nLa messagerie directe arrive bient√¥t !\n\nEn attendant, vous pouvez :\n‚Ä¢ Cr√©er une suggestion publique\n‚Ä¢ Rejoindre un groupe de travail');
    }
    
    // ‚úÖ View profile
    function viewProfile(userId) {
      alert('üëÄ Profil d√©taill√© en d√©veloppement\n\nLes profils d√©taill√©s arrivent bient√¥t !\n\nActuellement disponible dans les cartes utilisateurs.');
    }
    
    // ‚úÖ Cleanup m√©moire
    window.addEventListener('beforeunload', () => {
      if (map) {
        map.dispose();
        map = null;
      }
    });
    
    // Start
    init();
  </script>
</body>
</html>
