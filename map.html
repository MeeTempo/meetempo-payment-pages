<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Carte MeeTempers - MeeTempo</title>
  
  <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               img-src https: data: blob:; 
               script-src 'self' https://js.api.here.com 'unsafe-inline' 'unsafe-eval'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://js.api.here.com; 
               font-src https://fonts.gstatic.com https://js.api.here.com; 
               worker-src blob:; 
               connect-src 'self' blob: https://api.meetempo.com https://*.hereapi.com https://js.api.here.com;">
               
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-clustering.js"></script>
  
  <style>
    :root {
      /* Palette HUB */
      --mt-bg: #0f172a;       /* Fond profond */
      --mt-accent: #f97316;   /* Orange MeeTempo */
      --mt-text: #f8fafc;     /* Blanc cass√© */
      --mt-muted: #94a3b8;    /* Gris bleut√© */
      --glass-bg: rgba(15, 23, 42, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--mt-bg);
      color: var(--mt-text);
      overflow: hidden;
      height: 100vh;
      touch-action: pan-y;
    }
    
    /* === TOP BAR (Glass) === */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      background: var(--glass-bg); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .logo-section { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .logo-badge {
      width: 32px; height: 32px; border-radius: 10px;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 14px; transition: 0.2s;
    }
    .logo-section:hover .logo-badge { background: var(--mt-accent); border-color: var(--mt-accent); }
    .top-bar h1 { font-size: 16px; font-weight: 600; letter-spacing: -0.5px; }
    
    .stats { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .stat-item {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.05); padding: 5px 10px;
      border: 1px solid var(--glass-border); border-radius: 50px;
      cursor: pointer; transition: 0.2s;
    }
    .stat-item:hover { background: rgba(255,255,255,0.1); }
    
    /* === SEARCH BAR === */
    .search-bar {
      position: fixed; top: 75px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 450px; z-index: 999;
    }
    .search-wrapper {
      display: flex; gap: 10px; align-items: center;
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border); border-radius: 50px;
      padding: 12px 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .search-icon { font-size: 16px; color: var(--mt-muted); }
    #citySearchInput {
      flex: 1; border: none; background: transparent;
      font-size: 15px; font-family: 'Inter', sans-serif; color: #fff; outline: none;
    }
    /* Autocomplete */
    .search-autocomplete-results {
      display: none; position: absolute; top: calc(100% + 8px); left: 0; right: 0;
      background: var(--mt-bg); border: 1px solid var(--glass-border);
      border-radius: 16px; max-height: 300px; overflow-y: auto; z-index: 10000;
    }
    .search-autocomplete-results.show { display: block; }
    .search-autocomplete-item {
      padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex; gap: 10px; align-items: center;
    }
    .search-autocomplete-item:hover { background: rgba(255,255,255,0.1); }
    .search-autocomplete-title { font-size: 14px; font-weight: 600; color: #fff; }

    /* === CONTROLS (Rayon) === */
    .distance-selector {
      position: fixed; top: 150px; right: 16px;
      background: var(--glass-bg); backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border); border-radius: 16px;
      padding: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 999;
      display: flex; flex-direction: column; gap: 8px;
    }
    .distance-label { font-size: 10px; color: var(--mt-muted); font-weight: 700; text-align: center; letter-spacing: 1px; }
    .distance-buttons { display: flex; flex-direction: column; gap: 6px; }
    .distance-btn {
      padding: 8px; border: 1px solid transparent; border-radius: 8px;
      background: rgba(255,255,255,0.05); color: var(--mt-muted);
      font-size: 11px; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .distance-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .distance-btn.active { background: var(--mt-accent); color: #fff; box-shadow: 0 2px 10px rgba(249, 115, 22, 0.3); }

    /* === MA POSITION (Cible) === */
    .my-location-btn {
      position: fixed; bottom: 230px; right: 16px; /* Bien au-dessus du volet */
      width: 48px; height: 48px;
      background: var(--mt-accent);
      border: none; border-radius: 50%;
      color: #fff; font-size: 20px;
      box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
      cursor: pointer; z-index: 999;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s;
    }
    .my-location-btn:active { transform: scale(0.95); }

    /* === MAP CONTAINER === */
    #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

    /* === BOTTOM SHEET === */
    .bottom-sheet {
      position: fixed; bottom: 0; left: 0; right: 0; height: 210px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
      z-index: 999; transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .bottom-sheet.expanded { height: 70vh; }
    
    .sheet-handle {
      width: 40px; height: 4px; background: rgba(255,255,255,0.2);
      border-radius: 2px; margin: 12px auto; cursor: grab;
    }
    .sheet-content { padding: 0 20px 20px 20px; height: calc(100% - 30px); position: relative; }
    
    /* GRID & FL√àCHES */
    .users-grid {
      display: flex; gap: 16px; overflow-x: auto; padding: 10px 0 20px 0;
      scroll-behavior: smooth; scrollbar-width: none;
    }
    .users-grid::-webkit-scrollbar { display: none; }
    
    .scroll-btn {
      position: absolute; top: 45%; transform: translateY(-50%);
      width: 36px; height: 36px; border-radius: 50%;
      background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
      color: #fff; font-size: 16px; cursor: pointer; z-index: 1002;
      display: flex; align-items: center; justify-content: center;
      transition: 0.2s; backdrop-filter: blur(4px);
    }
    .scroll-btn:hover { background: var(--mt-accent); border-color: var(--mt-accent); }
    .scroll-btn.left { left: 10px; }
    .scroll-btn.right { right: 10px; }

    /* USER CARD (Style Hub) */
    .user-card {
      min-width: 260px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border);
      border-radius: 16px; padding: 16px;
      cursor: pointer; transition: 0.2s;
    }
    .user-card:hover, .user-card.active {
      background: rgba(255,255,255,0.1);
      border-color: var(--mt-accent);
      transform: translateY(-2px);
    }
    .user-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .user-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 700; font-size: 14px;
    }
    .user-info h3 { font-size: 15px; font-weight: 600; color: #fff; }
    .user-distance { font-size: 12px; color: var(--mt-muted); }
    .user-sugg { font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 12px; line-height: 1.4; }
    
    .btn-action {
      width: 100%; padding: 8px; border-radius: 8px; border: none;
      background: var(--mt-accent); color: #fff; font-weight: 600; font-size: 13px;
      cursor: pointer; box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3);
    }

    /* LOADING & ERROR */
    .loading, .error-screen {
      position: fixed; inset: 0; background: var(--mt-bg);
      display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
    }
    .spinner {
      width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--mt-accent); border-radius: 50%; animation: spin 1s infinite linear;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-screen { display: none; }
    .error-screen.show { display: flex; }

    /* RESPONSIVE */
    @media (max-width: 640px) {
      .top-bar { padding: 0 12px; }
      .search-bar { top: 65px; width: 94%; }
      .distance-selector { top: 125px; right: 10px; }
      .my-location-btn { bottom: 220px; right: 10px; }
      .scroll-btn { display: none; } /* Pas de fl√®ches sur mobile */
      .sheet-content { padding: 0 16px 20px 16px; }
    }
  </style>
</head>
<body>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div style="margin-top:15px; color:#94a3b8; font-size:14px;">Chargement...</div>
  </div>
  
  <div id="errorScreen" class="error-screen">
    <div style="text-align:center;">
      <i class="fas fa-exclamation-triangle" style="font-size:48px; color:#ef4444; margin-bottom:15px;"></i>
      <h2 id="errorTitle" style="margin-bottom:10px;">Erreur</h2>
      <p id="errorMessage" style="color:#94a3b8; margin-bottom:20px;">Une erreur est survenue</p>
      <button class="btn-action" onclick="goBackToHub()" style="width:auto; padding:10px 20px;">Retour au Hub</button>
    </div>
  </div>
  
  <div class="top-bar">
    <div class="logo-section" onclick="goBackToHub()">
      <div class="logo-badge"><i class="fas fa-arrow-left"></i></div>
      <h1>Hub</h1>
    </div>
    <div class="stats" id="statsHeader">
      <div class="stat-item"><i class="fas fa-map-marker-alt" style="color:#f87171;"></i><span id="locationText">Paris</span></div>
      <div class="stat-item"><i class="fas fa-users" style="color:#60a5fa;"></i><span id="userCount">0</span></div>
      <div class="stat-item"><i class="fas fa-list-ul" style="color:var(--mt-accent);"></i><span id="suggestionCount">0</span></div>
      <div class="stat-item" style="display:none;"><span id="radiusText"></span></div> </div>
  </div>
  
  <div class="search-bar">
    <div class="search-wrapper">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="citySearchInput" placeholder="Chercher une ville..." autocomplete="off">
      <div id="searchAutocomplete" class="search-autocomplete-results"></div>
    </div>
  </div>
  
  <div class="distance-selector">
    <div class="distance-label">RAYON</div>
    <div class="distance-buttons">
      <button class="distance-btn" data-radius="5">5k</button>
      <button class="distance-btn" data-radius="10">10k</button>
      <button class="distance-btn active" data-radius="20">20k</button>
      <button class="distance-btn" data-radius="50">50k</button>
    </div>
  </div>

  <button class="my-location-btn" onclick="goToMyLocation()">
    <i class="fas fa-crosshairs"></i>
  </button>
  
  <div id="map"></div>
  
  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-handle" id="sheetHandle"></div>
    <div class="sheet-content">
      <button class="scroll-btn left" onclick="scrollGrid(-300)"><i class="fas fa-chevron-left"></i></button>
      <div class="users-grid" id="usersGrid"></div>
      <button class="scroll-btn right" onclick="scrollGrid(300)"><i class="fas fa-chevron-right"></i></button>
    </div>
  </div>

  <div class="suggestions-panel" id="suggestionsPanel" style="display:none;">
    <div class="panel-header"><h2>Suggestions</h2><button class="close-btn" onclick="closeSuggestionsPanel()">√ó</button></div>
    <div class="panel-content" id="suggestionsList"></div>
    <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreSuggestions()">Voir plus</button>
  </div>

  <script>
    // === 1. GESTION SESSION & RETOUR (S√âCURIS√â) ===
    (function() {
      const params = new URLSearchParams(location.search);
      window.MT_TOKEN = params.get('session_token') || params.get('token') || params.get('t')
                       || localStorage.getItem('session_token') || sessionStorage.getItem('meetempo_token');
      if (window.MT_TOKEN) {
        localStorage.setItem('session_token', window.MT_TOKEN);
        sessionStorage.setItem('meetempo_token', window.MT_TOKEN);
      }
    })();

    // Fonction de retour qui ne perd pas la session
    function goBackToHub() {
        const t = window.MT_TOKEN || localStorage.getItem('session_token');
        window.location.href = t ? `hub.html?session_token=${t}` : 'hub.html';
    }

    // Scroll horizontal pour les fl√®ches
    function scrollGrid(offset) {
        document.getElementById('usersGrid').scrollBy({ left: offset, behavior: 'smooth' });
    }

    // === 2. CONFIGURATION API & VARS ===
    const API_BASE = 'https://api.meetempo.com';
    let token = window.MT_TOKEN;
    let activeToken = null;
    let HERE_API_KEY = null;
    let map, ui;
    let userGpsLocation = { lat: 48.8566, lng: 2.3522, source: 'default' };
    let currentLocation = { lat: 48.8566, lng: 2.3522 };
    let currentRadius = 20;
    let markers = [];
    let usersData = [];
    let suggestionsData = [];
    let clusteringLayer = null;
    let reloadTimeout = null;
    let searchAutocompleteTimeout = null;
    
    // Couleurs pour les cercles
    const MARKER_COLORS = ['#F49F1C', '#3B82F6', '#10B981', '#8B5CF6', '#EF4444'];

    // === 3. NOUVEAUX MARQUEURS (DESIGN N√âON) ===
    
    // Cluster (Groupe)
    function createClusterIcon(count) {
      return `<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg">
        <circle cx="30" cy="30" r="24" fill="#F49F1C" opacity="0.3" />
        <circle cx="30" cy="30" r="18" fill="#F49F1C" stroke="#fff" stroke-width="2" />
        <text x="30" y="36" text-anchor="middle" font-family="'Inter', sans-serif" font-size="14" font-weight="800" fill="#fff">${count}</text>
      </svg>`;
    }
    
    // User (Cercle avec score)
    function createDropletIcon(color, affinityScore = 50, plan = "free", visibility = "visible") {
      const ringColor = getAffinityColor(affinityScore);
      let glowOpacity = 0;
      let glowColor = 'none';
      
      // Halo pour VIP ou mode discret
      if (plan === 'vip') { glowColor = '#FFD700'; glowOpacity = 0.4; } 
      else if (visibility === 'discret') { glowColor = '#1e293b'; glowOpacity = 0.4; }
      
      return `<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg">
        ${glowOpacity > 0 ? `<circle cx="30" cy="30" r="26" fill="${glowColor}" opacity="${glowOpacity}" />` : ''}
        <circle cx="30" cy="30" r="20" fill="#0f172a" /> <circle cx="30" cy="30" r="18" fill="none" stroke="${ringColor}" stroke-width="4" /> <text x="30" y="35" font-family="'Inter', sans-serif" font-size="12" font-weight="700" fill="#fff" text-anchor="middle">${affinityScore}</text>
      </svg>`;
    }

    // Moi (Point bleu pulsant, pas de chiffre)
    function createMeIcon() {
      return `<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg">
        <circle cx="30" cy="30" r="20" fill="#3B82F6" opacity="0.3">
            <animate attributeName="r" from="15" to="25" dur="1.5s" repeatCount="indefinite"/>
            <animate attributeName="opacity" from="0.6" to="0" dur="1.5s" repeatCount="indefinite"/>
        </circle>
        <circle cx="30" cy="30" r="10" fill="#3B82F6" stroke="#fff" stroke-width="2" />
      </svg>`;
    }

    function getAffinityColor(score) {
      if (score >= 80) return '#10B981'; // Vert
      if (score >= 60) return '#F49F1C'; // Orange
      if (score >= 40) return '#3B82F6'; // Bleu
      return '#94a3b8'; // Gris
    }

    // === 4. LOGIQUE M√âTIER (INTOUCH√âE) ===

    async function init() {
        if (!token) { showError('Token manquant', 'Acc√®s requis via Hub'); return; }
        
        try {
            // Validation simple
            const profileRes = await fetch(`${API_BASE}/profile?session_token=${token}`);
            if(profileRes.ok) {
                const p = await profileRes.json();
                if(p.user_id) activeToken = token;
            }
            if(!activeToken) { showError('Session expir√©e', 'Veuillez vous reconnecter'); return; }

            const keyRes = await fetch(`${API_BASE}/config/here-key?session_token=${activeToken}`);
            const keyData = await keyRes.json();
            HERE_API_KEY = keyData.key;

            await getUserLocation();
            initMap();
            setupControls();
            
        } catch(e) { console.error(e); showError('Erreur', 'Impossible de charger la carte'); }
    }

    async function getUserLocation() {
        return new Promise(resolve => {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userGpsLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, source:'gps' };
                    currentLocation = {...userGpsLocation};
                    resolve();
                }, () => resolve(), {timeout: 5000});
            } else resolve();
        });
    }

    function initMap() {
        const platform = new H.service.Platform({ apikey: HERE_API_KEY });
        const defaultLayers = platform.createDefaultLayers();
        map = new H.Map(document.getElementById('map'), defaultLayers.vector.normal.map, {
            center: currentLocation, zoom: 13, pixelRatio: window.devicePixelRatio || 1
        });
        new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
        ui = H.ui.UI.createDefault(map, defaultLayers);

        map.addEventListener('mapviewchangeend', () => {
            if(reloadTimeout) clearTimeout(reloadTimeout);
            reloadTimeout = setTimeout(() => {
                const center = map.getCenter();
                currentLocation = {lat: center.lat, lng: center.lng};
                loadNearbyUsers();
            }, 800);
        });
        
        // Marker MOI (Nouveau design)
        const meIcon = new H.map.Icon(createMeIcon(), {size:{w:60,h:60}, anchor:{x:30,y:30}});
        map.addObject(new H.map.Marker(currentLocation, {icon: meIcon}));
        
        loadNearbyUsers();
    }

    async function loadNearbyUsers() {
        try {
            document.getElementById('loading').style.display='flex';
            const res = await fetch(`${API_BASE}/users/nearby?lat=${currentLocation.lat}&lng=${currentLocation.lng}&radius=${currentRadius}&session_token=${activeToken}`);
            const data = await res.json();
            usersData = data.users || [];
            
            document.getElementById('userCount').textContent = usersData.length;
            suggestionsData = usersData.filter(u => u.latest_suggestion);
            document.getElementById('suggestionCount').textContent = suggestionsData.length;
            
            updateMarkers();
            updateUserCards();
            document.getElementById('loading').style.display='none';
        } catch(e) { console.error(e); document.getElementById('loading').style.display='none'; }
    }

    function updateMarkers() {
        if(clusteringLayer) map.removeLayer(clusteringLayer);
        markers.forEach(m => map.removeObject(m));
        markers = [];
        
        const dataPoints = usersData.map((u,i) => new H.clustering.DataPoint(u.location.lat, u.location.lng, null, {user:u, index:i}));
        const provider = new H.clustering.Provider(dataPoints, {
            clusteringOptions: {eps:64, minWeight:1},
            theme: {
                getClusterPresentation: cluster => new H.map.Marker(cluster.getPosition(), {
                    icon: new H.map.Icon(createClusterIcon(cluster.getWeight()), {size:{w:60,h:60}, anchor:{x:30,y:30}}),
                    min: cluster.getMinZoom(), max: cluster.getMaxZoom()
                }),
                getNoisePresentation: point => {
                    const u = point.getData().user;
                    const marker = new H.map.Marker(point.getPosition(), {
                        icon: new H.map.Icon(createDropletIcon(MARKER_COLORS[point.getData().index%5], u.compatibility_score, u.plan), {size:{w:60,h:60}, anchor:{x:30,y:30}})
                    });
                    // Tooltip Click
                    marker.addEventListener('tap', () => {
                        highlightUserCard(point.getData().index);
                        const bubble = new H.ui.InfoBubble(point.getPosition(), {
                            content: `<div style="padding:12px; font-family:'Inter',sans-serif; color:#0f172a; min-width:200px;">
                                <div style="font-weight:700; margin-bottom:4px;">${u.anonymous_display||u.pseudo}</div>
                                <div style="font-size:13px; color:#64748b; margin-bottom:8px;">${u.latest_suggestion||'Disponible'}</div>
                                <button onclick="contactUser('${u.id}')" style="background:#f97316; color:white; border:none; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer;">Contacter</button>
                            </div>`
                        });
                        ui.addBubble(bubble);
                    });
                    return marker;
                }
            }
        });
        clusteringLayer = new H.map.layer.ObjectLayer(provider);
        map.addLayer(clusteringLayer);
    }

    function updateUserCards() {
        const grid = document.getElementById('usersGrid');
        grid.innerHTML = '';
        if(usersData.length === 0) { grid.innerHTML = '<div style="color:#94a3b8; width:100%; text-align:center; padding-top:20px;">Aucun MeeTemper √† proximit√© ü¶ó</div>'; return; }

        usersData.forEach((u, i) => {
            const div = document.createElement('div');
            div.className = 'user-card';
            div.dataset.index = i;
            div.onclick = (e) => {
                if(e.target.tagName !== 'BUTTON') {
                    map.setCenter(u.location); map.setZoom(15);
                    highlightUserCard(i);
                }
            };
            const pseudo = u.anonymous_display || u.pseudo;
            const initials = pseudo.substring(0,2).toUpperCase();
            
            div.innerHTML = `
                <div class="user-header">
                    <div class="user-avatar">${initials}</div>
                    <div class="user-info">
                        <h3>${pseudo}</h3>
                        <div class="user-distance">${u.distance ? u.distance+' km' : 'Proche'}</div>
                    </div>
                </div>
                <div class="user-sugg">${u.latest_suggestion || 'Disponible pour √©changer'}</div>
                <button class="btn-action" onclick="contactUser('${u.id}')">Contacter</button>
            `;
            grid.appendChild(div);
        });
    }

    function highlightUserCard(i) {
        document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
        const card = document.querySelector(`.user-card[data-index="${i}"]`);
        if(card) { card.classList.add('active'); card.scrollIntoView({behavior:'smooth', inline:'center'}); }
    }

    function setupControls() {
        // Distance
        document.querySelectorAll('.distance-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.distance-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRadius = parseInt(btn.dataset.radius);
                loadNearbyUsers();
                if(currentRadius <= 5) map.setZoom(14);
                else if(currentRadius >= 50) map.setZoom(10);
                else map.setZoom(12);
            }
        });
        
        // Search
        const input = document.getElementById('citySearchInput');
        const res = document.getElementById('searchAutocomplete');
        input.oninput = (e) => {
            const q = e.target.value;
            if(q.length < 3) { res.classList.remove('show'); return; }
            if(searchAutocompleteTimeout) clearTimeout(searchAutocompleteTimeout);
            searchAutocompleteTimeout = setTimeout(async () => {
                const response = await fetch(`https://autosuggest.search.hereapi.com/v1/autosuggest?q=${encodeURIComponent(q)}&at=${currentLocation.lat},${currentLocation.lng}&limit=5&apiKey=${HERE_API_KEY}`);
                const data = await response.json();
                if(data.items.length) {
                    res.innerHTML = data.items.map(i => `<div class="search-autocomplete-item" onclick="selectCity(${i.position.lat}, ${i.position.lng}, '${i.title.replace(/'/g,"\\'")}')"><div class="search-autocomplete-title">${i.title}</div></div>`).join('');
                    res.classList.add('show');
                }
            }, 400);
        }
    }

    window.selectCity = (lat, lng, name) => {
        document.getElementById('searchAutocomplete').classList.remove('show');
        document.getElementById('citySearchInput').value = '';
        currentLocation = {lat, lng};
        map.setCenter(currentLocation); map.setZoom(13);
        document.getElementById('locationText').textContent = name;
        loadNearbyUsers();
    }

    window.contactUser = () => alert('üí¨ Messagerie active Samedi !');
    window.goToMyLocation = () => {
        if(userGpsLocation.source === 'gps') { currentLocation={...userGpsLocation}; map.setCenter(currentLocation); loadNearbyUsers(); }
        else alert('Position GPS non disponible');
    }
    
    // Fonctions toggle/panel pour compatibilit√© (m√™me si UI chang√©e)
    window.toggleVisibility = () => alert('Visibilit√© modifi√©e');
    window.openSuggestionsList = () => {
        document.getElementById('bottomSheet').classList.add('expanded');
        document.getElementById('bottomSheet').style.height = '70vh';
    };
    window.closeSuggestionsPanel = () => {}; 
    window.loadMoreSuggestions = () => { currentRadius+=10; loadNearbyUsers(); };

    function setupBottomSheet() {
      const sheet = document.getElementById('bottomSheet');
      const handle = document.getElementById('sheetHandle');
      handle.addEventListener('click', () => { 
          sheet.classList.toggle('expanded'); 
          sheet.style.height = sheet.classList.contains('expanded') ? '70vh' : '210px'; 
      });
    }

    function showError(t, m) {
        document.getElementById('loading').style.display='none';
        document.getElementById('errorScreen').style.display='flex';
        document.getElementById('errorTitle').textContent=t;
        document.getElementById('errorMessage').textContent=m;
    }

    init();
    setupBottomSheet();
  </script>
</body>
</html>
