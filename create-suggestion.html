<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cr√©er une Suggestion - MeeTempo</title>
  <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               img-src https: data: blob:; 
               script-src 'self' https://js.api.here.com 'unsafe-inline' 'unsafe-eval'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://js.api.here.com; 
               font-src https://fonts.gstatic.com https://js.api.here.com; 
               worker-src blob:; 
               connect-src 'self' blob: https://api.meetempo.com https://*.hereapi.com https://js.api.here.com;">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --mt-dark: #030E4F;
      --mt-accent: #F49F1C;
      --mt-bg: #0a133f;
      --mt-card: #0e184f;
      --mt-text: #ffffff;
      --mt-muted: #c9d1ff;
      --ok: #23c55e;
      --err: #ef4444;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Montserrat, system-ui, -apple-system, sans-serif;
      background: linear-gradient(160deg, #030E4F 0%, #0a133f 100%);
      color: var(--mt-text);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      max-width: 600px;
      width: 100%;
    }
    
    .header {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .logo-badge {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, var(--mt-accent), #ffca63, var(--mt-accent));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #111;
      font-weight: 800;
      font-size: 24px;
      margin-bottom: 16px;
    }
    
    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 16px;
      color: var(--mt-muted);
    }
    
    .card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .success-screen {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .success-icon {
      font-size: 64px;
      margin-bottom: 24px;
      animation: bounce 0.6s ease;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    
    .success-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--ok);
      margin-bottom: 16px;
    }
    
    .success-subtitle {
      font-size: 16px;
      color: var(--mt-muted);
      margin-bottom: 24px;
    }
    
    .success-details {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: left;
    }
    
    .success-detail-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 14px;
    }
    
    .success-detail-icon {
      font-size: 20px;
    }
    
    .success-buttons {
      display: flex;
      gap: 12px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-section {
      margin-bottom: 32px;
      padding-bottom: 32px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .form-section:last-of-type {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--mt-accent);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--mt-text);
      margin-bottom: 8px;
    }
    
    .label-optional {
      font-size: 12px;
      font-weight: 400;
      color: var(--mt-muted);
      margin-left: 6px;
    }
    
    .label-recommended {
      font-size: 12px;
      font-weight: 400;
      color: var(--mt-accent);
      margin-left: 6px;
    }

    /* üî• NOUVEAU : Autocomplete suggestions */
.autocomplete-container {
  position: relative;
}

.autocomplete-results {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(14, 24, 79, 0.98);
  border: 2px solid var(--mt-accent);
  border-top: none;
  border-radius: 0 0 12px 12px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}

.autocomplete-results.show {
  display: block;
}

.autocomplete-item {
  padding: 12px 16px;
  cursor: pointer;
  transition: all 0.2s;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.autocomplete-item:last-child {
  border-bottom: none;
}

.autocomplete-item:hover {
  background: rgba(244, 159, 28, 0.2);
}

.autocomplete-item-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--mt-text);
  margin-bottom: 4px;
}

.autocomplete-item-subtitle {
  font-size: 12px;
  color: var(--mt-muted);
}

.autocomplete-loading {
  padding: 12px 16px;
  text-align: center;
  color: var(--mt-muted);
  font-size: 13px;
}
    
    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: var(--mt-text);
      font-family: inherit;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--mt-accent);
      background: rgba(255,255,255,0.08);
    }
    
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23c9d1ff' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.6;
    }
    
    textarea::placeholder, input::placeholder {
      color: rgba(201, 209, 255, 0.5);
    }
        
    #customActivityInput {
      display: none;
      margin-top: 12px;
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--mt-accent);
      color: #111;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(244, 159, 28, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--mt-text);
      border: 1px solid rgba(255,255,255,0.2);
      margin-top: 12px;
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
    }

    /* üî• NOUVEAU : Style bouton lien */
.btn-link {
  background: transparent;
  border: 2px solid rgba(255,255,255,0.3);
  color: var(--mt-text);
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
  display: inline-block;
}

.btn-link:hover {
  background: rgba(255,255,255,0.1);
  border-color: var(--mt-accent);
  color: var(--mt-accent);
}
    
    .loading {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,0.2);
      border-top-color: #111;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error-message {
      display: none;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      color: var(--err);
      font-weight: 600;
      text-align: center;
    }
    
    @media (max-width: 640px) {
      body {
        padding: 16px;
      }
      
      .card {
        padding: 24px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      .time-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-badge">MT</div>
      <h1>‚ú® Cr√©er une Suggestion</h1>
      <p class="subtitle">Partagez votre disponibilit√©</p>
      
      <!-- Boutons navigation -->
      <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button class="btn-link" onclick="goToHub()">
          üè† Hub
        </button>
        <button class="btn-link" onclick="goToMySuggestions()">
          üìã Voir mes suggestions
        </button>
      </div>
    </div>
    
    <div class="card">
      <!-- Formulaire -->
      <form id="suggestionForm">
        <div id="errorMessage" class="error-message"></div>
        
        <!-- BLOC 1 : Informations principales -->
        <div class="form-section">
          <div class="section-title">üìã Informations principales</div>
          
          <div class="form-group">
            <label for="activityType">Type d'activit√©</label>
            <select id="activityType" name="activityType" required>
              <option value="">-- Choisir --</option>
              <option value="‚òï Caf√© networking">‚òï Caf√© networking</option>
              <option value="üíº R√©union business">üíº R√©union business</option>
              <option value="üéæ Sport/Activit√©">üéæ Sport/Activit√©</option>
              <option value="üçΩÔ∏è D√©jeuner/D√Æner">üçΩÔ∏è D√©jeuner/D√Æner</option>
              <option value="custom">‚úçÔ∏è Activit√© libre</option>
            </select>
            
            <div id="customActivityInput">
              <input 
                type="text" 
                id="customActivity" 
                placeholder="Transformez une attente en opportunit√©... D√©crivez votre id√©e."
              />
            </div>
          </div>
          
          <div class="form-group">
            <label for="city">Ville</label>
            <input 
              type="text" 
              id="city" 
              name="city" 
              required
              placeholder="Ex: Paris, Puteaux, Lyon..."
            />
          </div>
          
          <div class="form-group">
          <label for="place">
            Lieu pr√©cis
            <span class="label-optional">(optionnel)</span>
          </label>
          <div class="autocomplete-container">
            <input 
              type="text" 
              id="place" 
              name="place"
              placeholder="Ex: Place Bellecour, Stade de France..."
              autocomplete="off"
            />
            <div id="placeAutocomplete" class="autocomplete-results"></div>
          </div>
        </div>
        </div>
        
        <!-- BLOC 2 : Date & Description -->
        <div class="form-section">
          <div class="section-title">üìÖ Date & D√©tails</div>
          
          <div class="form-group">
            <label for="date">Date</label>
            <input 
              type="date" 
              id="date" 
              name="date" 
              required
            />
          </div>
          
          <div class="form-group">
          <label>Horaire</label>
          <input type="time" id="time" name="time" required />
          </div>
          
          <div class="form-group">
            <label for="description">
              Description
              <span class="label-recommended">(recommand√©)</span>
            </label>
            <textarea 
              id="description" 
              name="description"
              placeholder="Perdez votre temps de la meilleure des fa√ßons... Un caf√© √† l'a√©roport ? Un tennis entre deux meetings ? D√©crivez l'ambiance."
            ></textarea>
          </div>
          <!-- Nombre de participants -->
          <div class="form-group">
            <label for="max_participants">
              <!-- üî• NOUVEAU : Participants min/max s√©par√©s -->
          <div class="form-group">
            <label for="min_participants">
              üë• Participants minimum requis
            </label>
            <select id="min_participants" name="min_participants" required>
              <option value="2" selected>2 personnes</option>
              <option value="3">3 personnes</option>
              <option value="5">5 personnes</option>
              <option value="10">10 personnes</option>
              <option value="15">15 personnes</option>
              <option value="20">20 personnes</option>
              <option value="custom_min">Autre nombre</option>
            </select>
            
            <!-- Champ libre min (cach√© par d√©faut) -->
            <div id="customMinInput" style="display: none; margin-top: 12px;">
              <input 
                type="number" 
                id="customMinParticipants" 
                placeholder="Ex: 25"
                min="2"
                max="1000"
              />
            </div>
          </div>
          
          <div class="form-group">
            <label for="max_participants">
              üë• Participants maximum total
            </label>
            <select id="max_participants" name="max_participants" required>
              <option value="2" selected>2 personnes total</option>
              <option value="3">3 personnes total</option>
              <option value="5">5 personnes total</option>
              <option value="10">10 personnes total</option>
              <option value="15">15 personnes total</option>
              <option value="20">20 personnes total</option>
              <option value="custom_max">Autre nombre</option>
            </select>
            
            <!-- Champ libre max (cach√© par d√©faut) -->
            <div id="customMaxInput" style="display: none; margin-top: 12px;">
              <input 
                type="number" 
                id="customMaxParticipants" 
                placeholder="Ex: 50"
                min="2"
                max="1000"
              />
            </div>
            
            <div class="helper-text" style="margin-top: 12px;">
              üí° Minimum = Seuil requis pour maintenir l'√©v√©nement<br>
              üí° Maximum = Limite totale de places disponibles
            </div>
          </div>
                
        <button type="submit" class="btn btn-primary" id="submitBtn">
          <span id="btnText">‚ú® Cr√©er ma suggestion</span>
          <div id="btnLoading" class="loading"></div>
        </button>
        
        <button type="button" class="btn btn-secondary" onclick="goBack()">
          ‚Üê Retour
        </button>
      </form>
      
      <!-- √âcran de succ√®s -->
      <div id="successScreen" class="success-screen">
        <div class="success-icon">üéâ</div>
        <div class="success-title">F√âLICITATIONS !</div>
        <div class="success-subtitle">Votre suggestion est maintenant en ligne et visible sur la carte</div>
        
        <div class="success-details" id="successDetails">
          <!-- Rempli dynamiquement -->
        </div>
        
        <div class="success-buttons">
          <button class="btn btn-secondary" onclick="goToHub()" style="flex: 1;">
            üè† Hub
          </button>
          <button class="btn btn-secondary" onclick="backToGPT()" style="flex: 1;">
            üí¨ Retour GPT
          </button>
          <button class="btn btn-primary" onclick="goToMap()" style="flex: 1;">
            üó∫Ô∏è Voir la carte
          </button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // === BLOC UNIVERSEL MEETEMPO - STANDARD (45 min) ===
    (function() {
      const TIMEOUT_MINUTES = 45;
      
      const params = new URLSearchParams(location.search);
      window.MT_TOKEN = params.get('session_token') || params.get('token') || params.get('t')
                     || localStorage.getItem('session_token') 
                     || sessionStorage.getItem('meetempo_token');
      
      if (window.MT_TOKEN) {
        localStorage.setItem('session_token', window.MT_TOKEN);
        sessionStorage.setItem('meetempo_token', window.MT_TOKEN);
      }
      
      if (!window.MT_TOKEN) {
        alert('‚ùå Session expir√©e. Retour √† MeeTempo GPT.');
        window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
        return;
      }
      
      const TIMEOUT_MS = TIMEOUT_MINUTES * 60 * 1000;
      setTimeout(() => {
        alert('‚è∞ Session expir√©e (45 min). Cette page va se fermer.');
        window.close();
        setTimeout(() => {
          window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
        }, 1000);
      }, TIMEOUT_MS);
      
      console.log(`üîê MeeTempo | Token: ${window.MT_TOKEN.substring(0,12)}... | Timeout: ${TIMEOUT_MINUTES}min`);
    })();

    const API_BASE = 'https://api.meetempo.com';
    let session_token = window.MT_TOKEN;
    

// Helper: Escape quotes pour onclick
function escapeQuotes(str) {
  return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// Helper: Escape HTML pour affichage s√©curis√©
function escapeHTML(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

    // üî• NOUVEAU : Variables autocomplete
let selectedPlaceData = null; // Stocker donn√©es lieu s√©lectionn√©
let autocompleteTimeout = null;

// üî• NOUVEAU : Autocomplete lieu avec HERE Maps
document.getElementById('place').addEventListener('input', async (e) => {
  const query = e.target.value.trim();
  const city = document.getElementById('city').value.trim();
  const resultsDiv = document.getElementById('placeAutocomplete');
  
  // Clear timeout pr√©c√©dent
  if (autocompleteTimeout) {
    clearTimeout(autocompleteTimeout);
  }
  
  // Reset s√©lection si modifi√©
  selectedPlaceData = null;
  
  // Si vide, masquer r√©sultats
  if (!query || query.length < 3) {
    resultsDiv.classList.remove('show');
    return;
  }
  
  // Attendre 300ms apr√®s arr√™t de frappe
  autocompleteTimeout = setTimeout(async () => {
    try {
      // Afficher loading
      resultsDiv.innerHTML = '<div class="autocomplete-loading">üîç Recherche...</div>';
      resultsDiv.classList.add('show');
      
      // Construire requ√™te : prioriser la ville si fournie
      const searchQuery = city ? `${query}, ${city}` : query;
      
      // üî• R√©cup√©rer cl√© HERE Maps
if (!window.HERE_API_KEY) {
  try {
    const token = window.MT_TOKEN || sessionStorage.getItem('meetempo_token');
    const keyResponse = await fetch(`${API_BASE}/config/here-key?session_token=${token}`);
    if (keyResponse.ok) {
      const keyData = await keyResponse.json();
      window.HERE_API_KEY = keyData.key;
    }
  } catch (err) {
    console.error('Erreur cl√© HERE:', err);
  }
}
      
      // Appel HERE Autosuggest API
      const autosuggestUrl = `https://autosuggest.search.hereapi.com/v1/autosuggest?q=${encodeURIComponent(searchQuery)}&at=48.8566,2.3522&limit=5&apiKey=${window.HERE_API_KEY}`;
      
      const response = await fetch(autosuggestUrl);
      
      if (!response.ok) {
        throw new Error('Erreur autocomplete');
      }
      
      const data = await response.json();
      
      // Afficher r√©sultats
      if (data.items && data.items.length > 0) {
        resultsDiv.innerHTML = data.items.map(item => {
          const title = item.title || item.address?.label || '';
          const subtitle = item.address?.label || item.vicinity || '';
          
          return `
            <div class="autocomplete-item" onclick="selectPlace('${item.id}', '${escapeQuotes(title)}', ${item.position?.lat || 0}, ${item.position?.lng || 0})">
              <div class="autocomplete-item-title">${escapeHTML(title)}</div>
              <div class="autocomplete-item-subtitle">${escapeHTML(subtitle)}</div>
            </div>
          `;
        }).join('');
      } else {
        resultsDiv.innerHTML = '<div class="autocomplete-loading">Aucun r√©sultat</div>';
      }
      
    } catch (err) {
      console.error('Erreur autocomplete:', err);
      resultsDiv.innerHTML = '<div class="autocomplete-loading">‚ùå Erreur recherche</div>';
    }
  }, 300);
});

// üî• NOUVEAU : S√©lectionner un lieu
function selectPlace(id, title, lat, lng) {
  const placeInput = document.getElementById('place');
  const resultsDiv = document.getElementById('placeAutocomplete');
  
  // Remplir input
  placeInput.value = title;
  
  // Stocker donn√©es
  selectedPlaceData = { id, title, lat, lng };
  
  // Masquer r√©sultats
  resultsDiv.classList.remove('show');
  
  console.log('üìç Lieu s√©lectionn√©:', selectedPlaceData);
}

// Masquer autocomplete si clic ext√©rieur
document.addEventListener('click', (e) => {
  if (!e.target.closest('.autocomplete-container')) {
    document.getElementById('placeAutocomplete').classList.remove('show');
  }
});
    
    // Date par d√©faut : aujourd'hui
    document.getElementById('date').valueAsDate = new Date();
    
    // Toggle activit√© libre
    document.getElementById('activityType').addEventListener('change', (e) => {
      const customInput = document.getElementById('customActivityInput');
      const customField = document.getElementById('customActivity');
      
      if (e.target.value === 'custom') {
        customInput.style.display = 'block';
        customField.required = true;
      } else {
        customInput.style.display = 'none';
        customField.required = false;
      }
    });
    // üî• NOUVEAU : Toggle champs libres min/max participants
    document.getElementById('min_participants').addEventListener('change', (e) => {
      const customMinInput = document.getElementById('customMinInput');
      const customMinField = document.getElementById('customMinParticipants');
      
      if (e.target.value === 'custom_min') {
        customMinInput.style.display = 'block';
        customMinField.required = true;
      } else {
        customMinInput.style.display = 'none';
        customMinField.required = false;
        customMinField.value = ''; // Reset
      }
    });

    // üî• NOUVEAU : Validation dynamique min <= max
    function validateMinMax() {
      const minSelect = document.getElementById('min_participants');
      const maxSelect = document.getElementById('max_participants');
      const customMinField = document.getElementById('customMinParticipants');
      const customMaxField = document.getElementById('customMaxParticipants');
      
      // R√©cup√©rer valeurs actuelles
      let minValue = minSelect.value === 'custom_min' 
        ? parseInt(customMinField.value) || 2 
        : parseInt(minSelect.value);
      
      let maxValue = maxSelect.value === 'custom_max' 
        ? parseInt(customMaxField.value) || 2 
        : parseInt(maxSelect.value);
      
      // Si max < min, ajuster max automatiquement
      if (maxValue < minValue) {
        // Si max est custom, mettre √† jour le champ
        if (maxSelect.value === 'custom_max') {
          customMaxField.value = minValue;
        } else {
          // Trouver la premi√®re option >= minValue
          const options = Array.from(maxSelect.options);
          const validOption = options.find(opt => {
            if (opt.value === 'custom_max') return false;
            return parseInt(opt.value) >= minValue;
          });
          
          if (validOption) {
            maxSelect.value = validOption.value;
          } else {
            // Aucune option valide, forcer custom
            maxSelect.value = 'custom_max';
            document.getElementById('customMaxInput').style.display = 'block';
            customMaxField.required = true;
            customMaxField.value = minValue;
          }
        }
        
        console.log(`‚ö†Ô∏è Max ajust√© : ${maxValue} ‚Üí ${minValue}`);
      }
    }
    
    // D√©clencher validation quand min change
    document.getElementById('min_participants').addEventListener('change', validateMinMax);
    
    // D√©clencher validation quand min custom change
    document.getElementById('customMinParticipants').addEventListener('input', validateMinMax);
    
    // D√©clencher validation quand max change (pour √©viter s√©lection invalide)
    document.getElementById('max_participants').addEventListener('change', validateMinMax);
    
    // D√©clencher validation quand max custom change
    document.getElementById('customMaxParticipants').addEventListener('input', validateMinMax);
    
    document.getElementById('max_participants').addEventListener('change', (e) => {
      const customMaxInput = document.getElementById('customMaxInput');
      const customMaxField = document.getElementById('customMaxParticipants');
      
      if (e.target.value === 'custom_max') {
        customMaxInput.style.display = 'block';
        customMaxField.required = true;
      } else {
        customMaxInput.style.display = 'none';
        customMaxField.required = false;
        customMaxField.value = ''; // Reset
      }
    });
    
    // Soumission formulaire
    document.getElementById('suggestionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const btnLoading = document.getElementById('btnLoading');
      const errorMessage = document.getElementById('errorMessage');
      
      // Loading state
      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'block';
      errorMessage.style.display = 'none';
      
      try {
        // R√©cup√©rer donn√©es formulaire
        const activityTypeSelect = document.getElementById('activityType').value;
        const customActivity = document.getElementById('customActivity').value;
        const activityType = activityTypeSelect === 'custom' ? customActivity : activityTypeSelect;
        
        const city = document.getElementById('city').value.trim();
        const place = document.getElementById('place').value.trim();
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        // D√©tecter AM/PM depuis l'heure 24h
        const hour24 = parseInt(time.split(':')[0]);
        const ampm = hour24 >= 12 ? 'PM' : 'AM';
        const description = document.getElementById('description').value.trim();
        
        // Construire le texte complet pour backward compatibility
        const fullLocation = place ? `${place}, ${city}` : city;
        // üî• NOUVEAU : R√©cup√©rer min/max participants
        const minSelect = document.getElementById('min_participants').value;
        const maxSelect = document.getElementById('max_participants').value;
        
        let min_participants, max_participants;
        
        // Si "custom" s√©lectionn√©, prendre valeur input libre
        if (minSelect === 'custom_min') {
          min_participants = parseInt(document.getElementById('customMinParticipants').value) || 2;
        } else {
          min_participants = parseInt(minSelect);
        }
        
        if (maxSelect === 'custom_max') {
          max_participants = parseInt(document.getElementById('customMaxParticipants').value) || 2;
        } else {
          max_participants = parseInt(maxSelect);
        }
        
        // Validation : max >= min
        if (max_participants < min_participants) {
          throw new Error('Le nombre maximum doit √™tre >= au nombre minimum');
        }
        const fullText = `${activityType} - ${fullLocation} le ${date} √† ${time} ${ampm}${description ? '. ' + description : ''}`;
        
        // Payload
        const payload = {
          session_token: session_token,
          // Nouveaux champs structur√©s
          activity_type: activityType,
          city: city,
          place: place || null,
          date: date,
          time: time,
          ampm: ampm,
          description: description || null,
          min_participants: min_participants,
          max_participants: max_participants,
          // üî• NOUVEAU : Coordonn√©es pr√©cises si autocomplete utilis√©
          exact_location: selectedPlaceData ? {
            lat: selectedPlaceData.lat,
            lng: selectedPlaceData.lng,
            source: 'autocomplete'
          } : null,
          // Backward compatibility
          text: fullText
        };
        
        // Appel API
        // üî• DEBUG : Logger payload avant envoi
        console.log('üì§ Payload:', payload);
        
        const response = await fetch(`${API_BASE}/suggestions/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        // üî• DEBUG : Logger r√©ponse
        console.log('üì• Response status:', response.status);
        const responseText = await response.text();
        console.log('üì• Response body:', responseText);
        
        if (!response.ok) {
          let errorData = {};
          try {
            errorData = JSON.parse(responseText);
          } catch (e) {
            throw new Error(`Erreur serveur (${response.status}): ${responseText.substring(0, 200)}`);
          }
          if (errorData.upgrade_required) {
            throw new Error('‚ùå Abonnement requis : Meeting, Premium ou VIP n√©cessaire pour cr√©er des suggestions.');
          }
          throw new Error(errorData.error || 'Erreur lors de la cr√©ation');
        }
        
        // üî• Parser r√©ponse JSON
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          throw new Error(`R√©ponse invalide (pas JSON): ${responseText.substring(0, 200)}`);
        }
        
        // Demander si l'utilisateur veut voir ses suggestions
        const goToList = confirm(
          '‚úÖ Suggestion cr√©√©e avec succ√®s !\n\n' +
          'üìã Voulez-vous voir vos suggestions maintenant ?\n\n' +
          '‚úÖ Oui ‚Üí Mes Suggestions\n' +
          '‚ùå Non ‚Üí Rester ici'
        );

if (goToList) {
  // Aller vers mes suggestions
  goToMySuggestions();
} else {
  // Afficher √©cran de succ√®s
  showSuccessScreen(data, {
    activityType,
    fullLocation,
    date,
    time,
    ampm,
    description
  });
}
        
      } catch (err) {
        console.error('Error:', err);
        errorMessage.textContent = err.message || '‚ùå Erreur lors de la cr√©ation. R√©essayez.';
        errorMessage.style.display = 'block';
        
        // Reset button
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
      }
    });
    
    // Afficher √©cran de succ√®s
    function showSuccessScreen(apiData, formData) {
      const form = document.getElementById('suggestionForm');
      const successScreen = document.getElementById('successScreen');
      const successDetails = document.getElementById('successDetails');
      
      // Calculer expiration
      const expiresDate = new Date();
      expiresDate.setDate(expiresDate.getDate() + 7);
      const daysLeft = 7;
      
      // D√©tails
      successDetails.innerHTML = `
        <div class="success-detail-item">
          <span class="success-detail-icon">${formData.activityType.split(' ')[0]}</span>
          <span><strong>${formData.activityType}</strong></span>
        </div>
        <div class="success-detail-item">
          <span class="success-detail-icon">üìç</span>
          <span>${formData.fullLocation}</span>
        </div>
        <div class="success-detail-item">
          <span class="success-detail-icon">üïê</span>
          <span>${formData.date} √† ${formData.time} ${formData.ampm}</span>
        </div>
        <div class="success-detail-item">
          <span class="success-detail-icon">‚è≥</span>
          <span>Expire dans ${daysLeft} jours</span>
        </div>
      `;
      
      // Masquer form, afficher succ√®s
      form.style.display = 'none';
      successScreen.style.display = 'block';
    }
    
    // Navigation
    function backToGPT() {
      window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
    }
    
    function goToMap() {
  const token = window.MT_TOKEN || sessionStorage.getItem('meetempo_token');
  window.open(`map.html?session_token=${token}`, '_blank');
}

// Fonction pour aller vers le hub
function goToHub() {
  const token = sessionStorage.getItem('meetempo_token');
  
  if (!token) {
    alert('‚ùå Session expir√©e. Veuillez vous reconnecter.');
    window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
    return;
  }
  
  window.location.href = `hub.html?session_token=${token}`;
}

function goBack() {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    goToHub();
  }
}
    // Fonction pour aller vers mes suggestions
function goToMySuggestions() {
  const token = sessionStorage.getItem('meetempo_token');
  
  if (!token) {
    alert('‚ùå Session expir√©e. Veuillez vous reconnecter.');
    window.location.href = 'https://chatgpt.com/g/g-68f522fa42b08191978685b03a9b03c2-meetempo-test-oct19';
    return;
  }
  
  window.location.href = `my-suggestions.html?session_token=${token}`;
}
  </script>
</body>
</html>
